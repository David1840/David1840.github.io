<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Programmer Liu</title>
  
  <subtitle>精彩生活，不惧挑战，做一只有理想的的程序猿</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-04-28T09:20:58.129Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>刘伟</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Android系统-installd守护进程</title>
    <link href="http://yoursite.com/2021/04/27/Android%E7%B3%BB%E7%BB%9F-installd%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/"/>
    <id>http://yoursite.com/2021/04/27/Android系统-installd守护进程/</id>
    <published>2021-04-27T10:48:39.000Z</published>
    <updated>2021-04-28T09:20:58.129Z</updated>
    
    <content type="html"><![CDATA[<p>从前面<a href="">Android包管理机制(三)PMS处理APK安装</a>中可以了解到PMS在安装APK的时候调用了Installer的函数，而Installer实际是调用了installd中的方法。今天我们就来了解下守护进程installd，看看它做了什么，以及为什么需要有一个守护进程？</p><h2 id="installd启动"><a href="#installd启动" class="headerlink" title="installd启动"></a>installd启动</h2><p><code>frameworks/native/cmds/installd/installd.rc</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service installd /system/bin/installd</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">installd</span> <span class="title">stream</span> 600 <span class="title">system</span> <span class="title">system</span></span></span><br></pre></td></tr></table></figure><p>installd将作为service被init进程启动，同时会创建一个名为installd的socket</p><p><code>frameworks/native/cmds/installd/installd.cpp</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> android::installd::installd_main(argc, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">installd_main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> argc ATTRIBUTE_UNUSED, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFFER_MAX];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="keyword">socklen_t</span> alen;</span><br><span class="line">    <span class="keyword">int</span> lsocket, s;</span><br><span class="line">    <span class="keyword">int</span> selinux_enabled = (is_selinux_enabled() &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    setenv(<span class="string">"ANDROID_LOG_TAGS"</span>, <span class="string">"*:v"</span>, <span class="number">1</span>);</span><br><span class="line">    android::base::InitLogging(argv);</span><br><span class="line"></span><br><span class="line">    ALOGI(<span class="string">"installd firing up\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> selinux_callback cb;</span><br><span class="line">    cb.func_log = log_callback;</span><br><span class="line">    selinux_set_callback(SELINUX_CB_LOG, cb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!initialize_globals()) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not initialize globals; exiting.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (initialize_directories() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not create directories; exiting.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selinux_enabled &amp;&amp; selinux_status_open(<span class="literal">true</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Could not open selinux status; exiting.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到"installd" socket</span></span><br><span class="line">    lsocket = android_get_control_socket(SOCKET_PATH);</span><br><span class="line">    <span class="keyword">if</span> (lsocket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to get socket from environment: %s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//socket监听</span></span><br><span class="line">    <span class="keyword">if</span> (listen(lsocket, <span class="number">5</span>)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Listen on socket failed: %s\n"</span>, strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fcntl(lsocket, F_SETFD, FD_CLOEXEC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        alen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">        <span class="comment">// 接收信息</span></span><br><span class="line">        s = accept(lsocket, &amp;addr, &amp;alen);</span><br><span class="line">        <span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"Accept failed: %s\n"</span>, strerror(errno));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fcntl(s, F_SETFD, FD_CLOEXEC);</span><br><span class="line"></span><br><span class="line">        ALOGI(<span class="string">"new connection\n"</span>);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">short</span> count;</span><br><span class="line">            <span class="keyword">if</span> (readx(s, &amp;count, <span class="keyword">sizeof</span>(count))) &#123;</span><br><span class="line">                ALOGE(<span class="string">"failed to read size\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((count &lt; <span class="number">1</span>) || (count &gt;= BUFFER_MAX)) &#123;</span><br><span class="line">                ALOGE(<span class="string">"invalid size %d\n"</span>, count);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (readx(s, buf, count)) &#123;</span><br><span class="line">                ALOGE(<span class="string">"failed to read command\n"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buf[count] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (selinux_enabled &amp;&amp; selinux_status_updated() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                selinux_android_seapp_context_reload();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//执行命令</span></span><br><span class="line">            <span class="keyword">if</span> (execute(s, buf)) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ALOGI(<span class="string">"closing connection\n"</span>);</span><br><span class="line">        close(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码也比较简单，启动后获取installd socket，监听连接，获取客户端发送的命令并执行。</p><h2 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">execute</span><span class="params">(<span class="keyword">int</span> s, <span class="keyword">char</span> cmd[BUFFER_MAX])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> reply[REPLY_MAX];</span><br><span class="line">    <span class="keyword">char</span> *arg[TOKEN_MAX+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> count;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* default reply is "" */</span></span><br><span class="line">    reply[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* n is number of args (not counting arg[0]) */</span></span><br><span class="line">    arg[<span class="number">0</span>] = cmd;</span><br><span class="line">    <span class="comment">//解析参数的个数</span></span><br><span class="line">    <span class="keyword">while</span> (*cmd) &#123;</span><br><span class="line">         <span class="comment">//当发现空格时</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isspace</span>(*cmd)) &#123;</span><br><span class="line">            *cmd++ = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//参数个数+1</span></span><br><span class="line">            n++;</span><br><span class="line">            <span class="comment">//保存参数</span></span><br><span class="line">            arg[n] = cmd;</span><br><span class="line">            <span class="keyword">if</span> (n == TOKEN_MAX) &#123;</span><br><span class="line">                ALOGE(<span class="string">"too many arguments\n"</span>);</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*cmd) &#123;</span><br><span class="line">          cmd++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cmds是一个数组，保存了所有可以执行的操作</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cmds) / <span class="keyword">sizeof</span>(cmds[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(cmds[i].name,arg[<span class="number">0</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n != cmds[i].numargs) &#123;</span><br><span class="line">                ALOGE(<span class="string">"%s requires %d arguments (%d given)\n"</span>,</span><br><span class="line">                     cmds[i].name, cmds[i].numargs, n);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//参数正确时，调用对应的执行函数进行处理</span></span><br><span class="line">                ret = cmds[i].func(arg + <span class="number">1</span>, reply);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGE(<span class="string">"unsupported command '%s'\n"</span>, arg[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>execute就是在接收到命令后在cmds中查找对应的指令，然后执行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmdinfo</span> <span class="title">cmds</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">"ping"</span>,                 <span class="number">0</span>, do_ping &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"create_app_data"</span>,      <span class="number">7</span>, do_create_app_data &#125;,</span><br><span class="line">    &#123; <span class="string">"restorecon_app_data"</span>,  <span class="number">6</span>, do_restorecon_app_data &#125;,</span><br><span class="line">    &#123; <span class="string">"migrate_app_data"</span>,     <span class="number">4</span>, do_migrate_app_data &#125;,</span><br><span class="line">    &#123; <span class="string">"clear_app_data"</span>,       <span class="number">5</span>, do_clear_app_data &#125;,</span><br><span class="line">    &#123; <span class="string">"destroy_app_data"</span>,     <span class="number">5</span>, do_destroy_app_data &#125;,</span><br><span class="line">    &#123; <span class="string">"move_complete_app"</span>,    <span class="number">7</span>, do_move_complete_app &#125;,</span><br><span class="line">    &#123; <span class="string">"get_app_size"</span>,         <span class="number">6</span>, do_get_app_size &#125;,</span><br><span class="line">    &#123; <span class="string">"get_app_data_inode"</span>,   <span class="number">4</span>, do_get_app_data_inode &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"create_user_data"</span>,     <span class="number">4</span>, do_create_user_data &#125;,</span><br><span class="line">    &#123; <span class="string">"destroy_user_data"</span>,    <span class="number">3</span>, do_destroy_user_data &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"dexopt"</span>,              <span class="number">10</span>, do_dexopt &#125;,</span><br><span class="line">    &#123; <span class="string">"markbootcomplete"</span>,     <span class="number">1</span>, do_mark_boot_complete &#125;,</span><br><span class="line">    &#123; <span class="string">"rmdex"</span>,                <span class="number">2</span>, do_rm_dex &#125;,</span><br><span class="line">    &#123; <span class="string">"freecache"</span>,            <span class="number">2</span>, do_free_cache &#125;,</span><br><span class="line">    &#123; <span class="string">"linklib"</span>,              <span class="number">4</span>, do_linklib &#125;,</span><br><span class="line">    &#123; <span class="string">"idmap"</span>,                <span class="number">3</span>, do_idmap &#125;,</span><br><span class="line">    &#123; <span class="string">"createoatdir"</span>,         <span class="number">2</span>, do_create_oat_dir &#125;,</span><br><span class="line">    &#123; <span class="string">"rmpackagedir"</span>,         <span class="number">1</span>, do_rm_package_dir &#125;,</span><br><span class="line">    &#123; <span class="string">"clear_app_profiles"</span>,   <span class="number">1</span>, do_clear_app_profiles &#125;,</span><br><span class="line">    &#123; <span class="string">"destroy_app_profiles"</span>, <span class="number">1</span>, do_destroy_app_profiles &#125;,</span><br><span class="line">    &#123; <span class="string">"linkfile"</span>,             <span class="number">3</span>, do_link_file &#125;,</span><br><span class="line">    &#123; <span class="string">"move_ab"</span>,              <span class="number">3</span>, do_move_ab &#125;,</span><br><span class="line">    &#123; <span class="string">"merge_profiles"</span>,       <span class="number">2</span>, do_merge_profiles &#125;,</span><br><span class="line">    &#123; <span class="string">"dump_profiles"</span>,        <span class="number">3</span>, do_dump_profiles &#125;,</span><br><span class="line">    &#123; <span class="string">"delete_odex"</span>,          <span class="number">3</span>, do_delete_odex &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个就是cmds数组，第一列是指令名称，第二列是要求的参数个数，第三列是指令对应的执行函数。</p><p>以create_app_data为例</p><p><code>frameworks/native/cmds/installd/installd.cpp</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_create_app_data</span><span class="params">(<span class="keyword">char</span> **arg, <span class="keyword">char</span> reply[REPLY_MAX] ATTRIBUTE_UNUSED)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* const char *uuid, const char *pkgname, userid_t userid, int flags,</span></span><br><span class="line"><span class="comment">            appid_t appid, const char* seinfo, int target_sdk_version */</span></span><br><span class="line">    <span class="keyword">return</span> create_app_data(parse_null(arg[<span class="number">0</span>]), arg[<span class="number">1</span>], atoi(arg[<span class="number">2</span>]), atoi(arg[<span class="number">3</span>]),</span><br><span class="line">                           atoi(arg[<span class="number">4</span>]), arg[<span class="number">5</span>], atoi(arg[<span class="number">6</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>frameworks/native/cmds/installd/commands.cpp</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_app_data</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *uuid, <span class="keyword">const</span> <span class="keyword">char</span> *pkgname, <span class="keyword">userid_t</span> userid, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">appid_t</span> appid, <span class="keyword">const</span> <span class="keyword">char</span>* seinfo, <span class="keyword">int</span> target_sdk_version)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uid_t</span> uid = multiuser_get_uid(userid, appid);</span><br><span class="line">    <span class="keyword">mode_t</span> target_mode = target_sdk_version &gt;= MIN_RESTRICTED_HOME_SDK_VERSION ? <span class="number">0700</span> : <span class="number">0751</span>;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; FLAG_STORAGE_CE) &#123;</span><br><span class="line">        <span class="keyword">auto</span> path = create_data_user_ce_package_path(uuid, userid, pkgname);</span><br><span class="line">        <span class="keyword">if</span> (prepare_app_dir(path, target_mode, uid) ||</span><br><span class="line">                prepare_app_dir(path, <span class="string">"cache"</span>, <span class="number">0771</span>, uid) ||</span><br><span class="line">                prepare_app_dir(path, <span class="string">"code_cache"</span>, <span class="number">0771</span>, uid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Consider restorecon over contents if label changed</span></span><br><span class="line">        <span class="keyword">if</span> (restorecon_app_data_lazy(path, seinfo, uid) ||</span><br><span class="line">                restorecon_app_data_lazy(path, <span class="string">"cache"</span>, seinfo, uid) ||</span><br><span class="line">                restorecon_app_data_lazy(path, <span class="string">"code_cache"</span>, seinfo, uid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remember inode numbers of cache directories so that we can clear</span></span><br><span class="line">        <span class="comment">// contents while CE storage is locked</span></span><br><span class="line">        <span class="keyword">if</span> (write_path_inode(path, <span class="string">"cache"</span>, kXattrInodeCache) ||</span><br><span class="line">                write_path_inode(path, <span class="string">"code_cache"</span>, kXattrInodeCodeCache)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; FLAG_STORAGE_DE) &#123;</span><br><span class="line">        <span class="keyword">auto</span> path = create_data_user_de_package_path(uuid, userid, pkgname);</span><br><span class="line">        <span class="keyword">if</span> (prepare_app_dir(path, target_mode, uid)) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> include result once 25796509 is fixed</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Consider restorecon over contents if label changed</span></span><br><span class="line">        <span class="keyword">if</span> (restorecon_app_data_lazy(path, seinfo, uid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (property_get_bool(<span class="string">"dalvik.vm.usejitprofiles"</span>)) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> profile_path = create_data_user_profile_package_path(userid, pkgname);</span><br><span class="line">            <span class="comment">// read-write-execute only for the app user.</span></span><br><span class="line">            <span class="keyword">if</span> (fs_prepare_dir_strict(profile_path.c_str(), <span class="number">0700</span>, uid, uid) != <span class="number">0</span>) &#123;</span><br><span class="line">                PLOG(ERROR) &lt;&lt; <span class="string">"Failed to prepare "</span> &lt;&lt; profile_path;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> profile_file = create_primary_profile(profile_path);</span><br><span class="line">            <span class="comment">// read-write only for the app user.</span></span><br><span class="line">            <span class="keyword">if</span> (fs_prepare_file_strict(profile_file.c_str(), <span class="number">0600</span>, uid, uid) != <span class="number">0</span>) &#123;</span><br><span class="line">                PLOG(ERROR) &lt;&lt; <span class="string">"Failed to prepare "</span> &lt;&lt; profile_path;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> ref_profile_path = create_data_ref_profile_package_path(pkgname);</span><br><span class="line">            <span class="comment">// dex2oat/profman runs under the shared app gid and it needs to read/write reference</span></span><br><span class="line">            <span class="comment">// profiles.</span></span><br><span class="line">            <span class="keyword">appid_t</span> shared_app_gid = multiuser_get_shared_app_gid(uid);</span><br><span class="line">            <span class="keyword">if</span> (fs_prepare_dir_strict(</span><br><span class="line">                    ref_profile_path.c_str(), <span class="number">0700</span>, shared_app_gid, shared_app_gid) != <span class="number">0</span>) &#123;</span><br><span class="line">                PLOG(ERROR) &lt;&lt; <span class="string">"Failed to prepare "</span> &lt;&lt; ref_profile_path;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建cache和code_cache文件夹，并授予相应的权限。</p><h2 id="Installer服务"><a href="#Installer服务" class="headerlink" title="Installer服务"></a>Installer服务</h2><p>installd在Framework中对应的是Installer服务。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/Installer.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Installer</span> <span class="keyword">extends</span> <span class="title">SystemService</span></span></span><br></pre></td></tr></table></figure><p>它是一个SystemService，在系统启动的时候作为核心服务在SystemServer中启动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">//启动installer服务</span></span><br><span class="line">       Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">       ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Install中部分代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Installer</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    mInstaller = <span class="keyword">new</span> InstallerConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Package-private installer that accepts a custom InstallerConnection. Used for</span></span><br><span class="line"><span class="comment">// OtaDexoptService.</span></span><br><span class="line">Installer(Context context, InstallerConnection connection) &#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    mInstaller = connection;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Yell loudly if someone tries making future calls while holding a lock on</span></span><br><span class="line"><span class="comment"> * the given object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWarnIfHeld</span><span class="params">(Object warnIfHeld)</span> </span>&#123;</span><br><span class="line">    mInstaller.setWarnIfHeld(warnIfHeld);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Waiting for installd to be ready."</span>);</span><br><span class="line">    mInstaller.waitForConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createAppData</span><span class="params">(String uuid, String pkgname, <span class="keyword">int</span> userid, <span class="keyword">int</span> flags, <span class="keyword">int</span> appid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String seinfo, <span class="keyword">int</span> targetSdkVersion)</span> <span class="keyword">throws</span> InstallerException </span>&#123;</span><br><span class="line">    mInstaller.execute(<span class="string">"create_app_data"</span>, uuid, pkgname, userid, flags, appid, seinfo,</span><br><span class="line">        targetSdkVersion);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，Installer在被创建的时候InstallerConnection也被创建了一个实例，createAppData实际调用也是InstallerConnection中的execute方法。所以Installer服务实际是使用InstallerConnection在做具体操作。</p><p><code>frameworks/base/core/java/com/android/internal/os/InstallerConnection.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallerConnection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">transact</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mWarnIfHeld != <span class="keyword">null</span> &amp;&amp; Thread.holdsLock(mWarnIfHeld)) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Calling thread "</span> + Thread.currentThread().getName() + <span class="string">" is holding 0x"</span></span><br><span class="line">                    + Integer.toHexString(System.identityHashCode(mWarnIfHeld)), <span class="keyword">new</span> Throwable());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!connect()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"connection failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"-1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!writeCommand(cmd)) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"write command failed? reconnect!"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!connect() || !writeCommand(cmd)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"-1"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] execute(String cmd, Object... args) <span class="keyword">throws</span> InstallerException &#123;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">final</span> String[] resRaw = transact(builder.toString()).split(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">int</span> res = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            res = Integer.parseInt(resRaw[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException | NumberFormatException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> resRaw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dexopt</span><span class="params">(String apkPath, <span class="keyword">int</span> uid, String instructionSet, <span class="keyword">int</span> dexoptNeeded,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> dexFlags, String compilerFilter, String volumeUuid, String sharedLibraries)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InstallerException </span>&#123;</span><br><span class="line">        dexopt(apkPath, uid, <span class="string">"*"</span>, instructionSet, dexoptNeeded, <span class="keyword">null</span> <span class="comment">/*outputPath*/</span>, dexFlags,</span><br><span class="line">                compilerFilter, volumeUuid, sharedLibraries);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dexopt</span><span class="params">(String apkPath, <span class="keyword">int</span> uid, String pkgName, String instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> dexoptNeeded, String outputPath, <span class="keyword">int</span> dexFlags, String compilerFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">            String volumeUuid, String sharedLibraries)</span> <span class="keyword">throws</span> InstallerException </span>&#123;</span><br><span class="line"> execute(<span class="string">"dexopt"</span>,apkPath,uid,pkgName,instructionSet,dexoptNeeded,outputPath,dexFlags,compilerFilter,volumeUuid,sharedLibraries);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mSocket != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.i(TAG, <span class="string">"connecting..."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSocket = <span class="keyword">new</span> LocalSocket();</span><br><span class="line"></span><br><span class="line">            LocalSocketAddress address = <span class="keyword">new</span> LocalSocketAddress(<span class="string">"installd"</span>,</span><br><span class="line">                    LocalSocketAddress.Namespace.RESERVED);</span><br><span class="line"></span><br><span class="line">            mSocket.connect(address);</span><br><span class="line"></span><br><span class="line">            mIn = mSocket.getInputStream();</span><br><span class="line">            mOut = mSocket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            disconnect();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"disconnecting..."</span>);</span><br><span class="line">        IoUtils.closeQuietly(mSocket);</span><br><span class="line">        IoUtils.closeQuietly(mIn);</span><br><span class="line">        IoUtils.closeQuietly(mOut);</span><br><span class="line"></span><br><span class="line">        mSocket = <span class="keyword">null</span>;</span><br><span class="line">        mIn = <span class="keyword">null</span>;</span><br><span class="line">        mOut = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">writeCommand</span><span class="params">(String cmdString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] cmd = cmdString.getBytes();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> len = cmd.length;</span><br><span class="line">        <span class="keyword">if</span> ((len &lt; <span class="number">1</span>) || (len &gt; buf.length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf[<span class="number">0</span>] = (<span class="keyword">byte</span>) (len &amp; <span class="number">0xff</span>);</span><br><span class="line">        buf[<span class="number">1</span>] = (<span class="keyword">byte</span>) ((len &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mOut.write(buf, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            mOut.write(cmd, <span class="number">0</span>, len);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"write error"</span>);</span><br><span class="line">            disconnect();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitForConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                execute(<span class="string">"ping"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            Slog.w(TAG, <span class="string">"installd not ready"</span>);</span><br><span class="line">            SystemClock.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallerException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InstallerException</span><span class="params">(String detailMessage)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(detailMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到在InstallerConnection中通过socket连接installd服务端，然后将Installer传入的cmd通过socket再传给installd处理。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;从前面&lt;a href=&quot;&quot;&gt;Android包管理机制(三)PMS处理APK安装&lt;/a&gt;中可以了解到PMS在安装APK的时候调用了Installer的函数，而Installer实际是调用了installd中的方法。今天我们就来了解下守护进程installd，看看它做了什么，以
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="installd" scheme="http://yoursite.com/tags/installd/"/>
    
      <category term="守护进程" scheme="http://yoursite.com/tags/%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-理解ActivityThread和App启动流程</title>
    <link href="http://yoursite.com/2021/04/21/Android%E7%B3%BB%E7%BB%9F-%E7%90%86%E8%A7%A3ActivityThread%E5%92%8CApp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    <id>http://yoursite.com/2021/04/21/Android系统-理解ActivityThread和App启动流程/</id>
    <published>2021-04-21T10:48:34.000Z</published>
    <updated>2021-04-26T02:02:04.014Z</updated>
    
    <content type="html"><![CDATA[<p>每一个App在启动时，都会由Zygote fork出一个进程，进程具有独立的资源空间，用于承载App上运行的各种Activity/Service等组件。</p><p>当进程创建后就要真正去启动一个App了，那么App的入口函数是什么呢？答案是ActivityThread的main函数。（进程创建后反射调用ActivityThread main函数）</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThread</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>可能有人会认为ActivityThread就是我们常说的主线程或UI线程，但是上面可以看到ActivityThread类是一个final类，也没有继承Thread。因为ActivityThread的Main函数是App的入口函数，那么调用它的线程就是UI线程。</p><p>OK，接下来分析一下ActivityThread具体做了些什么</p><h3 id="main-函数"><a href="#main-函数" class="headerlink" title="main()函数"></a>main()函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">//1.创建主线程looper,主线程初始化</span></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.主线程Handler初始化</span></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">        thread.attach(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        Looper.loop();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="1-主线程初始化"><a href="#1-主线程初始化" class="headerlink" title="1.主线程初始化"></a>1.主线程初始化</h3><p><code>frameworks/base/core/java/android/os/Looper.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主线程Looper的初始化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        prepare(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sMainLooper = myLooper();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通线程初始化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        prepare(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从上面的代码中可以看出，主线程初始化时，prepare传入false，而普通线程初始化时传入true，这个参数为quitAllowed，表示线程是否可以退出，主线程无法退出。prepare函数中创建一个Looper对象，并将对象保存在ThreadLocal中。</p><p>在prepare之后，又将主线程Looper赋值给了成员变量sMainLooper，这个成员变量的作用是向其他线程提供主线程Looper对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title">getMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> sMainLooper;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这样当我们调用<code>Looper.getMainLooper()</code>时可以获取到主线程的Looper对象了。</p><h3 id="2-主线程Handler初始化"><a href="#2-主线程Handler初始化" class="headerlink" title="2.主线程Handler初始化"></a>2.主线程Handler初始化</h3><p>在注释2处创建了ActivityThread对象，并获取了主线程的Handler。(attach稍等)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</span><br><span class="line"><span class="function"><span class="keyword">final</span> Handler <span class="title">getHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> mH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由此可见主线程的Handler作为ActivityThread的成员变量，是在ActivityThread的main方法被执行，ActivityThread被创建时而初始化。</p><h3 id="3-ActivityThread-attch"><a href="#3-ActivityThread-attch" class="headerlink" title="3.ActivityThread.attch()"></a>3.ActivityThread.attch()</h3><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ApplicationThread mAppThread = <span class="keyword">new</span> ApplicationThread();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         mgr.attachApplication(mAppThread);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ApplicationThread</strong>是ActivityThread内部类，继承自IApplicationThread.Stub，作为服务端接受AMS发出的请求并执行，ApplicationThread是ActivityThread与AMS连接的桥梁。</p><p>attch方法实际调用了AMS的attachApplication方法，去看下AMS里的实现</p><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AMS中的attachApplicationLocked方法有些复杂，这个流程可以理解为ActivityThread创建时（App启动时）需要向AMS注册自己，用于AMS管理ActivityThread中的所有四大组件的生命周期。</p><p>我们看下attachApplicationLocked中的关键部分</p><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread, <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//1.创建Application</span></span><br><span class="line">  thread.bindApplication(...);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//2.创建Activity</span></span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-thread-bindApplication"><a href="#3-1-thread-bindApplication" class="headerlink" title="3.1 thread.bindApplication"></a>3.1 thread.bindApplication</h4><p>AMS通过远程调用，最终又会调用到ActivityThread中ApplicationThread内部类方法。</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span></span></span><br><span class="line"><span class="function"><span class="params">                ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                IInstrumentationWatcher instrumentationWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">                IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">                CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (services != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Setup the service cache in the ServiceManager</span></span><br><span class="line">                ServiceManager.initServiceCache(services);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">            AppBindData data = <span class="keyword">new</span> AppBindData();</span><br><span class="line">            data.processName = processName;</span><br><span class="line">            data.appInfo = appInfo;</span><br><span class="line">            data.providers = providers;</span><br><span class="line">            data.instrumentationName = instrumentationName;</span><br><span class="line">            data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">            data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">            data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">            data.debugMode = debugMode;</span><br><span class="line">            data.enableBinderTracking = enableBinderTracking;</span><br><span class="line">            data.trackAllocation = trackAllocation;</span><br><span class="line">            data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">            data.persistent = persistent;</span><br><span class="line">            data.config = config;</span><br><span class="line">            data.compatInfo = compatInfo;</span><br><span class="line">            data.initProfilerInfo = profilerInfo;</span><br><span class="line">            sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>在方法中将AMS传递回的数据又发送给主线程中</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"bindApplication"</span>);</span><br><span class="line">    AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">    handleBindApplication(data);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>在主线程中调用handleBindApplication处理</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// send up app name; do this *before* waiting for debugger</span></span><br><span class="line">        <span class="comment">//设置进程名, 也就是说进程名是在进程真正创建以后的BIND_APPLICATION过程中才取名</span></span><br><span class="line">        Process.setArgV0(data.processName);</span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        <span class="comment">//重置时区</span></span><br><span class="line">        TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line">        LocaleList.setDefault(data.config.getLocales());</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//获取LoadedApk对象</span></span><br><span class="line">        <span class="comment">// (public final LoadedApk getPackageInfoNoCheck())</span></span><br><span class="line">        data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line">  ......</span><br><span class="line">          </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">            <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">            Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">            mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                    installContentProviders(app, data.providers);</span><br><span class="line">                    <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">                    <span class="comment">// ensure that the JIT is enabled "at some point".</span></span><br><span class="line">                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">            <span class="comment">//调用Application.onCreate()回调方法</span></span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>handleBindApplication中调用LoadedApk类中makeApplication方法</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 表示Application是个单例</span></span><br><span class="line">        <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mApplication;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过反射初始化Application</span></span><br><span class="line">        String appClass = mApplicationInfo.className;</span><br><span class="line">        <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                        <span class="string">"initializeJavaContextClassLoader"</span>);</span><br><span class="line">                initializeJavaContextClassLoader();</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">            app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                    cl, appClass, appContext);</span><br><span class="line">            appContext.setOuterContext(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate application "</span> + appClass</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mActivityThread.mAllApplications.add(app);</span><br><span class="line">        mApplication = app;</span><br><span class="line">   ......</span><br><span class="line">       <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到这里应用的Application 就创建出来了，创建Application后再调用callApplicationOnCreate，回调Application的onCreate方法。</p><h4 id="3-2-mStackSupervisor-attachApplicationLocked-app"><a href="#3-2-mStackSupervisor-attachApplicationLocked-app" class="headerlink" title="3.2 mStackSupervisor.attachApplicationLocked(app)"></a>3.2 mStackSupervisor.attachApplicationLocked(app)</h4><p>mStackSupervisor是AMS的成员变量，是Activity堆栈管理辅助类实例</p><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">        <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">            ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">                <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ActivityRecord hr = stack.topRunningActivityLocked();</span><br><span class="line">                <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                                didSomething = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Exception in new application when starting activity "</span></span><br><span class="line">                                  + hr.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!didSomething) &#123;</span><br><span class="line">            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> didSomething;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>attachApplicationLocked中获取App要启动的top Activity，然后realStartActivityLocked去启动。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">      </span><br><span class="line">      ......</span><br><span class="line">      app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">     ......       </span><br><span class="line">            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用ApplicationThread的scheduleLaunchActivity方法</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span></span><br><span class="line"><span class="function">.......</span></span><br><span class="line"><span class="function">        <span class="title">sendMessage</span><span class="params">(H.LAUNCH_ACTIVITY, r)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">            r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">            handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br></pre></td></tr></table></figure><p>最终调用handleLaunchActivity，最终启动一个Activity</p><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//通过反射去创建一个Activity，然后会调用Activity的各个生命周期方法</span></span><br><span class="line">        Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">            reportSizeConfigurations(r);</span><br><span class="line">            Bundle oldState = r.state;</span><br><span class="line">            <span class="comment">// onResume</span></span><br><span class="line">            handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">               </span><br><span class="line">                performPauseActivityIfNeeded(r, reason);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">                    r.state = oldState;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault()</span><br><span class="line">                    .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>frameworks/base/core/java/android/app/ActivityThread.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从ActivityClientRecord中获取待启动的Activity的组件信息</span></span><br><span class="line">        ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ComponentName component = r.intent.getComponent();</span><br><span class="line">        <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = r.intent.resolveActivity(</span><br><span class="line">                mInitialApplication.getPackageManager());</span><br><span class="line">            r.intent.setComponent(component);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Activity activity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//反射创建Activity</span></span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">            StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">            r.intent.setExtrasClassLoader(cl);</span><br><span class="line">            r.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                r.state.setClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//再次调用Application的创建方法，Application是个单例。但是如果这个Activity在另一个进程中，就需要再次创建Application</span></span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">                <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config.updateFrom(r.overrideConfig);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">                        + r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">                Window window = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                    window = r.mPendingRemoveWindow;</span><br><span class="line">                    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    activity.mIntent = customIntent;</span><br><span class="line">                &#125;</span><br><span class="line">                r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">                activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">                <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                    activity.setTheme(theme);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 调用Activity的onCreate方法回调，终于看到熟悉的Activity onCreate啦</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.activity = activity;</span><br><span class="line">                r.stopped = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                    <span class="comment">// onStart回调</span></span><br><span class="line">                    activity.performStart();</span><br><span class="line">                    r.stopped = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                                    r.persistentState);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                    activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class="line">                                r.persistentState);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                            <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                            <span class="string">" did not call through to super.onPostCreate()"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to start activity "</span> + component</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> activity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>后面就交给App里面处理逻辑了。</p><p>使用gityuan一张图总结一下</p><p><img src="/2021/04/21/Android系统-理解ActivityThread和App启动流程/start_activity_process.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;每一个App在启动时，都会由Zygote fork出一个进程，进程具有独立的资源空间，用于承载App上运行的各种Activity/Service等组件。&lt;/p&gt;
&lt;p&gt;当进程创建后就要真正去启动一个App了，那么App的入口函数是什么呢？答案是ActivityThread的
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="AMS" scheme="http://yoursite.com/tags/AMS/"/>
    
      <category term="ActivityThread" scheme="http://yoursite.com/tags/ActivityThread/"/>
    
  </entry>
  
  <entry>
    <title>Android系统开发-选择并启动默认Launcher</title>
    <link href="http://yoursite.com/2021/04/15/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91-%E9%80%89%E6%8B%A9%E5%B9%B6%E5%90%AF%E5%8A%A8%E9%BB%98%E8%AE%A4Launcher/"/>
    <id>http://yoursite.com/2021/04/15/Android系统开发-选择并启动默认Launcher/</id>
    <published>2021-04-15T01:46:01.000Z</published>
    <updated>2021-04-20T03:10:27.485Z</updated>
    
    <content type="html"><![CDATA[<p>如果在Android设备上又安装了一个Launcher应用，当我们返回主页的时候，Android就会弹出一个弹窗，要用户 选择要启动的Launcher应用，如下图所示：</p><p><img src="/2021/04/15/Android系统开发-选择并启动默认Launcher/launcher1.png" style="zoom:35%;"></p><p>这个是普通Android设备的正常流程，现在我们的需求是不再显示这个提示窗，在设置中增加一个选择默认启动Launcher的页面，默认选择Launcher3。</p><h2 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h2><p><img src="/2021/04/15/Android系统开发-选择并启动默认Launcher/launcher2.png" style="zoom:55%;"></p><p>在设置中增加一个这样的页面，显示所有声明了<code>&quot;android.intent.category.HOME&quot;</code>的应用</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getAllLauncherApps</span><span class="params">()</span></span>: MutableList&lt;AppInfo&gt; &#123;</span><br><span class="line">       <span class="keyword">val</span> list = ArrayList&lt;AppInfo&gt;()</span><br><span class="line">       <span class="keyword">val</span> launchIntent = Intent(Intent.ACTION_MAIN, <span class="literal">null</span>)</span><br><span class="line">           .addCategory(Intent.CATEGORY_HOME)</span><br><span class="line">       <span class="keyword">val</span> intents = packageManager.queryIntentActivities(launchIntent, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">       <span class="comment">//遍历</span></span><br><span class="line">       <span class="keyword">for</span> (ri <span class="keyword">in</span> intents) &#123;</span><br><span class="line">           <span class="comment">//得到包名</span></span><br><span class="line">           <span class="keyword">val</span> packageName = ri.activityInfo.applicationInfo.packageName</span><br><span class="line">           <span class="keyword">if</span> (packageName == <span class="string">"com.android.settings"</span>) &#123; <span class="comment">//不显示原生设置</span></span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//得到图标</span></span><br><span class="line">           <span class="keyword">val</span> icon = ri.loadIcon(packageManager)</span><br><span class="line">           <span class="comment">//得到应用名称</span></span><br><span class="line">           <span class="keyword">val</span> appName = ri.loadLabel(packageManager).toString()</span><br><span class="line"></span><br><span class="line">           <span class="comment">//封装应用信息对象</span></span><br><span class="line">           <span class="keyword">val</span> appInfo = AppInfo(icon, appName, packageName)</span><br><span class="line">           <span class="comment">//添加到list</span></span><br><span class="line">           list.add(appInfo)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> list</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>使用PackageManager提供的queryIntentActivities方法就可以获取所有Launcher应用，原生设置中也有Activity声明了HOME属性，在这里就把它屏蔽掉。</p><p>默认选择Launcher3应用为默认启动</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> DEFAULT_LAUNCHER = <span class="string">"my_default_launcher"</span></span><br><span class="line">defaultLauncher = Settings.Global.getString(contentResolver, DEFAULT_LAUNCHER)</span><br><span class="line"><span class="keyword">if</span> (defaultLauncher.isNullOrEmpty()) &#123;</span><br><span class="line">    defaultLauncher = <span class="string">"com.android.launcher3"</span></span><br><span class="line">    Settings.Global.putString(contentResolver, DEFAULT_LAUNCHER, defaultLauncher)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当选择另一个应用，就把选择应用的包名设置到 Settings.Global中。</p><p>这样应用选择页面完成，也设置了一个全局的参数提供给系统。</p><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>最开始提到了Launcher选择弹窗，我们就考虑在这里做点事，把弹窗的逻辑给跳过，就可以实现默认启动。</p><p>弹窗源码位于<code>frameworks/base/core/java/com/android/internal/app/ResolverActivity.java</code></p><p>在这里就不具体分析源码了，就看关键部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">configureContentView</span><span class="params">(List&lt;Intent&gt; payloadIntents, Intent[] initialIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">            List&lt;ResolveInfo&gt; rList, <span class="keyword">boolean</span> alwaysUseOption)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The last argument of createAdapter is whether to do special handling</span></span><br><span class="line">        <span class="comment">// of the last used choice to highlight it in the list.  We need to always</span></span><br><span class="line">        <span class="comment">// turn this off when running under voice interaction, since it results in</span></span><br><span class="line">        <span class="comment">// a more complicated UI that the current voice interaction flow is not able</span></span><br><span class="line">        <span class="comment">// to handle.</span></span><br><span class="line">        mAdapter = createAdapter(<span class="keyword">this</span>, payloadIntents, initialIntents, rList,</span><br><span class="line">                mLaunchedFromUid, alwaysUseOption &amp;&amp; !isVoiceInteraction());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> layoutId;</span><br><span class="line">        <span class="keyword">if</span> (mAdapter.hasFilteredItem()) &#123;</span><br><span class="line">            layoutId = R.layout.resolver_list_with_default;</span><br><span class="line">            alwaysUseOption = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            layoutId = getLayoutResource();</span><br><span class="line">        &#125;</span><br><span class="line">        mAlwaysUseOption = alwaysUseOption;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> count = mAdapter.getUnfilteredCount();</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">1</span> &amp;&amp; mAdapter.getOtherProfile() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Only one target, so we're a candidate to auto-launch!</span></span><br><span class="line">            <span class="keyword">final</span> TargetInfo target = mAdapter.targetInfoForPosition(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (shouldAutoLaunchSingleChoice(target)) &#123;</span><br><span class="line">                safelyStartActivity(target);</span><br><span class="line">                mPackageMonitor.unregister();</span><br><span class="line">                mRegistered = <span class="keyword">false</span>;</span><br><span class="line">                finish();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// add by liuwei,if set decard_default_launcher,start default</span></span><br><span class="line">            String defaultlauncher = Settings.Global.getString(<span class="keyword">this</span>.getContentResolver(), <span class="string">"my_default_launcher"</span>);</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">final</span> TargetInfo defaultTarget = mAdapter.targetInfoForDefault(defaultlauncher);</span><br><span class="line">            <span class="keyword">if</span>(defaultTarget != <span class="keyword">null</span>)&#123;</span><br><span class="line">                safelyStartActivity(defaultTarget);</span><br><span class="line">                mPackageMonitor.unregister();</span><br><span class="line">                mRegistered = <span class="keyword">false</span>;</span><br><span class="line">                finish();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//end</span></span><br><span class="line">            setContentView(layoutId);</span><br><span class="line">            mAdapterView = (AbsListView) findViewById(R.id.resolver_list);</span><br><span class="line">            onPrepareAdapterView(mAdapterView, mAdapter, alwaysUseOption);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setContentView(R.layout.resolver_list);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> TextView empty = (TextView) findViewById(R.id.empty);</span><br><span class="line">            empty.setVisibility(View.VISIBLE);</span><br><span class="line"></span><br><span class="line">            mAdapterView = (AbsListView) findViewById(R.id.resolver_list);</span><br><span class="line">            mAdapterView.setVisibility(View.GONE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在configureContentView中判断launcher应用个数，如果为1，则直接启动，finish当前页面。下面判断count&gt;0，我们就在这里面增加自己的逻辑，获取配置的Settings.Global参数，再去Adapter中判断是否有应用包名和参数匹配，如果有就safelyStartActivity()，关闭弹窗。如果没有匹配包名，就走正常流程，弹窗提示用户。</p><p>mAdapter.targetInfoForDefault函数是在 <code>public class ResolveListAdapter extends BaseAdapter</code>中增加函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TargetInfo <span class="title">targetInfoForDefault</span><span class="params">(String myDefault)</span></span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(myDefault == <span class="keyword">null</span>)&#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           TargetInfo info = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;mDisplayList.size();i++)&#123;</span><br><span class="line">               String disPackageName = mDisplayList.get(i).getResolveInfo().activityInfo.applicationInfo.packageName;</span><br><span class="line">               <span class="keyword">if</span>(myDefault.equals(disPackageName) )&#123;</span><br><span class="line">                   info = mDisplayList.get(i);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> info;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>OK，功能实现完成，自测也没有问题。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;如果在Android设备上又安装了一个Launcher应用，当我们返回主页的时候，Android就会弹出一个弹窗，要用户 选择要启动的Launcher应用，如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2021/04/15/Android系统开发-选择并启动默认Laun
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="Launcher" scheme="http://yoursite.com/tags/Launcher/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-深入理解ActivityManagerService(二)startActiviy流程分析</title>
    <link href="http://yoursite.com/2021/03/29/Android%E7%B3%BB%E7%BB%9F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ActivityManagerService-%E4%BA%8C-startActivity%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/</id>
    <published>2021-03-29T10:59:16.000Z</published>
    <updated>2021-04-25T06:10:49.971Z</updated>
    
    <content type="html"><![CDATA[<p>上一篇文章<a href="https://david1840.github.io/2021/03/27/Android%E7%B3%BB%E7%BB%9F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ActivityManagerService-%E4%B8%80-AMS%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" target="_blank" rel="noopener">深入理解ActivityManagerService(一)AMS的启动流程</a>中了解了AMS启动的流程，接下来就来看下我们在开发中调用startActivity(Intent)发生了什么。</p><p>startActivity又要分为两种情况，一个是我们在应用中去启动本应用中的一个Activity（也称为子Activity），这个时候Activity所属的进程肯定是存在的，那么就启动Activity即可；还有一种情况是我们去启动另一个App中的Activity（也称为根Activity，以快捷图标的形式显示在Launcher中），那么就要先判断这个App的进程是否存在，如果不存在，就要先去请求Zygote创建应用程序进程。</p><p>在Launcher中点击图标启动应用，都会调用startActivity方法</p><h2 id="一、App层"><a href="#一、App层" class="headerlink" title="一、App层"></a>一、App层</h2><h3 id="1-Activity-startActivityForResult"><a href="#1-Activity-startActivityForResult" class="headerlink" title="1.Activity.startActivityForResult"></a>1.Activity.startActivityForResult</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">          startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">          <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">          startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">      startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>可以看到startActivity实际还是调用了startActivityForResult函数，只是requestCode为-1。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">           @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">           options = transferSpringboardActivityOptions(options);</span><br><span class="line">           <span class="comment">//</span></span><br><span class="line">           Instrumentation.ActivityResult ar =</span><br><span class="line">               <span class="comment">//执行Activity启动</span></span><br><span class="line">               mInstrumentation.execStartActivity(</span><br><span class="line">                   <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                   intent, requestCode, options);</span><br><span class="line">           <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mMainThread.sendActivityResult(</span><br><span class="line">                   mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                   ar.getResultData());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           cancelInputsAndStartExitTransition(options);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line">               <span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">               mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="2-Instrumentation-startActivity"><a href="#2-Instrumentation-startActivity" class="headerlink" title="2.Instrumentation.startActivity"></a>2.Instrumentation.startActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">           Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">       IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">       Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">           intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">       &#125;</span><br><span class="line">  </span><br><span class="line">    ......</span><br><span class="line">         </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           intent.migrateExtraStreamToClipData();</span><br><span class="line">           intent.prepareToLeaveProcess(who);</span><br><span class="line">           <span class="comment">/////////</span></span><br><span class="line">           <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">           .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                   intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                   token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                   requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">           <span class="comment">//检查activity是否启动成功</span></span><br><span class="line">           checkStartActivityResult(result, intent);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>从上面的代码中可以看到，关键代码就是 ActivityManagerNative.getDefault().startActivity方法。</p><blockquote><p>Android 8.0之前是通过ActivityManagerNative.getDefault()获取ActivityManagerProxy，即AMS的代理类，之后就通过AMP与AMS进行通信，8.0之后这里就不再使用ActivityManagerProxy，而是ActivityManager通过AIDL直接与AMS交互。</p></blockquote><h3 id="3-ActivityManagerNative-startActivity"><a href="#3-ActivityManagerNative-startActivity" class="headerlink" title="3.ActivityManagerNative.startActivity"></a>3.ActivityManagerNative.startActivity</h3><p><code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gDefault.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">            &#125;</span><br><span class="line">            IActivityManager am = asInterface(b);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> am;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>getDefault会调用一个Singleton类gDefault的get函数。首先通过ServiceManager获取名为”activity”的Service引用，也就是IBinder类型的AMS的引用。然后将其封装为AMP对象，并将它保存到gDefault中，此后调用AMN的getDefault方法就会直接获得AMS的代理对象AMP。</p><p><code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager in =</span><br><span class="line">            (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后startActivity，实际调用的就是ActivityManagerProxy的startActivity函数，与上面new ActivityManagerProxy(obj);对应。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">        data.writeString(callingPackage);</span><br><span class="line">        intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeString(resolvedType);</span><br><span class="line">        data.writeStrongBinder(resultTo);</span><br><span class="line">        data.writeString(resultWho);</span><br><span class="line">        data.writeInt(requestCode);</span><br><span class="line">        data.writeInt(startFlags);</span><br><span class="line">        <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过AIDL调用远程函数</span></span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IBinder b = data.readStrongBinder();</span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">            String callingPackage = data.readString();</span><br><span class="line">            Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">            String resolvedType = data.readString();</span><br><span class="line">            IBinder resultTo = data.readStrongBinder();</span><br><span class="line">            String resultWho = data.readString();</span><br><span class="line">            <span class="keyword">int</span> requestCode = data.readInt();</span><br><span class="line">            <span class="keyword">int</span> startFlags = data.readInt();</span><br><span class="line">            ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">            Bundle options = data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? Bundle.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 这里调用AMS的startActivity函数</span></span><br><span class="line">            <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                    resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            reply.writeInt(result);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>最终在ActivityManagerNative中调用AMS的startActivity函数，接下来就交给AMS来处理逻辑。</p><h2 id="二、System-Server层"><a href="#二、System-Server层" class="headerlink" title="二、System Server层"></a>二、System Server层</h2><h3 id="1-ActivityManagerService-startActivity"><a href="#1-ActivityManagerService-startActivity" class="headerlink" title="1. ActivityManagerService.startActivity"></a>1. ActivityManagerService.startActivity</h3><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">          Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">              resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">              UserHandle.getCallingUserId());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">          Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">      enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">      userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">              userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">      <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">              resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">              profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>AMS中调用ActivityStarter中的startActivityMayWait函数</p><h3 id="2-ActivityStarter-startActivityMayWait"><a href="#2-ActivityStarter-startActivityMayWait" class="headerlink" title="2. ActivityStarter.startActivityMayWait"></a>2. ActivityStarter.startActivityMayWait</h3><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestRealCallingPid, <span class="keyword">int</span> requestRealCallingUid, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save a copy in case ephemeral needs it</span></span><br><span class="line">    <span class="keyword">final</span> Intent ephemeralIntent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">// Don't modify the client's object!</span></span><br><span class="line">    intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">//收集Intent所指向的Activity信息, 当存在多个可供选择的Activity,则直接向用户弹出resolveActivity </span></span><br><span class="line">    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//////////</span></span><br><span class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                inTask);</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord launchedActivity = mReusedActivity != <span class="keyword">null</span></span><br><span class="line">                ? mReusedActivity : outRecord[<span class="number">0</span>];</span><br><span class="line">        mSupervisor.mActivityMetricsLogger.notifyActivityLaunched(res, launchedActivity);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这个流程中就是用ActivityStackSupervisor的resolveIntent()和resolveActivity()来找到相应的Activity组件, 然后再进入startActivityLocked()</p><h4 id="2-1-ActivityStackSupervisor-resolveActivity"><a href="#2-1-ActivityStackSupervisor-resolveActivity" class="headerlink" title="2.1 ActivityStackSupervisor.resolveActivity"></a>2.1 ActivityStackSupervisor.resolveActivity</h4><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, ResolveInfo rInfo, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityInfo aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Store the found target back into the intent, because now that</span></span><br><span class="line">            <span class="comment">// we have it we never want to do this again.  For example, if the</span></span><br><span class="line">            <span class="comment">// user navigates back to this point in the history, we should</span></span><br><span class="line">            <span class="comment">// always restart the exact same activity.</span></span><br><span class="line">            intent.setComponent(<span class="keyword">new</span> ComponentName(</span><br><span class="line">                    aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Don't debug things in the system process</span></span><br><span class="line">            <span class="keyword">if</span> (!aInfo.processName.equals(<span class="string">"system"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_DEBUG) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setDebugApp(aInfo.processName, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_NATIVE_DEBUGGING) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setNativeDebuggingAppLocked(aInfo.applicationInfo, aInfo.processName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_TRACK_ALLOCATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setTrackAllocationApp(aInfo.applicationInfo, aInfo.processName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mService.setProfileApp(aInfo.applicationInfo, aInfo.processName, profilerInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> aInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resolveIntent(intent, resolvedType, userId, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AppGlobals.getPackageManager().resolveIntent(intent, resolvedType,</span><br><span class="line">                    PackageManager.MATCH_DEFAULT_ONLY | flags</span><br><span class="line">                    | ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ResolveInfo rInfo = resolveIntent(intent, resolvedType, userId);</span><br><span class="line">        <span class="keyword">return</span> resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在ActivityStackSupervisor中调用PackageManagerService去解析Intent，来查询系统中所有符合要求的Activity，当存在多个满足条件的Activity则会弹框让用户来选择。</p><h4 id="2-2-PMS-resolveIntent"><a href="#2-2-PMS-resolveIntent" class="headerlink" title="2.2 PMS.resolveIntent"></a>2.2 PMS.resolveIntent</h4><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">          flags = updateFlagsForResolve(flags, userId, intent);</span><br><span class="line">          enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">                  <span class="keyword">false</span> <span class="comment">/*requireFullPermission*/</span>, <span class="keyword">false</span> <span class="comment">/*checkShell*/</span>, <span class="string">"resolve intent"</span>);</span><br><span class="line"></span><br><span class="line">          Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queryIntentActivities"</span>);</span><br><span class="line">          <span class="keyword">final</span> List&lt;ResolveInfo&gt; query = queryIntentActivitiesInternal(intent, resolvedType,</span><br><span class="line">                  flags, userId);</span><br><span class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 根据priority，preferred选择最佳的Activity</span></span><br><span class="line">          <span class="keyword">final</span> ResolveInfo bestChoice =</span><br><span class="line">                  chooseBestActivity(intent, resolvedType, flags, query, userId);</span><br><span class="line">          <span class="keyword">return</span> bestChoice;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-PMS-queryIntentActivities"><a href="#2-3-PMS-queryIntentActivities" class="headerlink" title="2.3 PMS.queryIntentActivities"></a>2.3 PMS.queryIntentActivities</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentActivities</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ComponentName comp = intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getSelector() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent = intent.getSelector();</span><br><span class="line">            comp = intent.getComponent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//获取Activity信息</span></span><br><span class="line">        <span class="keyword">final</span> ActivityInfo ai = getActivityInfo(comp, flags, userId);</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">            ri.activityInfo = ai;</span><br><span class="line">            list.add(ri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ActivityStarter-startActivityLocked"><a href="#3-ActivityStarter-startActivityLocked" class="headerlink" title="3. ActivityStarter.startActivityLocked"></a>3. ActivityStarter.startActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">  </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">            err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                    <span class="keyword">true</span>, options, inTask);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mService.mWindowManager.continueSurfaceLayout();</span><br><span class="line">        &#125;</span><br><span class="line">        postStartActivityUncheckedProcessing(r, err, stack.mStackId, mSourceRecord, mTargetStack);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="4-ActivityStarter-startActivityUnchecked"><a href="#4-ActivityStarter-startActivityUnchecked" class="headerlink" title="4. ActivityStarter.startActivityUnchecked"></a>4. ActivityStarter.startActivityUnchecked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">           IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">     ...  </span><br><span class="line">        mSupervisor.resumeFocusedStackTopActivityLocked();  </span><br><span class="line">     ... </span><br><span class="line">       <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="5-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#5-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="5. ActivityStackSupervisor.resumeFocusedStackTopActivityLocked"></a>5. ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">           <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">       <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">           mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="6-ActivityStack-resumeTopActivityUncheckedLocked"><a href="#6-ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="6. ActivityStack.resumeTopActivityUncheckedLocked"></a>6. ActivityStack.resumeTopActivityUncheckedLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">           mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure><h3 id="7-ActivityStackSupervisor-startSpecificActivityLocked"><a href="#7-ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="7. ActivityStackSupervisor.startSpecificActivityLocked"></a>7. ActivityStackSupervisor.startSpecificActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">              r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">      r.task.stack.setLaunchTime(r);</span><br><span class="line">      <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;<span class="comment">//1</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                      || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                  app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">                          mService.mProcessStats);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 真正去启动Activity</span></span><br><span class="line">              realStartActivityLocked(r, app, andResume, checkConfig);<span class="comment">//2</span></span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                      + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//当进程不存在则创建进程</span></span><br><span class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">              <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>累啊，看了半天终于到关键的地方了。</p><p>根据进程名称获取进程信息，如果进程存在，才到真正去启动Activity的地方，启动子Activity也就是在应用中启动其他Activity页面就会走这里。而进程如果不存在，就要走下面 mService.startProcessLocked去创建一个进程。还有可能是新创建的Activity被定义到一个新的进程，即定义了android:process，这样也会创建一个新的进程。</p><p>进程创建最终是由Zygote fork出一个进程，在Android中所有的App进程都是由Zygote进程fork生成的。这个流程也是很复杂，这里就不继续看下去了，我们先看下启动Activity的流程。</p><h3 id="8-ActivityStackSupervisor-realStartActivityLocked"><a href="#8-ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="8. ActivityStackSupervisor.realStartActivityLocked"></a>8. ActivityStackSupervisor.realStartActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">     ......</span><br><span class="line">            app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>关键代码<code>app.thread.scheduleLaunchActivity</code>，这里我们认为App进程已经启动了，AMS中已经有了对应进程的ProcessRecord。</p><p>app.thread类型为IApplicationThread，可以远程调用到ActivityThread的scheduleLaunchActivity方法，再发送H.LAUNCH_ACTIVITY消息，最终反射生成一个Activity。具体可见<a href="https://david1840.github.io/2021/04/21/Android%E7%B3%BB%E7%BB%9F-%E7%90%86%E8%A7%A3ActivityThread%E5%92%8CApp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" target="_blank" rel="noopener">Android系统-理解ActivityThread和App启动流程</a></p><h3 id="9-调用流程"><a href="#9-调用流程" class="headerlink" title="9.调用流程"></a>9.调用流程</h3><p><img src="/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/launch1.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;上一篇文章&lt;a href=&quot;https://david1840.github.io/2021/03/27/Android%E7%B3%BB%E7%BB%9F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ActivityManagerService
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="AMS" scheme="http://yoursite.com/tags/AMS/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-深入理解ActivityManagerService(一)AMS的启动流程</title>
    <link href="http://yoursite.com/2021/03/27/Android%E7%B3%BB%E7%BB%9F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ActivityManagerService-%E4%B8%80-AMS%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"/>
    <id>http://yoursite.com/2021/03/27/Android系统-深入理解ActivityManagerService-一-AMS的启动流程/</id>
    <published>2021-03-27T11:18:08.000Z</published>
    <updated>2021-04-21T08:28:53.651Z</updated>
    
    <content type="html"><![CDATA[<p>AMS应该是作为Android开发经常听到的一个系统服务了，它是系统的引导服务，Android中<strong>最核心的服务</strong>，主要负责系统中四大组件的<strong>启动、切换、调度及应用进程的管理和调度</strong>等工作，在Android系统中非常重要。所以，接下来就深入了解一下AMS的世界，首先我们从它的启动流程开始。</p><h2 id="AMS的启动"><a href="#AMS的启动" class="headerlink" title="AMS的启动"></a>AMS的启动</h2><p>在之前的文章<a href="">Android包管理机制(一)PMS服务启动</a>中，我们有提到在SystemServer中启动引导服务，而AMS也是系统的引导服务，所以首先去看下SystemServer。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//启动installer服务</span></span><br><span class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">        <span class="comment">// AMS</span></span><br><span class="line">        mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">                ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">        mActivityManagerService.setInstaller(installer);</span><br><span class="line">  </span><br><span class="line">  mActivityManagerService.initPowerManagement();</span><br><span class="line">  mActivityManagerService.setSystemProcess();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>启动AMS首先调用SystemServiceManager的startService方法，参数为ActivityManagerService.Lifecycle.class</p><p><code>frameworks/base/services/core/java/com/android/server/SystemServiceManager.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="keyword">public</span> &lt;T extends SystemService&gt; <span class="function">T <span class="title">startService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> T service;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);</span><br><span class="line">               service = constructor.newInstance(mContext);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">           ......</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Register it.</span></span><br><span class="line">           mServices.add(service);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Start it.</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               service.onStart();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to start service "</span> + name</span><br><span class="line">                       + <span class="string">": onStart threw an exception"</span>, ex);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> service;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>在startService中，首先根据传进来的Lifecycle得到它的构造器constructor，再调用constructor的newInstance方法来创建Lifecycle类型的service对象。接着将刚创建的service添加到ArrayList类型的mServices对象中来完成注册。最后调用service的onStart方法来启动service，并返回该service。</p><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> <span class="keyword">extends</span> <span class="title">SystemService</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Lifecycle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(context);</span><br><span class="line">           mService = <span class="keyword">new</span> ActivityManagerService(context);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           mService.start();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> ActivityManagerService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> mService;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>结合Lifecycle的代码，可以看到，startService中newInstance实际调用了Lifecycle(Context context){}，创建了ActivityManagerService实例mService，当调用Lifecycle类型的service的onStart方法时，实际上是调用了AMS的start方法。</p><p>所以获取AMS实例代码，最后getService()会返回Lifecycle中创建的mService。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">                ActivityManagerService.Lifecycle.class).getService();</span><br></pre></td></tr></table></figure><h2 id="AMS构造函数"><a href="#AMS构造函数" class="headerlink" title="AMS构造函数"></a>AMS构造函数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    mContext = systemContext;</span><br><span class="line">    mFactoryTest = FactoryTest.getMode();</span><br><span class="line">    mSystemThread = ActivityThread.currentActivityThread();</span><br><span class="line"></span><br><span class="line">    mPermissionReviewRequired = mContext.getResources().getBoolean(</span><br><span class="line">            com.android.internal.R.bool.config_permissionReviewRequired);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建名为"ActivityManager"的前台线程，并获取mHandler</span></span><br><span class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">    mHandlerThread.start();</span><br><span class="line">    mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过UiThread类，创建名为"android.ui"的线程</span></span><br><span class="line">    mUiHandler = <span class="keyword">new</span> UiHandler();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* static; one-time init here */</span></span><br><span class="line">    <span class="keyword">if</span> (sKillHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//创建名为"ActivityManager:kill"的后台线程，sKillHandler</span></span><br><span class="line">        sKillThread = <span class="keyword">new</span> ServiceThread(TAG + <span class="string">":kill"</span>,</span><br><span class="line">                android.os.Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/* allowIo */</span>);</span><br><span class="line">        sKillThread.start();</span><br><span class="line">        sKillHandler = <span class="keyword">new</span> KillHandler(sKillThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//前台广播接收器，在运行超过10s将放弃执行</span></span><br><span class="line">    mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"foreground"</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">//后台广播接收器，在运行超过60s将放弃执行</span></span><br><span class="line">    mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"background"</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line">    mBroadcastQueues[<span class="number">0</span>] = mFgBroadcastQueue;</span><br><span class="line">    mBroadcastQueues[<span class="number">1</span>] = mBgBroadcastQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建ActiveServices</span></span><br><span class="line">    mServices = <span class="keyword">new</span> ActiveServices(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//创建ProviderMap</span></span><br><span class="line">    mProviderMap = <span class="keyword">new</span> ProviderMap(<span class="keyword">this</span>);</span><br><span class="line">    mAppErrors = <span class="keyword">new</span> AppErrors(mContext, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move creation of battery stats service outside of activity manager service.</span></span><br><span class="line">    <span class="comment">//创建目录/data/system</span></span><br><span class="line">    File dataDir = Environment.getDataDirectory();</span><br><span class="line">    File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    systemDir.mkdirs();</span><br><span class="line">    <span class="comment">// 电池状态服务</span></span><br><span class="line">    mBatteryStatsService = <span class="keyword">new</span> BatteryStatsService(systemDir, mHandler);</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().readLocked();</span><br><span class="line">    mBatteryStatsService.scheduleWriteToDisk();</span><br><span class="line">    mOnBattery = DEBUG_POWER ? <span class="keyword">true</span></span><br><span class="line">            : mBatteryStatsService.getActiveStatistics().getIsOnBattery();</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().setCallback(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建进程统计服务，信息保存在目录/data/system/procstats</span></span><br><span class="line">    mProcessStats = <span class="keyword">new</span> ProcessStatsService(<span class="keyword">this</span>, <span class="keyword">new</span> File(systemDir, <span class="string">"procstats"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//应用程序的操作（权限）管理</span></span><br><span class="line">    mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line">    mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                                != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                            runInBackgroundDisabled(uid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    mGrantFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(systemDir, <span class="string">"urigrants.xml"</span>));</span><br><span class="line"></span><br><span class="line">    mUserController = <span class="keyword">new</span> UserController(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    GL_ES_VERSION = SystemProperties.getInt(<span class="string">"ro.opengles.version"</span>,</span><br><span class="line">        ConfigurationInfo.GL_ES_VERSION_UNDEFINED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SystemProperties.getInt(<span class="string">"sys.use_fifo_ui"</span>, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        mUseFifoUiScheduling = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTrackingAssociations = <span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.track-associations"</span>));</span><br><span class="line"></span><br><span class="line">    mConfiguration.setToDefaults();</span><br><span class="line">    mConfiguration.setLocales(LocaleList.getDefault());</span><br><span class="line"></span><br><span class="line">    mConfigurationSeq = mConfiguration.seq = <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//CPU使用情况的追踪器执行初始化</span></span><br><span class="line">    mProcessCpuTracker.init();</span><br><span class="line"></span><br><span class="line">    mCompatModePackages = <span class="keyword">new</span> CompatModePackages(<span class="keyword">this</span>, systemDir, mHandler);</span><br><span class="line">    mIntentFirewall = <span class="keyword">new</span> IntentFirewall(<span class="keyword">new</span> IntentFirewallInterface(), mHandler);</span><br><span class="line">    mStackSupervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>);</span><br><span class="line">    mActivityStarter = <span class="keyword">new</span> ActivityStarter(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line">    mRecentTasks = <span class="keyword">new</span> RecentTasks(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建名为"CpuTracker"的线程</span></span><br><span class="line">    mProcessCpuThread = <span class="keyword">new</span> Thread(<span class="string">"CpuTracker"</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">                            <span class="keyword">long</span> nextCpuDelay = (mLastCpuTime.get()+MONITOR_CPU_MAX_TIME)-now;</span><br><span class="line">                            <span class="keyword">long</span> nextWriteDelay = (mLastWriteTime+BATTERY_STATS_TIME)-now;</span><br><span class="line">                            <span class="comment">//Slog.i(TAG, "Cpu delay=" + nextCpuDelay</span></span><br><span class="line">                            <span class="comment">//        + ", write delay=" + nextWriteDelay);</span></span><br><span class="line">                            <span class="keyword">if</span> (nextWriteDelay &lt; nextCpuDelay) &#123;</span><br><span class="line">                                nextCpuDelay = nextWriteDelay;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (nextCpuDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                mProcessCpuMutexFree.set(<span class="keyword">true</span>);</span><br><span class="line">                                <span class="keyword">this</span>.wait(nextCpuDelay);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    updateCpuStatsNow();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Unexpected exception collecting process stats"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加Watchdog监控</span></span><br><span class="line">    Watchdog.getInstance().addMonitor(<span class="keyword">this</span>);</span><br><span class="line">    Watchdog.getInstance().addThread(mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在构造函数中进行各个变量的初始化，创建ActivityManager，ActivityManager:kill，android.ui，CpuTracker线程</p><h2 id="AMS-start"><a href="#AMS-start" class="headerlink" title="AMS.start"></a>AMS.start</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Process.removeAllProcessGroups();<span class="comment">//移除所有的进程组</span></span><br><span class="line">        mProcessCpuThread.start();<span class="comment">//启动CpuTracker线程</span></span><br><span class="line"></span><br><span class="line">        mBatteryStatsService.publish(mContext);<span class="comment">//启动电池统计服务</span></span><br><span class="line">        mAppOpsService.publish(mContext);</span><br><span class="line">        <span class="comment">//创建LocalService，并添加到LocalServices</span></span><br><span class="line">        LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="AMS-setSystemProcess"><a href="#AMS-setSystemProcess" class="headerlink" title="AMS.setSystemProcess"></a>AMS.setSystemProcess</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">         ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">         ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>)); <span class="comment">//内存</span></span><br><span class="line">         ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>)); <span class="comment">//图像信息</span></span><br><span class="line">         ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>)); <span class="comment">//数据库</span></span><br><span class="line">         <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">             ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>)); <span class="comment">//CPU</span></span><br><span class="line">         &#125;</span><br><span class="line">         ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>)); <span class="comment">//权限</span></span><br><span class="line">         ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>)); <span class="comment">//进程服务</span></span><br><span class="line"></span><br><span class="line">         ApplicationInfo info = mContext.getPackageManager().getApplicationInfo(</span><br><span class="line">                 <span class="string">"android"</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);</span><br><span class="line">         mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line">         <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">             ProcessRecord app = newProcessRecordLocked(info, info.processName, <span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line">             app.persistent = <span class="keyword">true</span>;</span><br><span class="line">             app.pid = MY_PID;</span><br><span class="line">             app.maxAdj = ProcessList.SYSTEM_ADJ;</span><br><span class="line">             app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">             <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                 mPidsSelfLocked.put(app.pid, app);</span><br><span class="line">             &#125;</span><br><span class="line">             updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">             updateOomAdjLocked();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                 <span class="string">"Unable to find android system package"</span>, e);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>setSystemProcess就是注册各种服务到ServiceManager，加载名为“android”的package，然后为“android”创建ProcessRecord，用于描述进程的数据结构。</p><h2 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices"></a>startOtherServices</h2><p>上面的流程是在startBootstrapServices时，执行的AMS的创建等操作，但AMS的流程还没结束，在startOtherServices中仍然有AMS的后续操作。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//安装系统Provider</span></span><br><span class="line">    mActivityManagerService.installSystemProviders();</span><br><span class="line">    mActivityManagerService.setWindowManager(wm);</span><br><span class="line">    mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;ProviderInfo&gt; providers;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            ProcessRecord app = mProcessNames.get(<span class="string">"system"</span>, Process.SYSTEM_UID);</span><br><span class="line">            providers = generateApplicationProvidersLocked(app);</span><br><span class="line">            <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=providers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    ProviderInfo pi = (ProviderInfo)providers.get(i);</span><br><span class="line">                    <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Not installing system proc provider "</span> + pi.name</span><br><span class="line">                                + <span class="string">": not system .apk"</span>);</span><br><span class="line">                        <span class="comment">//移除非系统的provider</span></span><br><span class="line">                        providers.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//安装所有的系统provider</span></span><br><span class="line">            mSystemThread.installSystemProviders(providers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建核心Settings Observer，用于监控Settings的改变。</span></span><br><span class="line">        mCoreSettingsObserver = <span class="keyword">new</span> CoreSettingsObserver(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//监控字体的变化</span></span><br><span class="line">        mFontScaleSettingObserver = <span class="keyword">new</span> FontScaleSettingObserver();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>##systemReady</p><p>在startOtherServices中调用mActivityManagerService.systemReady(），参数为Runable类型的goingCallback</p><p>在AMS中systemReady函数可以分为三个部分</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">before</span> goingCallback; </span><br><span class="line">    goingCallback.<span class="title">run</span>(); </span><br><span class="line">    <span class="keyword">after</span> goingCallback; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>###before goingCallback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mSystemReady) &#123;<span class="comment">//第一次进入为false，不执行下面代码</span></span><br><span class="line">             <span class="comment">// If we're done calling all the receivers, run the next "boot phase" passed in</span></span><br><span class="line">             <span class="comment">// by the SystemServer</span></span><br><span class="line">             <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 goingCallback.run();</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         mLocalDeviceIdleController</span><br><span class="line">                 = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Make sure we have the current profile info, since it is needed for security checks.</span></span><br><span class="line">         mUserController.onSystemReady();</span><br><span class="line">         mRecentTasks.onSystemReadyLocked();</span><br><span class="line">         mAppOpsService.systemReady();</span><br><span class="line">         mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ArrayList&lt;ProcessRecord&gt; procsToKill = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">synchronized</span>(mPidsSelfLocked) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i=mPidsSelfLocked.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">             ProcessRecord proc = mPidsSelfLocked.valueAt(i);</span><br><span class="line">             <span class="comment">//非persistent进程,加入procsToKill</span></span><br><span class="line">             <span class="keyword">if</span> (!isAllowedWhileBooting(proc.info))&#123;</span><br><span class="line">                 <span class="keyword">if</span> (procsToKill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     procsToKill = <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;();</span><br><span class="line">                 &#125;</span><br><span class="line">                 procsToKill.add(proc);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (procsToKill != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">for</span> (<span class="keyword">int</span> i=procsToKill.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                 <span class="comment">//杀掉procsToKill中的进程, 杀掉进程且不允许重启</span></span><br><span class="line">                 ProcessRecord proc = procsToKill.get(i);</span><br><span class="line">                 Slog.i(TAG, <span class="string">"Removing system update proc: "</span> + proc);</span><br><span class="line">                 removeProcessLocked(proc, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"system update done"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Now that we have cleaned up any update processes, we</span></span><br><span class="line">         <span class="comment">// are ready to start launching real processes and know that</span></span><br><span class="line">         <span class="comment">// we won't trample on them any more.</span></span><br><span class="line">         <span class="comment">//process处于ready状态</span></span><br><span class="line">         mProcessesReady = <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Slog.i(TAG, <span class="string">"System now ready"</span>);</span><br><span class="line">     EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_AMS_READY,</span><br><span class="line">         SystemClock.uptimeMillis());</span><br></pre></td></tr></table></figure><p>非persistent进程加入procsToKill，杀掉procsToKill中的进程, 杀掉进程且不允许重启</p><h3 id="goingCallback-run"><a href="#goingCallback-run" class="headerlink" title="goingCallback.run()"></a>goingCallback.run()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br></pre></td></tr></table></figure><p>这个goingCallback是在startOtherServices时传入的Callback</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Making services ready"</span>);</span><br><span class="line">                mSystemServiceManager.startBootPhase(</span><br><span class="line">                        SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"PhaseActivityManagerReady"</span>);</span><br><span class="line"></span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartObservingNativeCrashes"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 开始监听Native Crash</span></span><br><span class="line">                    mActivityManagerService.startObservingNativeCrashes();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"observing native crashes"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                    <span class="comment">//启动WebView</span></span><br><span class="line">                    Slog.i(TAG, <span class="string">"WebViewFactory preparation"</span>);</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"WebViewFactoryPreparation"</span>);</span><br><span class="line">                    mWebViewUpdateService.prepareWebViewInSystemServer();</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartSystemUI"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 启动SystemUI</span></span><br><span class="line">                    startSystemUi(context);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"starting System UI"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">              </span><br><span class="line">              </span><br><span class="line">                <span class="comment">// 执行一系列服务的systemReady方法</span></span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"MakeNetworkScoreReady"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkScoreF != <span class="keyword">null</span>) networkScoreF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Score Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"MakeNetworkManagementServiceReady"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkManagementF != <span class="keyword">null</span>) networkManagementF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Managment Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"MakeNetworkStatsServiceReady"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkStatsF != <span class="keyword">null</span>) networkStatsF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Stats Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"MakeNetworkPolicyServiceReady"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkPolicyF != <span class="keyword">null</span>) networkPolicyF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Network Policy Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"MakeConnectivityServiceReady"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connectivityF != <span class="keyword">null</span>) connectivityF.systemReady();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"making Connectivity Service ready"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">              </span><br><span class="line">                <span class="comment">// Watchdog开始工作</span></span><br><span class="line">                Watchdog.getInstance().start();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//各种系统服务启动</span></span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"PhaseThirdPartyAppsCanStart"</span>);</span><br><span class="line">                mSystemServiceManager.startBootPhase(</span><br><span class="line">                        SystemService.PHASE_THIRD_PARTY_APPS_CAN_START);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (locationF != <span class="keyword">null</span>) locationF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying Location Service running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (countryDetectorF != <span class="keyword">null</span>) countryDetectorF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying CountryDetectorService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkTimeUpdaterF != <span class="keyword">null</span>) networkTimeUpdaterF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying NetworkTimeService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (commonTimeMgmtServiceF != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        commonTimeMgmtServiceF.systemRunning();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying CommonTimeManagementService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (atlasF != <span class="keyword">null</span>) atlasF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying AssetAtlasService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// TODO(BT) Pass parameter to input manager</span></span><br><span class="line">                    <span class="keyword">if</span> (inputManagerF != <span class="keyword">null</span>) inputManagerF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying InputManagerService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (telephonyRegistryF != <span class="keyword">null</span>) telephonyRegistryF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying TelephonyRegistry running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mediaRouterF != <span class="keyword">null</span>) mediaRouterF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying MediaRouterService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mmsServiceF != <span class="keyword">null</span>) mmsServiceF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying MmsService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (networkScoreF != <span class="keyword">null</span>) networkScoreF.systemRunning();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    reportWtf(<span class="string">"Notifying NetworkScoreService running"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个过程会</p><ul><li>启动监听Native Crash</li><li>启动WebView，并且会创建进程，这是zygote正式创建的第一个进程</li><li>启动SystemUI</li><li>启动WatchDog</li><li>执行一系列服务的systemRunning方法启动</li></ul><h3 id="after-goingCallback"><a href="#after-goingCallback" class="headerlink" title="after goingCallback"></a>after goingCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//回调所有SystemService的onStartUser()方法</span></span><br><span class="line">mSystemServiceManager.startUser(currentUserId);</span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="comment">// Only start up encryption-aware persistent apps; once user is</span></span><br><span class="line">    <span class="comment">// unlocked we'll come back around and start unaware apps</span></span><br><span class="line">    <span class="comment">// 启动 persistent app</span></span><br><span class="line">    startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start up initial activity.</span></span><br><span class="line">    mBooting = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// Enable home activity for system user, so that the system can always boot</span></span><br><span class="line">    <span class="keyword">if</span> (UserManager.isSplitSystemUser()) &#123;</span><br><span class="line">        ComponentName cName = <span class="keyword">new</span> ComponentName(mContext, SystemUserHomeActivity.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AppGlobals.getPackageManager().setComponentEnabledSetting(cName,</span><br><span class="line">                    PackageManager.COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>,</span><br><span class="line">                    UserHandle.USER_SYSTEM);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// 启动 Home Activity</span></span><br><span class="line">    startHomeActivityLocked(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (AppGlobals.getPackageManager().hasSystemUidErrors()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"UIDs on the system are inconsistent, you need to wipe your"</span></span><br><span class="line">                    + <span class="string">" data partition or your device will be unstable."</span>);</span><br><span class="line">            mUiHandler.obtainMessage(SHOW_UID_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Build.isBuildConsistent()) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Build fingerprint is not consistent, warning user"</span>);</span><br><span class="line">        mUiHandler.obtainMessage(SHOW_FINGERPRINT_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//system发送广播USER_STARTED</span></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTED);</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line">        broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID,</span><br><span class="line">                currentUserId);</span><br><span class="line">        <span class="comment">//system发送广播USER_STARTING</span></span><br><span class="line">        intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTING);</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line">        broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">new</span> IIntentReceiver.Stub() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String data,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span></span></span><br><span class="line"><span class="function">                            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123;INTERACT_ACROSS_USERS&#125;, AppOpsManager.OP_NONE,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Failed sending first user broadcasts"</span>, t);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 恢复显示Top Activity</span></span><br><span class="line">    mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">    mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该阶段主要功能：</p><ul><li>回调所有SystemService的onStartUser()方法；</li><li>启动persistent app（常驻内存应用）；</li><li>启动home Activity;</li><li>发送广播USER_STARTED和USER_STARTING；</li><li>恢复栈顶Activity;</li><li>发送广播USER_SWITCHED；</li></ul><h2 id="startHomeActivityLocked"><a href="#startHomeActivityLocked" class="headerlink" title="startHomeActivityLocked"></a>startHomeActivityLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">               &amp;&amp; mTopAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// We are running in factory test mode, but unable to find</span></span><br><span class="line">           <span class="comment">// the factory test app, so just sit around displaying the</span></span><br><span class="line">           <span class="comment">// error message and don't try to start anything.</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//home intent有CATEGORY_HOME</span></span><br><span class="line">       Intent intent = getHomeIntent();</span><br><span class="line">       ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">       <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">           intent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">           <span class="comment">// Don't do this if the home app is currently being</span></span><br><span class="line">           <span class="comment">// instrumented.</span></span><br><span class="line">           aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</span><br><span class="line">           aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line">           ProcessRecord app = getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                   aInfo.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">           <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instrumentationClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">               intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">                <span class="comment">//启动桌面Activity</span></span><br><span class="line">               mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Slog.wtf(TAG, <span class="string">"No home screen found for "</span> + intent, <span class="keyword">new</span> Throwable());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AMS启动流程</p><ol><li>SystemServer调用Lifecycle 创建ActivityManagerService实例</li><li>AMS构造函数初始化变量，创建ActivityManager，ActivityManager:kill，android.ui，CpuTracker线程</li><li>setSystemProcess：注册AMS、meminfo、cpuinfo等服务到ServiceManager</li><li>installSystemProviderss，加载SettingsProvider</li><li>启动SystemUIService，再调用一系列服务的systemReady()方法</li><li>启动HomeActivity(Launcher)</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;AMS应该是作为Android开发经常听到的一个系统服务了，它是系统的引导服务，Android中&lt;strong&gt;最核心的服务&lt;/strong&gt;，主要负责系统中四大组件的&lt;strong&gt;启动、切换、调度及应用进程的管理和调度&lt;/strong&gt;等工作，在Android系统中非常
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="AMS" scheme="http://yoursite.com/tags/AMS/"/>
    
  </entry>
  
  <entry>
    <title>Android系统开发-APK安装包名或签名信息认证</title>
    <link href="http://yoursite.com/2021/03/25/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91-APK%E5%AE%89%E8%A3%85%E5%8C%85%E5%90%8D%E5%92%8C%E7%AD%BE%E5%90%8D%E5%8F%8C%E9%87%8D%E8%AE%A4%E8%AF%81/"/>
    <id>http://yoursite.com/2021/03/25/Android系统开发-APK安装包名和签名双重认证/</id>
    <published>2021-03-25T03:23:03.000Z</published>
    <updated>2021-03-30T03:27:46.742Z</updated>
    
    <content type="html"><![CDATA[<p>最近在做定制系统，完成了一个功能，安装应用的时候要对APK的包名或签名进行双重认证。</p><p>当APK安装的时候首先判断签名信息SHA-1是否和我们预设的相同，如果不同，表示这个APK不是我们签名的应用，然后再判断这个应用的包名，如果这个包名不在我们预设的包名列表中，就可以确认这个APK为非法安装，返回安装失败信息。</p><h2 id="数据库和Provider"><a href="#数据库和Provider" class="headerlink" title="数据库和Provider"></a>数据库和Provider</h2><p>关于这个包名列表，我们是将数据存储到数据库中，在SettingsProvide中增加自己的数据库，并使用ContentProvider向外提供数据。</p><p><code>frameworks/base/packages/SettingsProvider/src/com/android/providers/settings/MyDatabaseHelper</code></p><p>DatabaseHelper类，创建数据库</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.providers.settings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.database.Cursor;</span><br><span class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteDatabase;</span><br><span class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteOpenHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDatabaseHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_NAME = <span class="string">"My.db"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATABASE_VERSION = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TABLE_NAME = <span class="string">"package_name"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyDatabaseHelper instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyDatabaseHelper <span class="title">getInstance</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> MyDatabaseHelper(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDatabaseHelper</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, DATABASE_NAME, <span class="keyword">null</span>, DATABASE_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">        String creatTable = <span class="string">"create table "</span> + TABLE_NAME + <span class="string">"(_id integer PRIMARY KEY AUTOINCREMENT, packageName varchar(40))"</span>;</span><br><span class="line">        db.execSQL(creatTable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后要将数据库通过ContentProvider向外提供</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.android.providers.settings;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.ContentProvider;</span><br><span class="line"><span class="keyword">import</span> android.content.ContentUris;</span><br><span class="line"><span class="keyword">import</span> android.content.ContentValues;</span><br><span class="line"><span class="keyword">import</span> android.content.UriMatcher;</span><br><span class="line"><span class="keyword">import</span> android.database.Cursor;</span><br><span class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteDatabase;</span><br><span class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteQueryBuilder;</span><br><span class="line"><span class="keyword">import</span> android.net.Uri;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher sUriMatcher;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MATCH_PACKAGE_NAME = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"My"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri CONTENT_URI_FIRST = Uri.parse(<span class="string">"content://"</span> + AUTHORITY + <span class="string">"/package_name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        sUriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line">        sUriMatcher.addURI(AUTHORITY, <span class="string">"package_name"</span>, MATCH_PACKAGE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyDatabaseHelper mDbHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建数据库</span></span><br><span class="line">        mDbHelper = MyDatabaseHelper.getInstance(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        SQLiteQueryBuilder queryBuilder = <span class="keyword">new</span> SQLiteQueryBuilder();</span><br><span class="line">        <span class="keyword">switch</span> (sUriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MATCH_PACKAGE_NAME:</span><br><span class="line">                queryBuilder.setTables(MyDatabaseHelper.TABLE_NAME);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknow URI: "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        SQLiteDatabase db = mDbHelper.getReadableDatabase();</span><br><span class="line">        Cursor cursor = queryBuilder.query(db, projection, selection, selectionArgs, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> cursor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues contentValues)</span> </span>&#123;</span><br><span class="line">        SQLiteDatabase db = mDbHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">switch</span> (sUriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MATCH_PACKAGE_NAME: &#123;</span><br><span class="line">                <span class="keyword">long</span> rowID = db.insert(MyDatabaseHelper.TABLE_NAME, <span class="keyword">null</span>, contentValues);</span><br><span class="line">                <span class="keyword">if</span> (rowID &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Uri retUri = ContentUris.withAppendedId(CONTENT_URI_FIRST, rowID);</span><br><span class="line">                    <span class="keyword">return</span> retUri;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown URI "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        SQLiteDatabase db = mDbHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(sUriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MATCH_PACKAGE_NAME:</span><br><span class="line">                count = db.delete(MyDatabaseHelper.TABLE_NAME, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknow URI :"</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        SQLiteDatabase db = mDbHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span>(sUriMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> MATCH_PACKAGE_NAME:</span><br><span class="line">                count = db.update(MyDatabaseHelper.TABLE_NAME, values, selection, selectionArgs);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknow URI : "</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后将provider注册到manifest文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:name</span>=<span class="string">"MyProvider"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:authorities</span>=<span class="string">"My"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:multiprocess</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:exported</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:singleUser</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:initOrder</span>=<span class="string">"100"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>然后就可以通过ContentProvider向数据库插入或查询包名列表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertPMSVerifyPackageName</span><span class="params">(List&lt;String&gt; verifyPackageNameList)</span></span>&#123;</span><br><span class="line">ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line">resolver.delete(Uri.parse(<span class="string">"content://My/package_name"</span>), <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; verifyPackageNameList.size(); i++) &#123;</span><br><span class="line">    ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">    values.put(<span class="string">"_id"</span>, i);</span><br><span class="line">    values.put(<span class="string">"packageName"</span>, verifyPackageNameList.get(i));</span><br><span class="line">    resolver.insert(Uri.parse(<span class="string">"content://My/package_name"</span>), values);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="签名-SHA-1"><a href="#签名-SHA-1" class="headerlink" title="签名 SHA-1"></a>签名 SHA-1</h2><p>对于应用的签名认证，我们使用签名信息的SHA-1值来做签名判断，当APK解析后的SHA-1和我们预设的值相同，就表明应用签名认证通过。</p><p>预设的SHA-1值使用SystemProperties设置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSignatureSHA1</span><span class="params">(String sha1)</span></span>&#123;</span><br><span class="line">      SystemProperties.set(PROPERTIES_MY_SIGNATURE,sha1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="安装认证"><a href="#安装认证" class="headerlink" title="安装认证"></a>安装认证</h2><p>应用安装会在PMS服务中进行解析，我们就在installPackageLI函数中对APK进行认证。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">String customSignature = SystemProperties.get(PROPERTIES_MY_SIGNATURE, DEFALT_SHA1);<span class="comment">//默认SHA-1</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(customSignature)) &#123;</span><br><span class="line">    <span class="keyword">final</span> Signature[] signatures = pkg.mSignatures;</span><br><span class="line">    <span class="comment">//这里只拿了apk的第一个签名，有可能APK会有双重签名的情况，这里可以改成循环判断</span></span><br><span class="line">    <span class="keyword">if</span> (!getFingerprint(signatures[<span class="number">0</span>], <span class="string">"SHA-1"</span>).equals(customSignature)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!fetchAllContacts().contains(pkgName))&#123;</span><br><span class="line">    res.setError(PackageManager.INSTALL_FAILED_VERIFICATION_FAILURE,<span class="string">"Signature verification failed"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取签名信息的SHA-1</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFingerprint</span><span class="params">(Signature signature, String hashAlgorithm)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (signature == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MessageDigest digest = MessageDigest.getInstance(hashAlgorithm);</span><br><span class="line">            <span class="keyword">return</span> toHexadecimalString(digest.digest(signature.toByteArray()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">                    <span class="comment">// ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询数据库中预设的包名</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">fetchAllContacts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; pkgList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        ContentResolver contentResolver = mContext.getContentResolver();</span><br><span class="line">        Cursor cursor = contentResolver.query(Uri.parse(<span class="string">"content://My/package_name"</span>),<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        cursor.getCount();</span><br><span class="line">        <span class="keyword">while</span>(cursor.moveToNext()) &#123;</span><br><span class="line">            Log.e(TAG,<span class="string">"pkg name:"</span>+cursor.getString(<span class="number">1</span>));</span><br><span class="line">            pkgList.add(cursor.getString(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cursor.close();</span><br><span class="line">        <span class="keyword">return</span> pkgList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果APK签名信息错误，并且它的包名又没在预设的包名列表中，应用就无法安装，返回INSTALL_FAILED_VERIFICATION_FAILURE信息。否则走正常安装流程。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近在做定制系统，完成了一个功能，安装应用的时候要对APK的包名或签名进行双重认证。&lt;/p&gt;
&lt;p&gt;当APK安装的时候首先判断签名信息SHA-1是否和我们预设的相同，如果不同，表示这个APK不是我们签名的应用，然后再判断这个应用的包名，如果这个包名不在我们预设的包名列表中，
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="PMS" scheme="http://yoursite.com/tags/PMS/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-包管理机制(三)PMS处理APK安装</title>
    <link href="http://yoursite.com/2021/03/24/Android%E5%8C%85%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6-%E4%B8%89-PMS%E5%A4%84%E7%90%86APK%E5%AE%89%E8%A3%85/"/>
    <id>http://yoursite.com/2021/03/24/Android包管理机制-三-PMS处理APK安装/</id>
    <published>2021-03-24T11:47:19.000Z</published>
    <updated>2021-04-28T09:24:13.016Z</updated>
    
    <content type="html"><![CDATA[<p>在上一篇中，我们知道了最终调用了PMS的installStage方法安装APK，接下来进入PMS处理APK的流程。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installStage</span><span class="params">(String packageName, File stagedDir, String stagedCid,</span></span></span><br><span class="line"><span class="function"><span class="params">            IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,</span></span></span><br><span class="line"><span class="function"><span class="params">            String installerPackageName, <span class="keyword">int</span> installerUid, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">            Certificate[][] certificates)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">        <span class="keyword">final</span> InstallParams params = <span class="keyword">new</span> InstallParams(origin, <span class="keyword">null</span>, observer,</span><br><span class="line">                sessionParams.installFlags, installerPackageName, sessionParams.volumeUuid,</span><br><span class="line">                verificationInfo, user, sessionParams.abiOverride,</span><br><span class="line">                sessionParams.grantedRuntimePermissions, certificates);</span><br><span class="line">        params.setTraceMethod(<span class="string">"installStage"</span>).setTraceCookie(System.identityHashCode(params));</span><br><span class="line">        msg.obj = params;</span><br><span class="line"></span><br><span class="line">        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installStage"</span>,</span><br><span class="line">                System.identityHashCode(msg.obj));</span><br><span class="line">        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                System.identityHashCode(msg.obj));</span><br><span class="line"></span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在installStage函数中创建了类型为INIT_COPY的消息，接下来看看对INIT_COPY的处理</p><h2 id="1-对INIT-COPY的消息的处理"><a href="#1-对INIT-COPY的消息的处理" class="headerlink" title="1.对INIT_COPY的消息的处理"></a>1.对INIT_COPY的消息的处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doHandleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                    HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">                    <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"init_copy idx="</span> + idx + <span class="string">": "</span> + params);</span><br><span class="line">                    <span class="comment">// If a bind was already initiated we dont really</span></span><br><span class="line">                    <span class="comment">// need to do anything. The pending install</span></span><br><span class="line">                    <span class="comment">// will be processed later on.</span></span><br><span class="line">                    <span class="comment">//mBound用于标识是否绑定了服务，默认值为false</span></span><br><span class="line">                    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                                System.identityHashCode(mHandler));</span><br><span class="line">                        <span class="comment">// If this is the only one pending we might</span></span><br><span class="line">                        <span class="comment">// have to bind to the service again.</span></span><br><span class="line">                        <span class="comment">//如果没有绑定服务，重新绑定，connectToService方法内部如果绑定成功会将mBound置为true</span></span><br><span class="line">                        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">                            params.serviceError();</span><br><span class="line">                            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                                    System.identityHashCode(mHandler));</span><br><span class="line">                            <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</span><br><span class="line">                                        params.traceCookie);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Once we bind to the service, the first</span></span><br><span class="line">                            <span class="comment">// pending request will be processed.</span></span><br><span class="line">                            <span class="comment">//绑定服务成功，将请求添加到mPendingInstalls中，等待处理</span></span><br><span class="line">                            mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//服务已经绑定成功，添加到mPendingInstalls中</span></span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        <span class="comment">// Already bound to the service. Just make</span></span><br><span class="line">                        <span class="comment">// sure we trigger off processing the first request.</span></span><br><span class="line">                        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 发送MCS_BOUND消息</span></span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure><p>mBound用于标识是否绑定了DefaultContainerService，默认值为false。DefaultContainerService是用于检查和复制可移动文件的服务，这是一个比较耗时的操作，因此DefaultContainerService没有和PMS运行在同一进程中，它运行在com.android.defcontainer进程，通过IMediaContainerService和PMS进行IPC通信。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java#PackageHandler</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connectToService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"Trying to bind to"</span> +</span><br><span class="line">                  <span class="string">" DefaultContainerService"</span>);</span><br><span class="line">          Intent service = <span class="keyword">new</span> Intent().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">          Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">          <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">                  Context.BIND_AUTO_CREATE, UserHandle.SYSTEM)) &#123;<span class="comment">//1</span></span><br><span class="line">              Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">              mBound = <span class="keyword">true</span>;<span class="comment">//2</span></span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>bindServiceAsUser方法的处理逻辑和我们调用bindService是类似的，服务建立连接后，会调用onServiceConnected方法(传入了mDefContainerConn)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> DefaultContainerConnection mDefContainerConn =</span><br><span class="line">            <span class="keyword">new</span> DefaultContainerConnection();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title">ServiceConnection</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceConnected"</span>);</span><br><span class="line">            IMediaContainerService imcs =</span><br><span class="line">                IMediaContainerService.Stub.asInterface(service);</span><br><span class="line">            mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceDisconnected"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在onServiceConnected中，又发送了MCS_BOUND消息，并将IMediaContainerService实例传递出去。</p><h2 id="2-对MCS-BOUND类型的消息的处理"><a href="#2-对MCS-BOUND类型的消息的处理" class="headerlink" title="2.对MCS_BOUND类型的消息的处理"></a>2.对MCS_BOUND类型的消息的处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_bound"</span>);</span><br><span class="line">        <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">          mContainerService = (IMediaContainerService) msg.obj; <span class="comment">//1</span></span><br><span class="line">          Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                              System.identityHashCode(mHandler));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123; <span class="comment">//2</span></span><br><span class="line">          <span class="keyword">if</span> (!mBound) &#123; <span class="comment">//3</span></span><br><span class="line">            <span class="comment">// Something seriously wrong since we are not bound and we are not</span></span><br><span class="line">            <span class="comment">// waiting for connection. Bail out.</span></span><br><span class="line">            Slog.e(TAG, <span class="string">"Cannot bind to media container service"</span>);</span><br><span class="line">            <span class="keyword">for</span> (HandlerParams params : mPendingInstalls) &#123;</span><br><span class="line">              <span class="comment">// Indicate service bind error</span></span><br><span class="line">              params.serviceError();</span><br><span class="line">              Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                                  System.identityHashCode(params));</span><br><span class="line">              <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER,</span><br><span class="line">                                    params.traceMethod, params.traceCookie);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingInstalls.clear();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Waiting to connect to media container service"</span>);<span class="comment">//4</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123; <span class="comment">//5</span></span><br><span class="line">          HandlerParams params = mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                                System.identityHashCode(params));</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"startCopy"</span>);</span><br><span class="line">            <span class="keyword">if</span> (params.startCopy()) &#123; <span class="comment">//6</span></span><br><span class="line">              <span class="comment">// We are done...  look for more work or to</span></span><br><span class="line">              <span class="comment">// go idle.</span></span><br><span class="line">              <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                          <span class="string">"Checking for more work or unbind..."</span>);</span><br><span class="line">              <span class="comment">// Delete pending install</span></span><br><span class="line">              <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//如果APK安装成功，删除本次安装请求</span></span><br><span class="line">                mPendingInstalls.remove(<span class="number">0</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                  <span class="comment">//如果没有安装请求了，发送解绑服务的请求</span></span><br><span class="line">                  <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                              <span class="string">"Posting delayed MCS_UNBIND"</span>);</span><br><span class="line">                  removeMessages(MCS_UNBIND);</span><br><span class="line">                  Message ubmsg = obtainMessage(MCS_UNBIND);</span><br><span class="line">                  <span class="comment">// Unbind after a little delay, to avoid</span></span><br><span class="line">                  <span class="comment">// continual thrashing.</span></span><br><span class="line">                  sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// There are more pending requests in queue.</span></span><br><span class="line">                <span class="comment">// Just post MCS_BOUND message to trigger processing</span></span><br><span class="line">                <span class="comment">// of next pending install.</span></span><br><span class="line">                <span class="comment">//如果还有其他的安装请求，接着发送MCS_BOUND消息继续处理剩余的安装请求 </span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                            <span class="string">"Posting MCS_BOUND for next work"</span>);</span><br><span class="line">                mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Should never happen ideally.</span></span><br><span class="line">          Slog.w(TAG, <span class="string">"Empty queue"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>在注释1处获取MediaContainerService服务对象，在这里就表示是接收到了onServiceConnected中发出的MCS_BOUND消息。如果msg.obj != null，表示从INIT_COPY消息处理中发出的。</p><p>注释2成立表示INIT_COPY消息处理中发出MCS_BOUND，注释3判断是否已经绑定服务，如果!mBound为true，而在发出MCS_BOUND消息之前的各种操作中就已经判断是否绑定服务，没有绑定的话就已经去connectToService()，这里说明发生异常情况，开始处理异常情况。如果!mBound为false，说明已经调用了connectToService方法去绑定服务，注释4打印日志提示等待服务绑定。</p><p>如果注释2不成立就进入注释5处判断，如果安装请求数不大于0，就会打印日志，提示空队列。</p><p>否则取出安装请求队列第一个请求HandlerParams ，如果HandlerParams 不为null就会调用注释6处的HandlerParams的startCopy方法，用于开始复制APK的流程。</p><h2 id="3-复制APK"><a href="#3-复制APK" class="headerlink" title="3.复制APK"></a>3.复制APK</h2><p>HandlerParams是PMS中的抽象类，它的实现类为PMS的内部类InstallParams。HandlerParams的startCopy方法如下所示。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java#HandlerParams</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> res;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"startCopy "</span> + mUser + <span class="string">": "</span> + <span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">//startCopy方法尝试的次数，超过了4次，就放弃这个安装请求</span></span><br><span class="line">                <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Failed to invoke remote methods on default container service. Giving up"</span>);</span><br><span class="line">                    mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">                    handleServiceError();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//开始处理复制</span></span><br><span class="line">                    handleStartCopy();</span><br><span class="line">                    res = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Posting install MCS_RECONNECT"</span>);</span><br><span class="line">                mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">                res = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            handleReturnCode();</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>handleStartCopy()的实现在InstallParams类中</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java#InstallParams</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">           <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//确定APK的安装位置。</span></span><br><span class="line">  <span class="comment">//onSd：安装到SD卡， onInt：内部存储即Data分区，ephemeral：安装到临时存储（Instant Apps安装）</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> onInt = (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> ephemeral = (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">           PackageInfoLite pkgLite = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">               <span class="comment">// // APK不能同时安装在SD卡和Data分区</span></span><br><span class="line">               Slog.w(TAG, <span class="string">"Conflicting flags specified for installing on both internal and external"</span>);</span><br><span class="line">               ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onSd &amp;&amp; ephemeral) &#123;</span><br><span class="line">               <span class="comment">////安装标志冲突，Instant Apps不能安装到SD卡中</span></span><br><span class="line">               Slog.w(TAG,  <span class="string">"Conflicting flags specified for installing ephemeral on external"</span>);</span><br><span class="line">               ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//获取APK的少量的信息</span></span><br><span class="line">               pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags,</span><br><span class="line">                       packageAbiOverride);</span><br><span class="line">             ......</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">               <span class="comment">//判断安装的位置</span></span><br><span class="line">               <span class="keyword">int</span> loc = pkgLite.recommendedInstallLocation;</span><br><span class="line">               <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_ALREADY_EXISTS;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_APK) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_APK;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_MEDIA_UNAVAILABLE) &#123;</span><br><span class="line">                   ret = PackageManager.INSTALL_FAILED_MEDIA_UNAVAILABLE;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// Override with defaults if needed.</span></span><br><span class="line">                   loc = installLocationPolicy(pkgLite);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据InstallParams创建InstallArgs对象</span></span><br><span class="line">           <span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line">           mArgs = args;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                 .....</span><br><span class="line">                   </span><br><span class="line">                 ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           mRet = ret;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>首先是通过IMediaContainerService跨进程调用DefaultContainerService的getMinimalPackageInfo方法，该方法轻量解析APK并得到APK的少量信息，轻量解析的原因是这里不需要得到APK的全部信息，APK的少量信息会封装到PackageInfoLite中。然后确认APK的安装位置，最后创建InstallArgs对象。</p><p>InstallArgs 是一个抽象类，定义了APK的安装逻辑，比如复制和重命名APK等，它有3个子类，MoveInstallArgs、AsecInstallArgs、FileInstallArgs，都被定义在PMS中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallArgs <span class="title">createInstallArgs</span><span class="params">(InstallParams params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (params.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MoveInstallArgs(params);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installOnExternalAsec(params.installFlags) || params.isForwardLocked()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AsecInstallArgs(params);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FileInstallArgs(params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>其中FileInstallArgs用于处理安装到非ASEC的存储空间的APK，也就是内部存储空间（Data分区），AsecInstallArgs用于处理安装到ASEC中（mnt/asec）即SD卡中的APK。MoveInstallArgs用于处理已安装APK的移动的逻辑。</p><p>这里以FileInstallArgs为例，调用copyApk会直接调到FileInstallArgs的doCopyApk方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCopyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral = (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//创建临时文件存储目录</span></span><br><span class="line">                <span class="keyword">final</span> File tempDir =</span><br><span class="line">                        mInstallerService.allocateStageDirLegacy(volumeUuid, isEphemeral);<span class="comment">//1</span></span><br><span class="line">                codeFile = tempDir;</span><br><span class="line">                resourceFile = tempDir;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed to create copy file: "</span> + e);</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> IParcelFileDescriptorFactory target = <span class="keyword">new</span> IParcelFileDescriptorFactory.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">open</span><span class="params">(String name, <span class="keyword">int</span> mode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid filename: "</span> + name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> File file = <span class="keyword">new</span> File(codeFile, name);</span><br><span class="line">                        <span class="keyword">final</span> FileDescriptor fd = Os.open(file.getAbsolutePath(),</span><br><span class="line">                                O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">                        Os.chmod(file.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> ParcelFileDescriptor(fd);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException(<span class="string">"Failed to open: "</span> + e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">            ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);<span class="comment">//2</span></span><br><span class="line">            <span class="keyword">if</span> (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to copy package"</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>doCopyApk函数的工作就是在/data/app下创建临时文件夹，以sessionId为临时文件夹名 ，例如/data/app/{sessionId}.tmp/base.apk将APK复制到这个文件夹下，一般命名为base.apk</p><h2 id="4-安装APK"><a href="#4-安装APK" class="headerlink" title="4.安装APK"></a>4.安装APK</h2><p>我们返回startCopy方法中，复制完成后调用handleReturnCode()，这个方法会调用到InstallParams的handleReturnCode方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleReturnCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// If mArgs is null, then MCS couldn't be reached. When it</span></span><br><span class="line">        <span class="comment">// reconnects, it will try again to install. At that point, this</span></span><br><span class="line">        <span class="comment">// will succeed.</span></span><br><span class="line">        <span class="keyword">if</span> (mArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">Slog.d(TAG,<span class="string">"welen:"</span> + <span class="string">"handleReturnCode"</span>);</span><br><span class="line">            processPendingInstall(mArgs, mRet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">        mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">Slog.d(TAG,<span class="string">"welen:"</span> + <span class="string">"processPendingInstall"</span>);</span><br><span class="line">                mHandler.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">                 <span class="comment">// Result object to be returned</span></span><br><span class="line">                PackageInstalledInfo res = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">                res.setReturnCode(currentStatus);</span><br><span class="line">                res.uid = -<span class="number">1</span>;</span><br><span class="line">                res.pkg = <span class="keyword">null</span>;</span><br><span class="line">                res.removedInfo = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                    <span class="comment">//安装前准备</span></span><br><span class="line">                    args.doPreInstall(res.returnCode);</span><br><span class="line">                    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                        installPackageTracedLI(args, res);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 安装后处理</span></span><br><span class="line">                    args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">                &#125;</span><br><span class="line">              ......</span><br></pre></td></tr></table></figure><p>在processPendingInstall中进行安装前检查，确认安装环境，如果不可靠会清除复制的APK文件，安装完成后doPostInstall，如果安装不成功，删除掉安装相关的目录与文件。</p><p>接下来看下 <strong>installPackageTracedLI()</strong>，内部调用<strong>installPackageLI</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageTracedLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installPackage"</span>);</span><br><span class="line">            installPackageLI(args, res);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>installPackageLI</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">   PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">        pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">        pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"parsePackage"</span>);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 解析APK</span></span><br><span class="line">            pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            res.setError(<span class="string">"Failed parse during installPackageLI"</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">          </span><br><span class="line">  pp = <span class="keyword">null</span>;</span><br><span class="line">        String oldCodePath = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> systemApp = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">           <span class="comment">// 判断APK是否存在，存在replace = true</span></span><br><span class="line">           <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">                String oldName = mSettings.mRenamedPackages.get(pkgName);</span><br><span class="line">                <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; pkg.mOriginalPackages.contains(oldName)</span><br><span class="line">                        &amp;&amp; mPackages.containsKey(oldName)) &#123;</span><br><span class="line">                    <span class="comment">// This package is derived from an original package,</span></span><br><span class="line">                    <span class="comment">// and this device has been updating from that original</span></span><br><span class="line">                    <span class="comment">// name.  We must continue using the original name, so</span></span><br><span class="line">                    <span class="comment">// rename the new package here.</span></span><br><span class="line">                    pkg.setPackageName(oldName);</span><br><span class="line">                    pkgName = pkg.packageName;</span><br><span class="line">                    replace = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replacing existing renamed package: oldName="</span></span><br><span class="line">                            + oldName + <span class="string">" pkgName="</span> + pkgName);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPackages.containsKey(pkgName)) &#123;</span><br><span class="line">                    <span class="comment">// This package, under its official name, already exists</span></span><br><span class="line">                    <span class="comment">// on the device; we should replace it.</span></span><br><span class="line">                    replace = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replace existing pacakge: "</span> + pkgName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">          <span class="comment">//查看Settings中是否存有要安装的APK的信息，如果有就获取签名信息</span></span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//检查签名信息</span></span><br><span class="line">                <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(ps, scanFlags)) &#123;</span><br><span class="line">                    <span class="comment">//新APK与老APK签名不一致</span></span><br><span class="line">                    <span class="keyword">if</span> (!checkUpgradeKeySetLP(ps, pkg)) &#123;</span><br><span class="line">                        res.setError(INSTALL_FAILED_UPDATE_INCOMPATIBLE, <span class="string">"Package "</span></span><br><span class="line">                                + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                                + <span class="string">"previously installed version"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//确保签名一致</span></span><br><span class="line">                        verifySignaturesLP(ps, pkg);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                        res.setError(e.error, e.getMessage());</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          <span class="keyword">int</span> N = pkg.permissions.size();</span><br><span class="line">          <span class="comment">//遍历每个权限，对权限进行处理</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                PackageParser.Permission perm = pkg.permissions.get(i);</span><br><span class="line">                BasePermission bp = mSettings.mPermissions.get(perm.info.name);</span><br><span class="line">            ......</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">  f (systemApp) &#123;</span><br><span class="line">            <span class="keyword">if</span> (onExternal) &#123;</span><br><span class="line">                <span class="comment">// //系统APP不能在SD卡上替换安装</span></span><br><span class="line">                res.setError(INSTALL_FAILED_INVALID_INSTALL_LOCATION,</span><br><span class="line">                        <span class="string">"Cannot install updates to system apps on sdcard"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ephemeral) &#123;</span><br><span class="line">                <span class="comment">// 系统APP不能被Instant App替换</span></span><br><span class="line">                res.setError(INSTALL_FAILED_EPHEMERAL_INVALID,</span><br><span class="line">                        <span class="string">"Cannot update a system app with an ephemeral app"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line">          </span><br><span class="line">        <span class="comment">//重命名临时文件</span></span><br><span class="line">  <span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, <span class="string">"Failed rename"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (PackageFreezer freezer = freezePackageForInstall(pkgName, installFlags,</span><br><span class="line">                <span class="string">"installPackageLI"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">                <span class="comment">//替换安装</span></span><br><span class="line">                replacePackageLIF(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</span><br><span class="line">                        installerPackageName, res);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//安装新APK</span></span><br><span class="line">                installNewPackageLIF(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</span><br><span class="line">                        args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//更新应用程序所属的用户</span></span><br><span class="line">                res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>installPackageLI方法的代码这里截取主要的部分，主要做了几件事：</p><ol><li>创建PackageParser解析APK。</li><li>检查APK是否存在，如果存在就获取此前没被改名前的包名并赋值给PackageParser.Package类型的pkg，将标志位replace置为true表示是替换安装。</li><li>如果Settings中保存有要安装的APK的信息，说明此前安装过该APK，则需要校验APK的签名信息，确保安全的进行替换。</li><li>将临时文件重新命名，比如前面提到的/data/app/{sessionId}.tmp/base.apk，重命名为/data/app/包名-1/base.apk。这个新命名的包名会带上一个数字后缀1，每次升级一个已有的App，这个数字会不断的累加(/data/app/com.test.settings-2/base.apk)。</li><li>系统APP的更新安装会有两个限制，一个是系统APP不能在SD卡上替换安装，另一个是系统APP不能被Instant App替换。</li><li>根据replace来做区分，如果是替换安装就会调用replacePackageLIF方法，其方法内部还会对系统APP和非系统APP进行区分处理，如果是新安装APK会调用installNewPackageLIF方法。</li></ol><p>我们看一下安装新APK的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Install a non-existing package.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installNewPackageLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> scanFlags, UserHandle user, String installerPackageName, String volumeUuid,</span></span></span><br><span class="line"><span class="function"><span class="params">           PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">       Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installNewPackage"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Remember this for later, in case we need to rollback this install</span></span><br><span class="line">       String pkgName = pkg.packageName;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//扫描APK</span></span><br><span class="line">           PackageParser.Package newPackage = scanPackageTracedLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                   System.currentTimeMillis(), user);</span><br><span class="line"><span class="comment">//更新Settings信息</span></span><br><span class="line">           updateSettingsLI(newPackage, installerPackageName, <span class="keyword">null</span>, res, user);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">             <span class="comment">//安装成功后，为新安装的应用程序准备数据</span></span><br><span class="line">               prepareAppDataAfterInstallLIF(newPackage);</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//安装失败则删除APK</span></span><br><span class="line">               deletePackageLIF(pkgName, UserHandle.ALL, <span class="keyword">false</span>, <span class="keyword">null</span>,</span><br><span class="line">                       PackageManager.DELETE_KEEP_DATA, res.removedInfo, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">           res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="4-1-scanPackageTracedLI"><a href="#4-1-scanPackageTracedLI" class="headerlink" title="4.1 scanPackageTracedLI"></a>4.1 scanPackageTracedLI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageTracedLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">                    <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">     </span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Scan the parent</span></span><br><span class="line">            scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags, currentTime, user);</span><br><span class="line">            <span class="comment">// Scan the children</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">                scanPackageLI(childPkg, policyFlags,</span><br><span class="line">                        scanFlags, currentTime, user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> scanPackageTracedLI(pkg, policyFlags, scanFlags, currentTime, user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scannedPkg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                    currentTime, user);</span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">                destroyAppDataLIF(pkg, UserHandle.USER_ALL,</span><br><span class="line">                        StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">                destroyAppProfilesLIF(pkg, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-1-scanPackageDirtyLI"><a href="#4-1-1-scanPackageDirtyLI" class="headerlink" title="4.1.1 scanPackageDirtyLI"></a>4.1.1 scanPackageDirtyLI</h4><p>最终调用到<code>scanPackageDirtyLI</code>方法，这个函数也是非常长，干了很多事，无论通过什么方式安装APK，最终都会调用到这里进行APK的实际安装过程。</p><p>主要就是将App中的provider，service，receiver，activity全都保存到PMS的成员集合类中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">            <span class="comment">// // 处理provider</span></span><br><span class="line">            <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                        p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mProviders.addProvider(p);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 处理service</span></span><br><span class="line">            N = pkg.services.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">                s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                        s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mServices.addService(s);</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 处理receiver</span></span><br><span class="line">            N = pkg.receivers.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">                a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                        a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理activity</span></span><br><span class="line">            N = pkg.activities.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">                a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                        a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">                mActivities.addActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理permissionGroup权限组</span></span><br><span class="line">            N = pkg.permissionGroups.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">                PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">                <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">                <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                    mPermissionGroups.put(pg.info.name, pg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理permission</span></span><br><span class="line">            N = pkg.permissions.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line"></span><br><span class="line">                p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                    p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                    <span class="comment">// Warn for a permission in an unknown group.</span></span><br><span class="line">                    <span class="keyword">if</span> (p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                        p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                                : mSettings.mPermissions;</span><br><span class="line">                BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Allow system apps to redefine non-system permissions</span></span><br><span class="line">                <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                            &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                    <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// It's a built-in permission and no owner, take ownership now</span></span><br><span class="line">                            bp.packageSetting = pkgSetting;</span><br><span class="line">                            bp.perm = p;</span><br><span class="line">                            bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                            bp.sourcePackage = p.info.packageName;</span><br><span class="line">                            p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                            String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                    + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                            bp = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                            BasePermission.TYPE_NORMAL);</span><br><span class="line">                    permissionMap.put(p.info.name, bp);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                            || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                        <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                                || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                            bp.packageSetting = pkgSetting;</span><br><span class="line">                            bp.perm = p;</span><br><span class="line">                            bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                            bp.sourcePackage = p.info.packageName;</span><br><span class="line">                            p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    r.append(<span class="string">' '</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                                r.append(p.info.name);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                    + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                    + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                    + tree.sourcePackage);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                                + bp.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                    r.append(p.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                    bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理instrumentation</span></span><br><span class="line">            N = pkg.instrumentation.size();</span><br><span class="line">            r = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">                a.info.packageName = pkg.applicationInfo.packageName;</span><br><span class="line">                a.info.sourceDir = pkg.applicationInfo.sourceDir;</span><br><span class="line">                a.info.publicSourceDir = pkg.applicationInfo.publicSourceDir;</span><br><span class="line">                a.info.splitSourceDirs = pkg.applicationInfo.splitSourceDirs;</span><br><span class="line">                a.info.splitPublicSourceDirs = pkg.applicationInfo.splitPublicSourceDirs;</span><br><span class="line">                a.info.dataDir = pkg.applicationInfo.dataDir;</span><br><span class="line">                a.info.deviceProtectedDataDir = pkg.applicationInfo.deviceProtectedDataDir;</span><br><span class="line">                a.info.credentialProtectedDataDir = pkg.applicationInfo.credentialProtectedDataDir;</span><br><span class="line"></span><br><span class="line">                a.info.nativeLibraryDir = pkg.applicationInfo.nativeLibraryDir;</span><br><span class="line">                a.info.secondaryNativeLibraryDir = pkg.applicationInfo.secondaryNativeLibraryDir;</span><br><span class="line">                mInstrumentation.put(a.getComponentName(), a);</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">            <span class="comment">// 处理protectedBroadcast</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">                N = pkg.protectedBroadcasts.size();</span><br><span class="line">                <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置时间戳为扫描文件的时间戳</span></span><br><span class="line">            pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line">           ......</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-updateSettingsLI"><a href="#4-2-updateSettingsLI" class="headerlink" title="4.2 updateSettingsLI"></a>4.2 updateSettingsLI</h3><p>更新Settings信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSettingsLI</span><span class="params">(PackageParser.Package newPackage, String installerPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[] allUsers, PackageInstalledInfo res, UserHandle user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Update the parent package setting</span></span><br><span class="line">        updateSettingsInternalLI(newPackage, installerPackageName, allUsers, res.origUsers,</span><br><span class="line">                res, user);</span><br><span class="line">        <span class="comment">// Update the child packages setting</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (newPackage.childPackages != <span class="keyword">null</span>)</span><br><span class="line">                ? newPackage.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPackage = newPackage.childPackages.get(i);</span><br><span class="line">            PackageInstalledInfo childRes = res.addedChildPackages.get(childPackage.packageName);</span><br><span class="line">            updateSettingsInternalLI(childPackage, installerPackageName, allUsers,</span><br><span class="line">                    childRes.origUsers, childRes, user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSettingsInternalLI</span><span class="params">(PackageParser.Package newPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">         String installerPackageName, <span class="keyword">int</span>[] allUsers, <span class="keyword">int</span>[] installedForUsers,</span></span></span><br><span class="line"><span class="function"><span class="params">         PackageInstalledInfo res, UserHandle user)</span> </span>&#123;</span><br><span class="line">     Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>);</span><br><span class="line"></span><br><span class="line">     String pkgName = newPackage.packageName;</span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         <span class="comment">//write settings. the installStatus will be incomplete at this stage.</span></span><br><span class="line">         <span class="comment">//note that the new package setting would have already been</span></span><br><span class="line">         <span class="comment">//added to mPackages. It hasn't been persisted yet.</span></span><br><span class="line">         mSettings.setInstallStatus(pkgName, PackageSettingBase.PKG_INSTALL_INCOMPLETE);</span><br><span class="line">         Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"writeSettings"</span>);</span><br><span class="line">         mSettings.writeLPr();</span><br><span class="line">         Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         updatePermissionsLPw(newPackage.packageName, newPackage,</span><br><span class="line">                 UPDATE_PERMISSIONS_REPLACE_PKG | (newPackage.permissions.size() &gt; <span class="number">0</span></span><br><span class="line">                         ? UPDATE_PERMISSIONS_ALL : <span class="number">0</span>));</span><br><span class="line">         <span class="comment">// For system-bundled packages, we assume that installing an upgraded version</span></span><br><span class="line">         <span class="comment">// of the package implies that the user actually wants to run that new code,</span></span><br><span class="line">         <span class="comment">// so we enable the package.</span></span><br><span class="line">         PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">int</span> userId = user.getIdentifier();</span><br><span class="line">         <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (isSystemApp(newPackage)) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                     Slog.d(TAG, <span class="string">"Implicitly enabling system package on upgrade: "</span> + pkgName);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">// Enable system package for requested users</span></span><br><span class="line">                 <span class="keyword">if</span> (res.origUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="keyword">for</span> (<span class="keyword">int</span> origUserId : res.origUsers) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (userId == UserHandle.USER_ALL || userId == origUserId) &#123;</span><br><span class="line">                             ps.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                     origUserId, installerPackageName);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">// Also convey the prior install/uninstall state</span></span><br><span class="line">                 <span class="keyword">if</span> (allUsers != <span class="keyword">null</span> &amp;&amp; installedForUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="keyword">for</span> (<span class="keyword">int</span> currentUserId : allUsers) &#123;</span><br><span class="line">                         <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(</span><br><span class="line">                                 installedForUsers, currentUserId);</span><br><span class="line">                         <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                             Slog.d(TAG, <span class="string">"    user "</span> + currentUserId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                         &#125;</span><br><span class="line">                         ps.setInstalled(installed, currentUserId);</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="comment">// these install state changes will be persisted in the</span></span><br><span class="line">                     <span class="comment">// upcoming call to mSettings.writeLPr().</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// It's implied that when a user requests installation, they want the app to be</span></span><br><span class="line">             <span class="comment">// installed and enabled.</span></span><br><span class="line">             <span class="keyword">if</span> (userId != UserHandle.USER_ALL) &#123;</span><br><span class="line">                 ps.setInstalled(<span class="keyword">true</span>, userId);</span><br><span class="line">                 ps.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, userId, installerPackageName);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         res.name = pkgName;</span><br><span class="line">         res.uid = newPackage.applicationInfo.uid;</span><br><span class="line">         res.pkg = newPackage;</span><br><span class="line">         mSettings.setInstallStatus(pkgName, PackageSettingBase.PKG_INSTALL_COMPLETE);</span><br><span class="line">         mSettings.setInstallerPackageName(pkgName, installerPackageName);</span><br><span class="line">         res.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line">         <span class="comment">//to update install status</span></span><br><span class="line">         Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"writeSettings"</span>);</span><br><span class="line">         mSettings.writeLPr();</span><br><span class="line">         Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><code>mSettings.writeLPr();</code>会将APK的相关信息转为XML写到data/system/packages.xml中，并在data/system/packages.list增加APP信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           FileOutputStream fstr = <span class="keyword">new</span> FileOutputStream(mSettingsFilename);</span><br><span class="line">           BufferedOutputStream str = <span class="keyword">new</span> BufferedOutputStream(fstr);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//XmlSerializer serializer = XmlUtils.serializerInstance();</span></span><br><span class="line">           XmlSerializer serializer = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">           serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">           serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">           serializer.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">           serializer.startTag(<span class="keyword">null</span>, <span class="string">"packages"</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mVersion.size(); i++) &#123;</span><br><span class="line">               <span class="keyword">final</span> String volumeUuid = mVersion.keyAt(i);</span><br><span class="line">               <span class="keyword">final</span> VersionInfo ver = mVersion.valueAt(i);</span><br><span class="line"></span><br><span class="line">               serializer.startTag(<span class="keyword">null</span>, TAG_VERSION);</span><br><span class="line">               XmlUtils.writeStringAttribute(serializer, ATTR_VOLUME_UUID, volumeUuid);</span><br><span class="line">               XmlUtils.writeIntAttribute(serializer, ATTR_SDK_VERSION, ver.sdkVersion);</span><br><span class="line">               XmlUtils.writeIntAttribute(serializer, ATTR_DATABASE_VERSION, ver.databaseVersion);</span><br><span class="line">               XmlUtils.writeStringAttribute(serializer, ATTR_FINGERPRINT, ver.fingerprint);</span><br><span class="line">               serializer.endTag(<span class="keyword">null</span>, TAG_VERSION);</span><br><span class="line">           &#125;</span><br><span class="line">         </span><br><span class="line">           ......</span><br><span class="line">         </span><br><span class="line">           mKeySetManagerService.writeKeySetManagerServiceLPr(serializer);</span><br><span class="line"></span><br><span class="line">           serializer.endTag(<span class="keyword">null</span>, <span class="string">"packages"</span>);</span><br><span class="line"></span><br><span class="line">           serializer.endDocument();</span><br><span class="line"></span><br><span class="line">           str.flush();</span><br><span class="line">           FileUtils.sync(fstr);</span><br><span class="line">           str.close();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// New settings successfully written, old ones are no longer</span></span><br><span class="line">           <span class="comment">// needed.</span></span><br><span class="line">           mBackupSettingsFilename.delete();</span><br><span class="line">           FileUtils.setPermissions(mSettingsFilename.toString(),</span><br><span class="line">                   FileUtils.S_IRUSR|FileUtils.S_IWUSR</span><br><span class="line">                   |FileUtils.S_IRGRP|FileUtils.S_IWGRP,</span><br><span class="line">                   -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">           writeKernelMappingLPr();</span><br><span class="line">           <span class="comment">/// package.list</span></span><br><span class="line">           writePackageListLPr();</span><br><span class="line">           writeAllUsersPackageRestrictionsLPr();</span><br><span class="line">           writeAllRuntimePermissionsLPr();</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><code>data/system/packages.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.My.app.test"</span> <span class="attr">codePath</span>=<span class="string">"/data/app/com.My.app.test-1"</span> <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.My.app.test-1/lib"</span> <span class="attr">primaryCpuAbi</span>=<span class="string">"armeabi-v7a"</span> <span class="attr">publicFlags</span>=<span class="string">"944291396"</span> <span class="attr">privateFlags</span>=<span class="string">"0"</span> <span class="attr">ft</span>=<span class="string">"177d1e84078"</span> <span class="attr">it</span>=<span class="string">"177d1e863ca"</span> <span class="attr">ut</span>=<span class="string">"177d1e863ca"</span> <span class="attr">version</span>=<span class="string">"1"</span> <span class="attr">userId</span>=<span class="string">"10072"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"9"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>data/system/packages.list</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.My.app.test 10072 0 /data/user/0/com.My.app.test<span class="built_in"> default </span>3002,3003,3001</span><br></pre></td></tr></table></figure><h3 id="4-3-prepareAppDataAfterInstallLIF"><a href="#4-3-prepareAppDataAfterInstallLIF" class="headerlink" title="4.3 prepareAppDataAfterInstallLIF"></a>4.3 prepareAppDataAfterInstallLIF</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataAfterInstallLIF</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">        ......</span><br><span class="line">        prepareAppDataLIF(pkg, user.id, flags);</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        prepareAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            prepareAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">       <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">       <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(app.uid);</span><br><span class="line"></span><br><span class="line">       Preconditions.checkNotNull(app.seinfo);</span><br><span class="line"></span><br><span class="line">       ......</span><br><span class="line">       mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                   appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">       </span><br><span class="line">       .....</span><br><span class="line">       prepareAppDataContentsLeafLIF(pkg, userId, flags);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataContentsLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">        <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Create a native library symlink only if we have native libraries</span></span><br><span class="line">            <span class="comment">// and if the native libraries are 32 bit libraries. We do not provide</span></span><br><span class="line">            <span class="comment">// this symlink for 64 bit libraries.</span></span><br><span class="line">            <span class="keyword">if</span> (app.primaryCpuAbi != <span class="keyword">null</span> &amp;&amp; !VMRuntime.is64BitAbi(app.primaryCpuAbi)) &#123;</span><br><span class="line">                <span class="keyword">final</span> String nativeLibPath = app.nativeLibraryDir;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mInstaller.linkNativeLibraryDirectory(volumeUuid, packageName,</span><br><span class="line">                            nativeLibPath, userId);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Failed to link native for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在整个流程中可以看到主要就两段：<code>mInstaller.createAppData</code>和 <code>mInstaller.linkNativeLibraryDirectory</code>，mInstaller我们之前有了解过，Installer继承自SystemService，和PMS、AMS一样是系统的服务(引导服务)，PMS很多的操作都是由Installer来完成的。它会与位于nativie层的installd守护进程通过socket通信来完成具体的操作。关于守护进程installd就在下一篇了解。</p><p>参考：</p><p><a href="http://liuwangshu.cn/tags/Android%E5%8C%85%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">BATcoder - 刘望舒</a></p><p><a href="http://gityuan.com/2016/11/06/packagemanager/" target="_blank" rel="noopener">Gityuan</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在上一篇中，我们知道了最终调用了PMS的installStage方法安装APK，接下来进入PMS处理APK的流程。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;frameworks/base/services/core/java/com/android/server/pm/PackageMa
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="PMS" scheme="http://yoursite.com/tags/PMS/"/>
    
  </entry>
  
  <entry>
    <title>Android JNI开发-实际项目开发总结(回调函数)</title>
    <link href="http://yoursite.com/2021/03/19/Android-JNI%E5%BC%80%E5%8F%91-%E5%AE%9E%E9%99%85%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2021/03/19/Android-JNI开发-实际项目开发总结/</id>
    <published>2021-03-19T01:09:34.000Z</published>
    <updated>2021-03-19T06:10:16.556Z</updated>
    
    <content type="html"><![CDATA[<p>这篇文章想要介绍一下我之前做的一个真实项目，感觉比较有意思，记录一下。</p><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>这个项目比较有特点的是项目的主要业务逻辑由C语言开发同事完成，在他的SO库中去做初始化、网络操作、数据库存储、硬件设备操作等等的逻辑，我这边Android主要就是调用他的接口结合界面完成业务。</p><p>但是由于我们在第三方硬件设备操作，而第三方只提供了Android的SDK，在C层面无法调用，所以硬件操作的接口也需要由我进行封装，提供操作的接口(<a href="https://david1840.github.io/2018/12/23/C%E8%AF%AD%E8%A8%80%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">回调函数，不了解的请看这里</a>)给C开发同事调用。这样就形成了下面的结构：</p><p><img src="/2021/03/19/Android-JNI开发-实际项目开发总结/jni1.png" alt=""></p><p>我在APP初始化的时候，就将所有有关界面操作和硬件操作的函数以参数的形式传给SO。SO库中实际业务中，如果需要修改界面，比如要显示黑名单下载进度，就调用传入downloadBlackListCallBack函数，这个函数中会以JNI反射的方式调用到Java层代码，再由Java层代码实现进度的更新。硬件操作接口同样的道理。</p><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="SO库函数定义"><a href="#SO库函数定义" class="headerlink" title="SO库函数定义"></a>SO库函数定义</h3><p>在一步中除了正常的参数传入，重要的就是传入回调函数了。</p><p>和同事做好协商，以显示进度为例，在SO库对外提供的函数中有这样一个函数，用来设置进度回调。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">APi_SetProgressCallback</span><span class="params">(Processfun Callback)</span></span>;</span><br></pre></td></tr></table></figure><p>在他的头文件中Processfun的定义如下，要求我们传入两个int类型的值，第一个参数为已下载数量，第二个参数为总数量。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*Processfun)</span><span class="params">(<span class="keyword">int</span>,<span class="keyword">int</span>)</span></span>;</span><br></pre></td></tr></table></figure><p>这个是SO库中要求的函数形式，接下来我们就要写自己的实现函数</p><h3 id="Java层实现"><a href="#Java层实现" class="headerlink" title="Java层实现"></a>Java层实现</h3><p>我们首先实现一个Java层真正去控制进度显示的函数。</p><p>在JNIController类中实现函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 黑名单下载进度展示</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> downloaded 已下载黑名单条数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> all        总黑名单条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">downloadBlackListCallBack</span><span class="params">(<span class="keyword">int</span> downloaded, <span class="keyword">int</span> all)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        intent.setAction(DOWNLOAD_BLACKLIST_ACTION);</span><br><span class="line">        intent.putExtra(BLACKLIST_DOWNLOADED, downloaded);</span><br><span class="line">        intent.putExtra(BLACKLIST_ALL, all);</span><br><span class="line">        Application.getInstance().sendBroadcast(intent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>入参和上面定义的一样，已下载数量和总数量，当函数调用后通过广播的方式将传入的数量发送出去，广播接收器去修改界面。</p><h3 id="JNI层实现"><a href="#JNI层实现" class="headerlink" title="JNI层实现"></a>JNI层实现</h3><p>然后要从JNI层以反射的方式调用Java层的downloadBlackListCallBack函数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">downloadBlackListCallBack</span><span class="params">(<span class="keyword">int</span> downloaded, <span class="keyword">int</span> all)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">downloadBlackListCallBack</span><span class="params">(<span class="keyword">int</span> downloaded, <span class="keyword">int</span> all)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> status = (*local_jvm)-&gt;AttachCurrentThread(local_jvm, &amp;env, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"env is null"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jclass jclass1 = (*env)-&gt;FindClass(env, <span class="string">"com/.../controller/JNIController"</span>);</span><br><span class="line">    <span class="keyword">if</span> (jclass1 == <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"jclass1 = 0"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jmethodID downloadProcess = (*env)-&gt;GetMethodID(env, jclass1, <span class="string">"downloadBlackListCallBack"</span>,</span><br><span class="line">                                                    <span class="string">"(II)V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (downloadProcess == <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"methodID == 0"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用Java层，downloaded, all参数传入</span></span><br><span class="line">    (*env)-&gt;CallVoidMethod(env, local_object, downloadProcess, downloaded, all);</span><br><span class="line">  </span><br><span class="line">    (*env)-&gt;DeleteLocalRef(env, jclass1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在JNI中入参也是一致的形式，再通过反射的方式调用Java层代码，将downloaded, all参数传给Java函数。</p><h3 id="传递函数"><a href="#传递函数" class="headerlink" title="传递函数"></a>传递函数</h3><p>JNI层的downloadBlackListCallBack函数已经写好了，最后就在初始化的函数中，调用SO库提供的<code>APi_SetProgressCallback(Processfun Callback)</code>将函数以参数的形式传入</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APi_SetProgressCallback(downloadBlackListCallBack);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Processfun processFun = null;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">APi_SetProgressCallback</span><span class="params">(Processfun Callback)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(Callback!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">processFun = Callback;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//业务代码中</span></span><br><span class="line">processFun(<span class="number">10</span>,<span class="number">100</span>);</span><br></pre></td></tr></table></figure><p>这样就是一个完整的流程了。</p><p>设备的硬件操作接口也是同样的逻辑完成。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整体而言，主要还是用了C语言回调函数的方式，将上层的操作封装成接口，交给底层逻辑自己控制，这样比较灵活，双方的代码量也减少，就是需要在前期双方梳理好需要的接口，完工！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这篇文章想要介绍一下我之前做的一个真实项目，感觉比较有意思，记录一下。&lt;/p&gt;
&lt;h2 id=&quot;项目介绍&quot;&gt;&lt;a href=&quot;#项目介绍&quot; class=&quot;headerlink&quot; title=&quot;项目介绍&quot;&gt;&lt;/a&gt;项目介绍&lt;/h2&gt;&lt;p&gt;这个项目比较有特点的是项目的主要业务逻
      
    
    </summary>
    
      <category term="Android开发" scheme="http://yoursite.com/categories/Android%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="JNI" scheme="http://yoursite.com/tags/JNI/"/>
    
      <category term="NDK" scheme="http://yoursite.com/tags/NDK/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-生成OTA增量升级包</title>
    <link href="http://yoursite.com/2021/03/17/Android%E7%B3%BB%E7%BB%9F-%E7%94%9F%E6%88%90OTA%E5%A2%9E%E9%87%8F%E5%8D%87%E7%BA%A7%E5%8C%85/"/>
    <id>http://yoursite.com/2021/03/17/Android系统-生成OTA增量升级包/</id>
    <published>2021-03-17T10:18:39.000Z</published>
    <updated>2021-03-18T11:01:46.859Z</updated>
    
    <content type="html"><![CDATA[<p>在这里记录一下系统OTA差量包的生成流程。</p><p>在系统完成整编之后：</p><h3 id="1-make-otapackage"><a href="#1-make-otapackage" class="headerlink" title="1. make otapackage"></a>1. make otapackage</h3><p>make otapackage完成了三件事情</p><ul><li>重新对system.img文件进行了打包；</li><li>生成差分资源包，路径为out/target/product/<product-name>/obj/PACKAGING/target_files_intermedias/<product-name>-target_files.zip，差分资源包用于生成整包和差分包；</product-name></product-name></li><li>生成OTA整包，路径为out/target/product/<product-name>/<product-name>-ota.zip</product-name></product-name></li></ul><p>全量包</p><p><img src="/2021/03/17/Android系统-生成OTA增量升级包/ota1.png" alt=""></p><p>差分资源包</p><p><img src="/2021/03/17/Android系统-生成OTA增量升级包/ota2.png" alt=""></p><p>将差分资源包拷贝出来，命名为msm8953_64-target_file-A.zip</p><p>同样的方式在系统做出修改后，生成差分资源包，拷贝并命名为msm8953_64-target_file-B.zip</p><h3 id="2-制作OTA升级包"><a href="#2-制作OTA升级包" class="headerlink" title="2.制作OTA升级包"></a>2.制作OTA升级包</h3><p>在系统源码<code>build/tools/releasetools</code>路径下有制作OTA包的相关工具，执行以下命令生成OTA差量包。</p><p><code>./build/tools/releasetools/ota_from_target_files -n -i 原资源包 目标资源包 生成的差量包</code></p><p>例子如下：</p><p><code>./build/tools/releasetools/ota_from_target_files -n -i /Users/david/Downloads/msm8953_64-target_files-A.zip /Users/david/Downloads/msm8953_64-target_files-B.zip /Users/david/Downloads/system_ota.zip</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在这里记录一下系统OTA差量包的生成流程。&lt;/p&gt;
&lt;p&gt;在系统完成整编之后：&lt;/p&gt;
&lt;h3 id=&quot;1-make-otapackage&quot;&gt;&lt;a href=&quot;#1-make-otapackage&quot; class=&quot;headerlink&quot; title=&quot;1. make ota
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Android" scheme="http://yoursite.com/tags/Android/"/>
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="OTA增量" scheme="http://yoursite.com/tags/OTA%E5%A2%9E%E9%87%8F/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-包管理机制(二)PackageInstaller安装APK</title>
    <link href="http://yoursite.com/2021/03/17/Android%E5%8C%85%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6-%E4%BA%8C-PackageInstaller%E5%AE%89%E8%A3%85APK/"/>
    <id>http://yoursite.com/2021/03/17/Android包管理机制-二-PackageInstaller安装APK/</id>
    <published>2021-03-17T04:03:03.000Z</published>
    <updated>2021-04-28T09:24:52.361Z</updated>
    
    <content type="html"><![CDATA[<p>APK的安装有很多方式，应用商城下载、文件浏览器安装、adb命令安装，我们以文件浏览器为例。</p><p>将一个APK文件放到SD卡目录下，文件浏览器显示apk文件。</p><p>当我们点击APK文件时，文件浏览器根据文件的后缀(.apk)解析，执行startActivity，调起packageinstaller.PackageInstallerActivity。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActivityManager: START u0 &#123;<span class="attribute">act</span>=android.intent.action.VIEW <span class="attribute">dat</span>=file:///storage/emulated/0/com.dewmobile.kuaiya.apk <span class="attribute">typ</span>=application/vnd.android.package-archive <span class="attribute">flg</span>=0x88000 <span class="attribute">cmp</span>=com.android.packageinstaller/.PackageInstallerActivity&#125; <span class="keyword">from</span> uid 10032 on display 0</span><br></pre></td></tr></table></figure><h3 id="PackageInstallerActivity"><a href="#PackageInstallerActivity" class="headerlink" title="PackageInstallerActivity"></a>PackageInstallerActivity</h3><p>PackageInstallerActivity这个类的主要作用是显示安装弹窗，对APK进行解析，判断是否允许未知来源安装，判断应用权限，等待用户安装。</p><p><code>packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (v == mOk) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mOkCanInstall || mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                    mInstaller.setPermissionsResult(mSessionId, <span class="keyword">true</span>);</span><br><span class="line">                    clearCachedApkIfNeededAndFinish();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    startInstall(); <span class="comment">//开始安装</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mScrollView.pageScroll(View.FOCUS_DOWN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v == mCancel) &#123;</span><br><span class="line">            <span class="comment">// Cancel and finish</span></span><br><span class="line">            setResult(RESULT_CANCELED);</span><br><span class="line">            <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                mInstaller.setPermissionsResult(mSessionId, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            clearCachedApkIfNeededAndFinish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后用户点击安装按钮，就会调用startInstall()函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Start subactivity to actually install the application</span></span><br><span class="line">     Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">     newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO,</span><br><span class="line">             mPkgInfo.applicationInfo);</span><br><span class="line">     newIntent.setData(mPackageURI);</span><br><span class="line">     newIntent.setClass(<span class="keyword">this</span>, InstallAppProgress.class);<span class="comment">//</span></span><br><span class="line">     String installerPackageName = getIntent().getStringExtra(</span><br><span class="line">             Intent.EXTRA_INSTALLER_PACKAGE_NAME);</span><br><span class="line">  </span><br><span class="line">     ......</span><br><span class="line">       </span><br><span class="line">     <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"downloaded app uri="</span>+mPackageURI);</span><br><span class="line">     startActivity(newIntent);</span><br><span class="line">     finish();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>startInstall函数用于跳转到InstallAppProgress这个Activity，关闭PackageInstallerActivity。</p><h3 id="InstallAppProgress"><a href="#InstallAppProgress" class="headerlink" title="InstallAppProgress"></a>InstallAppProgress</h3><p>InstallAppProgress主要用于展示安装界面、向PMS发送包信息， 处理回调。</p><p><code>packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallAppProgress.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">        Intent intent = getIntent();</span><br><span class="line">        mAppInfo = intent.getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO);</span><br><span class="line">        mPackageURI = intent.getData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String scheme = mPackageURI.getScheme();</span><br><span class="line">        <span class="keyword">if</span> (scheme != <span class="keyword">null</span> &amp;&amp; !<span class="string">"file"</span>.equals(scheme) &amp;&amp; !<span class="string">"package"</span>.equals(scheme)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unexpected scheme "</span> + scheme);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启安装线程</span></span><br><span class="line">        mInstallThread = <span class="keyword">new</span> HandlerThread(<span class="string">"InstallThread"</span>);</span><br><span class="line">        mInstallThread.start();</span><br><span class="line">        mInstallHandler = <span class="keyword">new</span> Handler(mInstallThread.getLooper());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册安装监听</span></span><br><span class="line">        IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        intentFilter.addAction(BROADCAST_ACTION);</span><br><span class="line">        registerReceiver(</span><br><span class="line">                mBroadcastReceiver, intentFilter, BROADCAST_SENDER_PERMISSION, <span class="keyword">null</span> <span class="comment">/*scheduler*/</span>);</span><br><span class="line"></span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>InstallAppProgress中启动了一个HandlerThread，开启安装线程，注册了一个广播，这个广播用来监听系统返回的安装结果。</p><p>主要代码在在initView()函数中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> PackageInstaller.SessionParams params = <span class="keyword">new</span> PackageInstaller.SessionParams(</span><br><span class="line">        PackageInstaller.SessionParams.MODE_FULL_INSTALL);</span><br><span class="line">params.referrerUri = getIntent().getParcelableExtra(Intent.EXTRA_REFERRER);</span><br><span class="line">params.originatingUri = getIntent().getParcelableExtra(Intent.EXTRA_ORIGINATING_URI);</span><br><span class="line">params.originatingUid = getIntent().getIntExtra(Intent.EXTRA_ORIGINATING_UID,</span><br><span class="line">        UID_UNKNOWN);</span><br><span class="line"></span><br><span class="line">File file = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//解析安装包，设置安装位置，从AndroidManifest中获取</span></span><br><span class="line">    PackageLite pkg = PackageParser.parsePackageLite(file, <span class="number">0</span>);</span><br><span class="line">    params.setAppPackageName(pkg.packageName);</span><br><span class="line">    params.setInstallLocation(pkg.installLocation);</span><br><span class="line">    params.setSize(</span><br><span class="line">        PackageHelper.calculateInstalledSize(pkg, <span class="keyword">false</span>, params.abiOverride));</span><br><span class="line">&#125; <span class="keyword">catch</span> (PackageParser.PackageParserException e) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">"Cannot parse package "</span> + file + <span class="string">". Assuming defaults."</span>);</span><br><span class="line">    Log.e(TAG, <span class="string">"Cannot calculate installed size "</span> + file + <span class="string">". Try only apk size."</span>);</span><br><span class="line">    params.setSize(file.length());</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">"Cannot calculate installed size "</span> + file + <span class="string">". Try only apk size."</span>);</span><br><span class="line">    params.setSize(file.length());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mInstallHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//执行安装</span></span><br><span class="line">        doPackageStage(pm, params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doPackageStage</span><span class="params">(PackageManager pm, PackageInstaller.SessionParams params)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//初始化安装器</span></span><br><span class="line">       <span class="keyword">final</span> PackageInstaller packageInstaller = pm.getPackageInstaller();</span><br><span class="line">       PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> String packageLocation = mPackageURI.getPath();</span><br><span class="line">           <span class="keyword">final</span> File file = <span class="keyword">new</span> File(packageLocation);</span><br><span class="line">           <span class="comment">//获取sessionId</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> sessionId = packageInstaller.createSession(params);</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65536</span>];</span><br><span class="line">    <span class="comment">//获取session</span></span><br><span class="line">           session = packageInstaller.openSession(sessionId);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> InputStream in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> sizeBytes = file.length();</span><br><span class="line">           <span class="comment">// 根据这个session回话, 获取一个OutPutstream, 然后将文件写入到这个OutPutStream中</span></span><br><span class="line">           <span class="keyword">final</span> OutputStream out = session.openWrite(<span class="string">"PackageInstaller"</span>, <span class="number">0</span>, sizeBytes);</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">int</span> c;</span><br><span class="line">               <span class="keyword">while</span> ((c = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                   out.write(buffer, <span class="number">0</span>, c);</span><br><span class="line">                   <span class="keyword">if</span> (sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) c / (<span class="keyword">float</span>) sizeBytes);</span><br><span class="line">                       <span class="comment">//安装中</span></span><br><span class="line">                       session.addProgress(fraction);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               session.fsync(out);</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               IoUtils.closeQuietly(in);</span><br><span class="line">               IoUtils.closeQuietly(out);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Create a PendingIntent and use it to generate the IntentSender</span></span><br><span class="line">           Intent broadcastIntent = <span class="keyword">new</span> Intent(BROADCAST_ACTION);</span><br><span class="line">           PendingIntent pendingIntent = PendingIntent.getBroadcast(</span><br><span class="line">                   InstallAppProgress.<span class="keyword">this</span> <span class="comment">/*context*/</span>,</span><br><span class="line">                   sessionId,</span><br><span class="line">                   broadcastIntent,</span><br><span class="line">                   PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">           <span class="comment">//最后调用session的commit方法进行提交</span></span><br><span class="line">           session.commit(pendingIntent.getIntentSender());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           onPackageInstalled(PackageInstaller.STATUS_FAILURE);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           IoUtils.closeQuietly(session);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>最终广播接受安装结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> statusCode = intent.getIntExtra(</span><br><span class="line">                    PackageInstaller.EXTRA_STATUS, PackageInstaller.STATUS_FAILURE);</span><br><span class="line">            <span class="keyword">if</span> (statusCode == PackageInstaller.STATUS_PENDING_USER_ACTION) &#123;</span><br><span class="line">                context.startActivity((Intent)intent.getParcelableExtra(Intent.EXTRA_INTENT));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                onPackageInstalled(statusCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>应用安装的前期工作，用户可以看到的部分基本就这些，接下来的工作就都由Java框架层处理。</p><h3 id="Java框架层"><a href="#Java框架层" class="headerlink" title="Java框架层"></a>Java框架层</h3><p>上面最终调用PackageInstallerSession的commit方法，将安装APK的信息发给框架层。</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(IntentSender statusReceiver)</span> </span>&#123;</span><br><span class="line">      ......</span><br><span class="line">      mActiveCount.incrementAndGet();</span><br><span class="line">      <span class="keyword">final</span> PackageInstallObserverAdapter adapter = <span class="keyword">new</span> PackageInstallObserverAdapter(mContext,</span><br><span class="line">              statusReceiver, sessionId, mIsInstallerDeviceOwner, userId);</span><br><span class="line">      mHandler.obtainMessage(MSG_COMMIT, adapter.getBinder()).sendToTarget();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>commit函数中向Handler发送一个类型为MSG_COMMIT的消息，adapter.getBinder()会得到IPackageInstallObserver2观察者，处理消息逻辑如下：</p><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler.Callback mHandlerCallback = <span class="keyword">new</span> Handler.Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Cache package manager data without the lock held</span></span><br><span class="line">            <span class="keyword">final</span> PackageInfo pkgInfo = mPm.getPackageInfo(</span><br><span class="line">                    params.appPackageName, PackageManager.GET_SIGNATURES <span class="comment">/*flags*/</span>, userId);</span><br><span class="line">            <span class="keyword">final</span> ApplicationInfo appInfo = mPm.getApplicationInfo(</span><br><span class="line">                    params.appPackageName, <span class="number">0</span>, userId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRemoteObserver = (IPackageInstallObserver2) msg.obj;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    commitLocked(pkgInfo, appInfo);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String completeMsg = ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Commit of session "</span> + sessionId + <span class="string">" failed: "</span> + completeMsg);</span><br><span class="line">                    destroyInternal();</span><br><span class="line">                    dispatchSessionFinished(e.error, completeMsg, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">      mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">              installerPackageName, installerUid, user, mCertificates);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>在commitLocked方法中，调用PMS的installStage方法，这样逻辑就进入PMS中了。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>PackageInstaller安装APK的过程，简单来说就两步：</p><ol><li>将APK的信息通过IO流的形式写入到PackageInstaller.Session中。</li><li>调用PackageInstaller.Session的commit方法，将APK的信息交由PMS处理。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;APK的安装有很多方式，应用商城下载、文件浏览器安装、adb命令安装，我们以文件浏览器为例。&lt;/p&gt;
&lt;p&gt;将一个APK文件放到SD卡目录下，文件浏览器显示apk文件。&lt;/p&gt;
&lt;p&gt;当我们点击APK文件时，文件浏览器根据文件的后缀(.apk)解析，执行startActiv
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Android" scheme="http://yoursite.com/tags/Android/"/>
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>Android系统-包管理机制(一)PMS服务启动</title>
    <link href="http://yoursite.com/2021/03/17/Android%E5%8C%85%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6-%E4%B8%80-PMS%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8/"/>
    <id>http://yoursite.com/2021/03/17/Android包管理机制-一-PMS服务启动/</id>
    <published>2021-03-17T04:00:59.000Z</published>
    <updated>2021-04-28T09:24:15.364Z</updated>
    
    <content type="html"><![CDATA[<p>PackageManagerService(简称PMS)，是Android系统中核心服务之一，管理着所有跟package相关的工作，常见的比如安装、卸载应用。 </p><h2 id="SyetemServer处理"><a href="#SyetemServer处理" class="headerlink" title="SyetemServer处理"></a>SyetemServer处理</h2><p>SystemServer启动过程中启动服务</p><p><code>frameworks/base/services/java/com/android/server/SystemServer.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//创建消息Looper</span></span><br><span class="line">         Looper.prepareMainLooper();</span><br><span class="line">        <span class="comment">//加载了动态库libandroid_servers.so</span></span><br><span class="line">        System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line">        performPendingShutdown();</span><br><span class="line">        <span class="comment">// 创建系统的Context</span></span><br><span class="line">        createSystemContext();</span><br><span class="line">        <span class="comment">// 创建SystemServiceManager</span></span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">        mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);</span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">        SystemServerInitThreadPool.get();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">"StartServices"</span>);</span><br><span class="line">        <span class="comment">//启动引导服务</span></span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        <span class="comment">//启动核心服务</span></span><br><span class="line">        startCoreServices();</span><br><span class="line">        <span class="comment">//启动其他服务</span></span><br><span class="line">        startOtherServices();</span><br><span class="line">        SystemServerInitThreadPool.shutdown();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上面可以看出，系统服务分为了三种类型，分别是引导服务、核心服务和其他服务，本文要了解的PMS属于引导服务。</p><table><thead><tr><th>引导服务</th><th>作用</th></tr></thead><tbody><tr><td>Installer</td><td>系统安装apk时的一个服务类，启动完成Installer服务之后才能启动其他的系统服务</td></tr><tr><td>ActivityManagerService</td><td>负责四大组件的启动、切换、调度。</td></tr><tr><td>PowerManagerService</td><td>计算系统中和Power相关的计算，然后决策系统应该如何反应</td></tr><tr><td>LightsService</td><td>管理和显示背光LED</td></tr><tr><td>DisplayManagerService</td><td>用来管理所有显示设备</td></tr><tr><td>UserManagerService</td><td>多用户模式管理</td></tr><tr><td>SensorService</td><td>为系统提供各种感应器服务</td></tr><tr><td>PackageManagerService</td><td>用来对apk进行安装、解析、删除、卸载等等操作</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//启动installer服务</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    <span class="comment">// AMS</span></span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">            ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//POWERMS</span></span><br><span class="line">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"InitPowerManagement"</span>);</span><br><span class="line">    mActivityManagerService.initPowerManagement();</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    mSystemServiceManager.startService(LightsService.class);</span><br><span class="line">    mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only run "core" apps if we're encrypting the device.</span></span><br><span class="line">    <span class="comment">// 表示加密了设备，这时mOnlyCore的值为true，表示只运行“核心”程序，创建一个极简的启动环境。</span></span><br><span class="line">    String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line"></span><br><span class="line">    mIsAlarmBoot = SystemProperties.getBoolean(<span class="string">"ro.alarm_boot"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsAlarmBoot) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (RegionalizationEnvironment.isSupported()) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Regionalization Service"</span>);</span><br><span class="line">        RegionalizationService regionalizationService = <span class="keyword">new</span> RegionalizationService();</span><br><span class="line">        ServiceManager.addService(<span class="string">"regionalization"</span>, regionalizationService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the package manager.</span></span><br><span class="line">    <span class="comment">//启动PMS</span></span><br><span class="line">    traceBeginAndSlog(<span class="string">"StartPackageManagerService"</span>);</span><br><span class="line">    <span class="comment">//创建PMS</span></span><br><span class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    <span class="comment">// 表示PMS是否首次被启动，这个参数会在WMS创建时使用</span></span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">    mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">"config.disable_otadexopt"</span>,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartOtaDexOptService"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"starting OtaDexOptService"</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">"StartUserManagerService"</span>);</span><br><span class="line">    mSystemServiceManager.startService(UserManagerService.LifeCycle.class);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    AttributeCache.init(mSystemContext);</span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line">    startSensorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PMS"><a href="#PMS" class="headerlink" title="PMS"></a>PMS</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">       PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line">  <span class="comment">//初始化PMS</span></span><br><span class="line">       PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">               factoryTest, onlyCore);</span><br><span class="line">       m.enableSystemUserPackages();</span><br><span class="line">       <span class="comment">//将package服务注册到ServiceManager大管家</span></span><br><span class="line">       ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">       <span class="keyword">return</span> m;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>PMS的构造方法一共有700多行，在代码中，将PMS的构造流程分为了5个阶段，每个阶段会使用EventLog.writeEvent打印系统日志。</p><ol><li>BOOT_PROGRESS_PMS_START（开始阶段）</li><li>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START（扫描系统阶段）</li><li>BOOT_PROGRESS_PMS_DATA_SCAN_START（扫描Data分区阶段）</li><li>BOOT_PROGRESS_PMS_SCAN_END（扫描结束阶段）</li><li>BOOT_PROGRESS_PMS_READY（准备阶段）</li></ol><h3 id="1、开始阶段"><a href="#1、开始阶段" class="headerlink" title="1、开始阶段"></a>1、开始阶段</h3><p>BOOT_PROGRESS_PMS_START</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//打印开始日志</span></span><br><span class="line">     EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">             SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">         Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mContext = context;</span><br><span class="line"></span><br><span class="line">     mPermissionReviewRequired = context.getResources().getBoolean(</span><br><span class="line">             R.bool.config_permissionReviewRequired);</span><br><span class="line"></span><br><span class="line">     mFactoryTest = factoryTest;</span><br><span class="line">     mOnlyCore = onlyCore;</span><br><span class="line">     <span class="comment">//用于存储屏幕的相关信息</span></span><br><span class="line">     mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">     <span class="comment">//创建Settings对象 (1)</span></span><br><span class="line">     mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line">     <span class="comment">// 添加system, phone, log, nfc, bluetooth, shell这六种shareUserId到mSettings；</span></span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">     mInstaller = installer;</span><br><span class="line">     <span class="comment">//创建Dex优化工具类</span></span><br><span class="line">     mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">             <span class="string">"*dexopt*"</span>);</span><br><span class="line">     mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line">     mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">             FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line">     getDefaultDisplayMetrics(context, mMetrics);</span><br><span class="line">     <span class="comment">//得到全局系统配置信息</span></span><br><span class="line">     SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line">  <span class="comment">//获取全局的groupId </span></span><br><span class="line">     mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">  <span class="comment">//获取系统权限</span></span><br><span class="line">     mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">     mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"></span><br><span class="line">     mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//安装APK时需要的锁，保护所有对installd的访问。</span></span><br><span class="line">     <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">     <span class="comment">//更新APK时需要的锁，保护内存中已经解析的包信息等内容</span></span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         <span class="comment">//创建后台线程ServiceThread</span></span><br><span class="line">         mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">                 Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">         mHandlerThread.start();</span><br><span class="line">         <span class="comment">//创建PackageHandler绑定到ServiceThread的消息队列</span></span><br><span class="line">         mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">         mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">         <span class="comment">//将PackageHandler添加到Watchdog的检测集中</span></span><br><span class="line">         Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line"></span><br><span class="line">         mDefaultPermissionPolicy = <span class="keyword">new</span> DefaultPermissionGrantPolicy(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//在Data分区创建一些目录</span></span><br><span class="line">         File dataDir = Environment.getDataDirectory();</span><br><span class="line">         mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</span><br><span class="line">         mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);</span><br><span class="line">         mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);</span><br><span class="line">         mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</span><br><span class="line">         mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</span><br><span class="line">         mRegionalizationAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-regional"</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//创建多用户管理服务</span></span><br><span class="line">         sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</span><br><span class="line"></span><br><span class="line">         mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//解析packages.xml等文件的信息，保存到Settings的对应字段中。packages.xml中记录系统中所有安装的应用信息，包括基本信息、签名和权限。如果packages.xml有安装的应用信息，readLPw方法会返回true，mFirstBoot的值为false，说明PMS不是首次被启动。</span></span><br><span class="line">         mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure><p>在开始阶段，创建了很多PMS中的关键对象并赋值给PMS中的成员变量</p><h4 id="mSettings"><a href="#mSettings" class="headerlink" title="mSettings"></a>mSettings</h4><p>用于保存所有包的动态设置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Settings(Object lock) &#123;</span><br><span class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line"></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line"></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    mSystemDir.mkdirs(); <span class="comment">//创建/data/system</span></span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">           FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">           |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">           -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处mSystemDir是指目录<code>/data/system</code>，在该目录有以下5个文件：</p><table><thead><tr><th style="text-align:left">文件</th><th style="text-align:left">功能</th></tr></thead><tbody><tr><td style="text-align:left">packages.xml</td><td style="text-align:left">记录所有安装app的信息</td></tr><tr><td style="text-align:left">packages-backup.xml</td><td style="text-align:left">备份文件</td></tr><tr><td style="text-align:left">packages-stopped.xml</td><td style="text-align:left">记录系统被强制停止的文件</td></tr><tr><td style="text-align:left">packages-stopped-backup.xml</td><td style="text-align:left">备份文件</td></tr><tr><td style="text-align:left">packages.list</td><td style="text-align:left">记录应用的数据信息</td></tr></tbody></table><h4 id="mInstaller"><a href="#mInstaller" class="headerlink" title="mInstaller"></a>mInstaller</h4><p>Installer继承自SystemService，和PMS、AMS一样是系统的服务(引导服务)，PMS很多的操作都是由Installer来完成的，比如APK的安装和卸载。在Installer内部，通过socket与installd通信，（貌似8.0以上改成了IInstalld和installd进行Binder通信），由位于nativie层的installd来完成具体的操作。</p><h4 id="systemConfig"><a href="#systemConfig" class="headerlink" title="systemConfig"></a>systemConfig</h4><p>用于得到全局系统配置信息。比如系统的权限就可以通过SystemConfig来获取。</p><h4 id="mPackageDexOptimizer"><a href="#mPackageDexOptimizer" class="headerlink" title="mPackageDexOptimizer"></a>mPackageDexOptimizer</h4><p>Dex优化的工具类。</p><h4 id="mHandler（PackageHandler类型）"><a href="#mHandler（PackageHandler类型）" class="headerlink" title="mHandler（PackageHandler类型）"></a>mHandler（PackageHandler类型）</h4><p>PackageHandler继承自Handler，PMS通过PackageHandler驱动APK的复制和安装工作。<br>PackageHandler处理的消息队列如果过于繁忙，有可能导致系统卡住， 因此将它添加到Watchdog的监测集中。<br>Watchdog主要有两个用途，一个是定时检测系统关键服务（AMS和WMS等）是否可能发生死锁，还有一个是定时检测线程的消息队列是否长时间处于工作状态（可能阻塞等待了很长时间）。如果出现上述问题，Watchdog会将日志保存起来，必要时还会杀掉自己所在的进程，也就是SystemServer进程。</p><h4 id="sUserManager（UserManagerService类型）"><a href="#sUserManager（UserManagerService类型）" class="headerlink" title="sUserManager（UserManagerService类型）"></a>sUserManager（UserManagerService类型）</h4><p>多用户管理服务。</p><h3 id="2、扫描系统阶段"><a href="#2、扫描系统阶段" class="headerlink" title="2、扫描系统阶段"></a>2、扫描系统阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印扫描系统阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">                    startTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line"><span class="comment">// scanning install directories.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">  Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">  Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; allInstructionSets = InstructionSets.getAllInstructionSets();</span><br><span class="line"><span class="keyword">final</span> String[] dexCodeInstructionSets =</span><br><span class="line">  getDexCodeInstructionSets(</span><br><span class="line">  allInstructionSets.toArray(<span class="keyword">new</span> String[allInstructionSets.size()]));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Ensure all external libraries have had dexopt run on them.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> For now, we're compiling these system "shared libraries"</span></span><br><span class="line">  <span class="comment">// (and framework jars) into all available architectures. It's possible</span></span><br><span class="line">  <span class="comment">// to compile them only when we come across an app that uses them (there's</span></span><br><span class="line">  <span class="comment">// already logic for that in scanPackageLI) but that adds some complexity.</span></span><br><span class="line">  <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">    <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">      <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">      <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">        <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line">        <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">          lib, dexCodeInstructionSet,</span><br><span class="line">          getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">          <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line">        <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">          mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">               + e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在/system中创建framework目录</span></span><br><span class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// when upgrading from pre-M, promote system app permissions from install to runtime</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">  mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line">mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save off the names of pre-existing system packages prior to scanning; we don't</span></span><br><span class="line"><span class="comment">// want to automatically grant runtime permissions for new system apps</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">  Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">  <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">    PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">      mExistingSystemPackages.add(ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect vendor overlay packages. (Do this before scanning any apps.)</span></span><br><span class="line"><span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line"><span class="comment">// overlay packages if they reside in the right directory.</span></span><br><span class="line">String overlayThemeDir = SystemProperties.get(VENDOR_OVERLAY_THEME_PROPERTY);</span><br><span class="line"> <span class="comment">//扫描/vendor/overlay目录下的文件</span></span><br><span class="line"><span class="keyword">if</span> (!overlayThemeDir.isEmpty()) &#123;</span><br><span class="line">  scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR, overlayThemeDir), mDefParseFlags</span><br><span class="line">                  | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                  | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR), mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">//收集包名：/system/framework</span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">                scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collected privileged system packages.</span></span><br><span class="line"><span class="comment">//收集私有的系统包名：/system/priv-app</span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect ordinary system packages.</span></span><br><span class="line"><span class="comment">//收集一般的系统包名：/system/app</span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all vendor packages.</span></span><br><span class="line"><span class="comment">//收集所有的供应商包名：/vendor/app</span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">  <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all OEM packages.</span></span><br><span class="line"><span class="comment">//收集所有OEM包名：/oem/app</span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all Regionalization packages form Carrier's res packages.</span></span><br><span class="line"><span class="keyword">if</span> (RegionalizationEnvironment.isSupported()) &#123;</span><br><span class="line">  Log.d(TAG, <span class="string">"Load Regionalization vendor apks"</span>);</span><br><span class="line">  <span class="keyword">final</span> List&lt;File&gt; RegionalizationDirs =</span><br><span class="line">    RegionalizationEnvironment.getAllPackageDirectories();</span><br><span class="line">  <span class="keyword">for</span> (File f : RegionalizationDirs) &#123;</span><br><span class="line">    File RegionalizationSystemDir = <span class="keyword">new</span> File(f, <span class="string">"system"</span>);</span><br><span class="line">    <span class="comment">// Collect packages in &lt;Package&gt;/system/priv-app</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"priv-app"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Collect packages in &lt;Package&gt;/system/app</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"app"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">              scanFlags, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Collect overlay in &lt;Package&gt;/system/vendor</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"vendor/overlay"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">              scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prune any system packages that no longer exist.</span></span><br><span class="line"><span class="comment">// 这个列表代表有可能有升级包的系统App</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">  Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">  <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">    PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If this is not a system app, it can't be a</span></span><br><span class="line"><span class="comment">    * disable system app.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If the package is scanned, it's not erased.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">    <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * If the system app is both scanned and in the</span></span><br><span class="line"><span class="comment">      * disabled packages list, then it must have been</span></span><br><span class="line"><span class="comment">      * added via OTA. Remove it from the currently</span></span><br><span class="line"><span class="comment">      * scanned package so the previously user-installed</span></span><br><span class="line"><span class="comment">      * application can be scanned.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;  <span class="comment">//1</span></span><br><span class="line">        logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">        <span class="comment">//将这个系统App的PackageSetting从PMS的mPackages中移除</span></span><br><span class="line">        removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//将升级包的路径添加到mExpectingBetter列表中</span></span><br><span class="line">        mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">      psit.remove();</span><br><span class="line">      logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                      + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">      <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">      <span class="comment">// reconciliation step</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">      <span class="comment">//这个系统App升级包信息在mDisabledSysPackages中,但是没有发现这个升级包存在</span></span><br><span class="line">      <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;<span class="comment">//2</span></span><br><span class="line">        possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//look for any incomplete package installations</span></span><br><span class="line"><span class="comment">//清理所有安装不完整的包</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">  <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">  <span class="comment">// reconciliation step</span></span><br><span class="line">  <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">  logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    mSettings.removePackageLPw(packageName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//delete tmp files</span></span><br><span class="line"><span class="comment">//删除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove any shared userIDs that have no associated packages</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br></pre></td></tr></table></figure><p>系统扫描阶段的主要工作有以下3点：</p><ol><li>创建/system的子目录，比如/system/framework、/system/priv-app和/system/app等等</li><li>扫描系统文件，比如/vendor/overlay、/system/framework、/system/app等等目录下的文件。</li><li>对扫描到的系统文件做后续处理。</li></ol><p>主要来说第3点，一次OTA升级对于一个系统App会有三种情况：</p><ul><li>这个系统APP无更新。</li><li>这个系统APP有更新。</li><li>新的OTA版本中，这个系统APP已经被删除。</li></ul><p>当系统App升级，PMS会将该系统App的升级包设置数据（PackageSetting）存储到Settings的mDisabledSysPackages列表中（具体见PMS的replaceSystemPackageLIF方法），mDisabledSysPackages的类型为<code>ArrayMap&lt;String, PackageSetting&gt;</code>。mDisabledSysPackages中的信息会被PMS保存到packages.xml中的<code>&lt;updated-package&gt;</code>标签下（具体见Settings的writeDisabledSysPackageLPr方法）。</p><p>注释1处说明这个系统App有升级包，那么就将该系统App的PackageSetting从mDisabledSysPackages列表中移除，并将系统App的升级包的路径添加到mExpectingBetter列表中，mExpectingBetter的类型为<code>ArrayMap&lt;String, File&gt;</code>等待后续处理。</p><p>注释2处如果这个系统App的升级包信息存储在mDisabledSysPackages列表中，但是没有发现这个升级包存在，则将它加入到possiblyDeletedUpdatedSystemApps列表中，意为“系统App的升级包可能被删除”，之所以是“可能”，是因为系统还没有扫描Data分区，只能暂放到possiblyDeletedUpdatedSystemApps列表中，等到扫描完Data分区后再做处理。</p><h3 id="3、扫描Data分区阶段"><a href="#3、扫描Data分区阶段" class="headerlink" title="3、扫描Data分区阶段"></a>3、扫描Data分区阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果设备没有加密，那么就开始扫描Data分区</span></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">//打印扫描Data分区阶段日志</span></span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">    <span class="comment">//扫描/data/app目录下的文件 </span></span><br><span class="line">    scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//扫描/data/app-private目录下的文件</span></span><br><span class="line">    scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">                    | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">                    scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//扫描/data/app-ephemeral目录下的文件</span></span><br><span class="line">    scanDirLI(mEphemeralInstallDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_EPHEMERAL,</span><br><span class="line">              scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Remove disable package settings for any updated system</span></span><br><span class="line"><span class="comment">    * apps that were removed via an OTA. If they're not a</span></span><br><span class="line"><span class="comment">    * previously-updated app, remove them completely.</span></span><br><span class="line"><span class="comment">    * Otherwise, just revoke their system-level permissions.</span></span><br><span class="line"><span class="comment">    * 处理possiblyDeletedUpdatedSystemApps列表</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">      PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">      mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">      String msg;</span><br><span class="line">      <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//1 如果这个系统App的包信息不在PMS的变量mPackages中，说明是残留的App信息，后续会删除它的数据</span></span><br><span class="line">        msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">          + <span class="string">" no longer exists; it's data will be wiped"</span>;</span><br><span class="line">        <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">        <span class="comment">// reconciliation step</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//2 如果这个系统App在mPackages中，说明是存在于Data分区，不属于系统App，那么移除其系统权限。</span></span><br><span class="line">        msg = <span class="string">"Updated system app + "</span> + deletedAppName</span><br><span class="line">          + <span class="string">" no longer present; removing system privileges for "</span></span><br><span class="line">          + deletedAppName;</span><br><span class="line"></span><br><span class="line">        deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"></span><br><span class="line">        PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">        deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">      &#125;</span><br><span class="line">      logCriticalInfo(Log.WARN, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Make sure all system apps that we expected to appear on</span></span><br><span class="line"><span class="comment">    * the userdata partition actually showed up. If they never</span></span><br><span class="line"><span class="comment">    * appeared, crawl back and revive the system version.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">     <span class="comment">//遍历mExpectingBetter列表</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">      <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">        <span class="comment">//得到系统App的升级包路径</span></span><br><span class="line">        <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">        logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                        + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line"> </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//3 根据系统App所在的目录设置扫描的解析参数</span></span><br><span class="line">        <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">        <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">            | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 将packageName对应的包设置数据（PackageSetting）添加到mSettings的mPackages中</span></span><br><span class="line">        mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//5 扫描系统App的升级包</span></span><br><span class="line">          scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">          Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                 + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//清除mExpectingBetter列表</span></span><br><span class="line">  mExpectingBetter.clear();</span><br></pre></td></tr></table></figure><p>扫描Data分区阶段主要做了以下几件事：</p><ol><li>扫描/data/app和/data/app-private目录下的文件。</li><li>遍历possiblyDeletedUpdatedSystemApps列表，注释1处如果这个系统App的包信息不在PMS的变量mPackages中，说明是残留的App信息，后续会删除它的数据。注释2处如果这个系统App的包信息在mPackages中，说明是存在于Data分区，不属于系统App，那么移除其系统权限。</li><li>遍历mExpectingBetter列表，注释3处根据系统App所在的目录设置扫描的解析参数，注释4处的方法内部会将packageName对应的包设置数据（PackageSetting）添加到mSettings的mPackages中。注释5处扫描系统App的升级包，最后清除mExpectingBetter列表。</li></ol><h3 id="4、扫描结束阶段"><a href="#4、扫描结束阶段" class="headerlink" title="4、扫描结束阶段"></a>4、扫描结束阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印扫描结束阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the platform SDK has changed since the last time we booted,</span></span><br><span class="line">            <span class="comment">// we need to re-grant app permission to catch any new ones that</span></span><br><span class="line">            <span class="comment">// appear.  This is really a hack, and means that apps can in some</span></span><br><span class="line">            <span class="comment">// cases get permissions that the user didn't initially explicitly</span></span><br><span class="line">            <span class="comment">// allow...  it would be nice to have some better way to handle</span></span><br><span class="line">            <span class="comment">// this situation.</span></span><br><span class="line">            <span class="comment">//当sdk版本不一致时，需要更新权限</span></span><br><span class="line">            <span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line">            <span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">                        + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">                updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">            &#125;</span><br><span class="line">            updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">            ver.sdkVersion = mSdkVersion;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is the first boot or an update from pre-M, and it is a normal</span></span><br><span class="line">            <span class="comment">// boot, then we need to initialize the default preferred apps across</span></span><br><span class="line">            <span class="comment">// all defined users.</span></span><br><span class="line">   <span class="comment">//如果是第一次启动或者是Android M升级后的第一次启动，需要初始化所有用户定义的默认首选App</span></span><br><span class="line">            <span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                    mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">                    applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">                    primeDomainVerificationsLPw(user.id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//在引导过程中尽早为系统用户准备存储，</span></span><br><span class="line">            <span class="comment">//因为核心系统应用程序，如设置Provider和SystemUI无法等待用户启动</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line">            <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">            &#125;</span><br><span class="line">            reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">                    storageFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is first boot after an OTA, and a normal boot, then</span></span><br><span class="line">            <span class="comment">// we need to clear code cache directories.</span></span><br><span class="line">            <span class="comment">// Note that we do *not* clear the application profiles. These remain valid</span></span><br><span class="line">            <span class="comment">// across OTAs and are used to drive profile verification (post OTA) and</span></span><br><span class="line">            <span class="comment">// profile compilation (without waiting to collect a fresh set of profiles).</span></span><br><span class="line"> <span class="comment">// OTA后的第一次启动，会清除代码缓存目录</span></span><br><span class="line">            <span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">                        <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">                        clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                                        | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkDefaultBrowser();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//当权限和其他默认项都完成更新，则清理相关信息</span></span><br><span class="line">            mExistingSystemPackages.clear();</span><br><span class="line">            mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">            ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 把Settings的内容保存到packages.xml中</span></span><br><span class="line">            mSettings.writeLPr();</span><br></pre></td></tr></table></figure><p>扫描结束结束阶段主要做了以下几件事：</p><ol><li>如果当前平台SDK版本和上次启动时的SDK版本不同，重新更新APK的授权。</li><li>如果是第一次启动或者是Android M升级后的第一次启动，需要初始化所有用户定义的默认首选App。</li><li>OTA升级后的第一次启动，会清除代码缓存目录。</li><li>把Settings的内容保存到packages.xml中，这样此后PMS再次创建时会读到此前保存的Settings的内容。</li></ol><h3 id="5、准备阶段"><a href="#5、准备阶段" class="headerlink" title="5、准备阶段"></a>5、准备阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印准备阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">  mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">  mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">    mRequiredUninstallerPackage = getRequiredUninstallerLPr();</span><br><span class="line">    mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">    mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                                                    mIntentFilterVerifierComponent);</span><br><span class="line">    mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">      PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">    mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">      PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mOnlyPowerOffAlarm) &#123;</span><br><span class="line">      mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mRequiredUninstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">    mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">    mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">    mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">    mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建PackageInstallerService，用于管理安装会话的服务，它会为每次安装过程分配一个SessionId</span></span><br><span class="line">mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行一次垃圾收集</span></span><br><span class="line">untime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line"><span class="comment">// The initial scanning above does many calls into installd while</span></span><br><span class="line"><span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></span><br><span class="line"><span class="comment">// once we have a booted system.</span></span><br><span class="line">mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将PackageManagerInternalImpl（PackageManager的本地服务）添加到LocalServices中，LocalServices用于存储运行在当前的进程中的本地服务</span></span><br><span class="line">LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>PMS属于引导服务，由SyetemServer启动</p><p>PMS启动又分为5个阶段</p><ol><li>BOOT_PROGRESS_PMS_START（开始阶段）</li><li>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START（扫描系统阶段）</li><li>BOOT_PROGRESS_PMS_DATA_SCAN_START（扫描Data分区阶段）</li><li>BOOT_PROGRESS_PMS_SCAN_END（扫描结束阶段）</li><li>BOOT_PROGRESS_PMS_READY（准备阶段）</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;PackageManagerService(简称PMS)，是Android系统中核心服务之一，管理着所有跟package相关的工作，常见的比如安装、卸载应用。 &lt;/p&gt;
&lt;h2 id=&quot;SyetemServer处理&quot;&gt;&lt;a href=&quot;#SyetemServer处理&quot; cl
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Android" scheme="http://yoursite.com/tags/Android/"/>
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="PMS" scheme="http://yoursite.com/tags/PMS/"/>
    
  </entry>
  
  <entry>
    <title>设计模式-代理模式</title>
    <link href="http://yoursite.com/2021/03/11/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/"/>
    <id>http://yoursite.com/2021/03/11/设计模式-代理模式/</id>
    <published>2021-03-11T01:33:22.000Z</published>
    <updated>2021-03-11T07:51:00.108Z</updated>
    
    <content type="html"><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>为其它对象提供一种代理以控制对这个对象的访问</p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>当无法或不想直接访问某个对象或访问某个对象存在困难时可以通过一个代理对象来间接访问，为了保证客户端使用的透明性，委托对象与代理对象需要实现相同的接口。</p><h2 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h2><p><img src="/2021/03/11/设计模式-代理模式/proxy.png" alt=""></p><p>Subject：抽象主题类</p><p>该类的主要职责是声明真实主题与代理的共同接口方法，该类既可以是一个抽象类也可以是接口。</p><p>RealSubject：真实主题类</p><p>该类也被称为被委托类或被代理类，该类定义了代理所表示的真实对象，由其执行具体的业务逻辑方法，而客户类则通过代理类间接得调用真实主题类中定义的方法。</p><p>ProxySubject：代理类</p><p>该类也称为委托类或代理类，该类持有一个对真实主题类的引用，在其所实现的接口方法中调用真实主题类中相应的接口方法执行，以此起到代理的作用。</p><p>Client：客户类，即使用代理类的类型。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;p&gt;为其它对象提供一种代理以控制对这个对象的访问&lt;/p&gt;
&lt;h2 id=&quot;使用场景&quot;&gt;&lt;a href=&quot;#使用场景&quot; class=&quot;header
      
    
    </summary>
    
      <category term="设计模式" scheme="http://yoursite.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式" scheme="http://yoursite.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>树与二叉树</title>
    <link href="http://yoursite.com/2021/03/08/%E6%A0%91%E4%B8%8E%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
    <id>http://yoursite.com/2021/03/08/树与二叉树/</id>
    <published>2021-03-08T03:48:07.000Z</published>
    <updated>2021-03-08T05:33:49.807Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="数据结构与算法" scheme="http://yoursite.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>快排排序-三路快排</title>
    <link href="http://yoursite.com/2021/03/08/%E5%BF%AB%E6%8E%92%E6%8E%92%E5%BA%8F-%E4%B8%89%E8%B7%AF%E5%BF%AB%E6%8E%92/"/>
    <id>http://yoursite.com/2021/03/08/快排排序-三路快排/</id>
    <published>2021-03-08T03:22:38.000Z</published>
    <updated>2021-03-08T05:33:51.483Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="数据结构与算法" scheme="http://yoursite.com/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>设计模式-观察者模式(RecyclerView notifyDataSetChanged)</title>
    <link href="http://yoursite.com/2021/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <id>http://yoursite.com/2021/03/04/设计模式-观察者模式/</id>
    <published>2021-03-04T06:20:16.000Z</published>
    <updated>2021-03-08T02:59:38.960Z</updated>
    
    <content type="html"><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>定义对象间一种一对多的依赖关系，使得每当一个对象改变状态，则所有依赖于它的对象都会得到通知并被自动更新。</p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul><li>关联行为场景，需要注意的是，关联行为是可拆分的，而不是“组合关系”</li><li>事件多级触发场景</li><li>跨系统的消息交换场景，如消息队列、事件总线的处理机制</li></ul><h2 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h2><p><img src="/2021/03/04/设计模式-观察者模式/observer_uml.png" alt=""></p><ul><li>Subject：抽象对象，也是被观察(Observable)的角色，抽象主题角色把所有观察者对象的引用保存在一个集合里，每个主题都可以有任意数量的观察者，抽象主题提供一个接口，可以增加和删除观察者对象。</li><li>ConcreteSubject：具体主题，该角色将有关状态存入具体观察者对象，在具体主题的内部状态改变时，给所有注册过的观察者发出通知，具体主题角色有叫做具体被观察者(ConcreteObservable)角色。</li><li>Observer：抽象观察者，该角色是观察者的抽象类，它定义了一个更新接口，使得在得到猪头的更改通知时更新自己。</li><li>ConcreteObserver：具体的观察者，该角色实现抽象观察者角色所定义的更新接口，以便在主题的状态发生改变时更新自己的状态。</li></ul><h2 id="Android源码"><a href="#Android源码" class="headerlink" title="Android源码"></a>Android源码</h2><p>Android中使用观察者模式的地方很多，在这里以我们常用的RecyclerView为例。当我们往RecyclerView中添加数据后，都会调用Adapter的notifyDataSetChanged方法，其中就使用观察者模式的方式，接下来研究它的实现源码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span>&lt;<span class="title">VH</span> <span class="keyword">extends</span> <span class="title">ViewHolder</span>&gt; </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> AdapterDataObservable mObservable = <span class="keyword">new</span> AdapterDataObservable();</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">boolean</span> mHasStableIds = <span class="keyword">false</span>;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAdapterDataObserver</span><span class="params">(@NonNull AdapterDataObserver observer)</span> </span>&#123;</span><br><span class="line">          mObservable.registerObserver(observer);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterAdapterDataObserver</span><span class="params">(@NonNull AdapterDataObserver observer)</span> </span>&#123;</span><br><span class="line">          mObservable.unregisterObserver(observer);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">notifyDataSetChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mObservable.notifyChanged();</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AdapterDataObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">AdapterDataObserver</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !mObservers.isEmpty();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// since onChanged() is implemented by the app, it could do anything, including</span></span><br><span class="line">            <span class="comment">// removing itself from &#123;@link mObservers&#125; - and that could cause problems if</span></span><br><span class="line">            <span class="comment">// an iterator is used on the ArrayList &#123;@link mObservers&#125;.</span></span><br><span class="line">            <span class="comment">// to avoid such problems, just march thru the list in the reverse order.</span></span><br><span class="line">          <span class="comment">//调用每个观察者的onChanged方法通知它们被观察者发生了改变</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = mObservers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                mObservers.get(i).onChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么这些观察者从哪里来的？这些观察者是在RecyclerView通过setAdapter方法设置的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(@Nullable Adapter adapter)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// bail out if layout is frozen</span></span><br><span class="line">        setLayoutFrozen(<span class="keyword">false</span>);</span><br><span class="line">        setAdapterInternal(adapter, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        processDataSetCompletelyChanged(<span class="keyword">false</span>);</span><br><span class="line">        requestLayout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAdapterInternal</span><span class="params">(@Nullable Adapter adapter, <span class="keyword">boolean</span> compatibleWithPrevious,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> removeAndRecycleViews)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果已经有了Adapter，那么先注销该Adapter对应的观察者</span></span><br><span class="line">        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mAdapter.unregisterAdapterDataObserver(mObserver);</span><br><span class="line">            mAdapter.onDetachedFromRecyclerView(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!compatibleWithPrevious || removeAndRecycleViews) &#123;</span><br><span class="line">            removeAndRecycleViews();</span><br><span class="line">        &#125;</span><br><span class="line">        mAdapterHelper.reset();</span><br><span class="line">        <span class="keyword">final</span> Adapter oldAdapter = mAdapter;</span><br><span class="line">        mAdapter = adapter;</span><br><span class="line">        <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">//将观察者注册到Adapter中，实际注册到mObservable(见上面)</span></span><br><span class="line">            adapter.registerAdapterDataObserver(mObserver);</span><br><span class="line">            adapter.onAttachedToRecyclerView(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mLayout != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLayout.onAdapterChanged(oldAdapter, mAdapter);</span><br><span class="line">        &#125;</span><br><span class="line">        mRecycler.onAdapterChanged(oldAdapter, mAdapter, compatibleWithPrevious);</span><br><span class="line">        mState.mStructureChanged = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这样注册也就完成了，只要我们调用notifyDataSetChanged，就会调用AdapterDataObservable的notifyChanged方法，这个函数会调用所有观察者（AdapterDataObserver）的onChanged方法。</p><p>onChanged实际调用的RecyclerViewDataObserver中的onChanged方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerViewDataObserver</span> <span class="keyword">extends</span> <span class="title">AdapterDataObserver</span> </span>&#123;</span><br><span class="line">        RecyclerViewDataObserver() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            assertNotInLayoutOrScroll(<span class="keyword">null</span>);</span><br><span class="line">            mState.mStructureChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            processDataSetCompletelyChanged(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (!mAdapterHelper.hasPendingUpdates()) &#123;</span><br><span class="line">                requestLayout();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在onChanged方法中调用requestLayout方法重新布局，更新用户界面。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>观察者和被观察者之间是抽象耦合，应对业务变化；</li><li>增强系统灵活性、可扩展性。</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>在应用观察者模式时需要考虑开发效率和运行效率，程序包括一个被观察者、多个观察者，开发和调试会比较复杂，而且在Java中消息的通知默认是顺序执行，一个观察者卡顿，会影响整体执行效率，在这种情况下，一般采用异步的方式。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;p&gt;定义对象间一种一对多的依赖关系，使得每当一个对象改变状态，则所有依赖于它的对象都会得到通知并被自动更新。&lt;/p&gt;
&lt;h2 id=&quot;使用场景&quot;
      
    
    </summary>
    
      <category term="设计模式" scheme="http://yoursite.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式" scheme="http://yoursite.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>设计模式-策略模式</title>
    <link href="http://yoursite.com/2021/03/02/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/"/>
    <id>http://yoursite.com/2021/03/02/设计模式-策略模式/</id>
    <published>2021-03-02T01:08:42.000Z</published>
    <updated>2021-03-03T03:32:31.365Z</updated>
    
    <content type="html"><![CDATA[<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>策略模式定义了一系列的算法，并将每一个算法封装起来，而且使它们可以互相替换。策略模式让算法独立于使用它的客户而独立变化。</p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul><li>针对同一类型问题的多种处理方式，仅仅是具体行为有差别时。</li><li>需要安全地封装多种同一类型的操作时。</li><li>出现同一抽象类有多个子类，而又需要使用if-else或switch-case来选择具体子类时。</li></ul><h2 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h2><p>Context：用来操作策略的上下文环境</p><p>Stragety：策略的抽象</p><p>ConcreteStragetyA、ConcreteStragetyB：具体的策略实现</p><p><img src="/2021/03/02/设计模式-策略模式/1.png" alt=""></p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>以乘坐公共交通为例，公共交通采用分段计费，乘坐距离越远，价格越高。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算接口</span></span><br><span class="line"> <span class="class"><span class="keyword">interface</span> <span class="title">CalculateStrategy</span> </span>&#123;</span><br><span class="line">     <span class="comment">//按照距离来计算价格</span></span><br><span class="line">     <span class="function"><span class="keyword">fun</span> <span class="title">calculatePrice</span><span class="params">(km: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">BusStrategy</span> : <span class="type">CalculateStrategy &#123;</span></span></span><br><span class="line">     <span class="comment">//十公里1元，超过10公里每加1元乘5公里</span></span><br><span class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculatePrice</span><span class="params">(km: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">         <span class="comment">//超过10公里的总距离</span></span><br><span class="line">         <span class="keyword">val</span> extraTotal = km - <span class="number">10</span></span><br><span class="line">         <span class="comment">//超过的距离是5公里的倍数</span></span><br><span class="line">         <span class="keyword">val</span> extraFactor = extraTotal / <span class="number">5</span></span><br><span class="line">         <span class="comment">//超过的距离对5公里取余</span></span><br><span class="line">         <span class="keyword">val</span> fraction = extraTotal % <span class="number">5</span></span><br><span class="line">         <span class="comment">//计算价格</span></span><br><span class="line">         <span class="keyword">var</span> price = <span class="number">1</span> + extraFactor * <span class="number">1</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">if</span> (fraction &gt; <span class="number">0</span>)</span><br><span class="line">             ++price</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             price</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SubwayStrategy</span> : <span class="type">CalculateStrategy &#123;</span></span></span><br><span class="line">     <span class="comment">//6公里内3元，6-12公里4元，12-22公里5元，22-32公里6元</span></span><br><span class="line">     <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculatePrice</span><span class="params">(km: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">if</span> (km &lt;= <span class="number">6</span>) &#123;</span><br><span class="line">             <span class="number">3</span></span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (km &gt; <span class="number">6</span> &amp;&amp; km &lt; <span class="number">12</span>) &#123;</span><br><span class="line">             <span class="number">4</span></span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (km &gt; <span class="number">12</span> &amp;&amp; km &lt; <span class="number">22</span>) &#123;</span><br><span class="line">             <span class="number">5</span></span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (km &gt; <span class="number">22</span> &amp;&amp; km &lt; <span class="number">32</span>) &#123;</span><br><span class="line">             <span class="number">6</span></span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="number">7</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">TranficCalculate</span> </span>&#123;</span><br><span class="line">     <span class="keyword">lateinit</span> <span class="keyword">var</span> mStrategy: CalculateStrategy</span><br><span class="line">     <span class="function"><span class="keyword">fun</span> <span class="title">setStrategy</span><span class="params">(strategy: <span class="type">CalculateStrategy</span>)</span></span> &#123;</span><br><span class="line">         mStrategy = strategy</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">fun</span> <span class="title">calculatePrice</span><span class="params">(km: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">         mStrategy.calculatePrice(km)</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="keyword">val</span> calculate = TranficCalculate()</span><br><span class="line">         calculate.setStrategy(BusStrategy())</span><br><span class="line">         <span class="comment">//计算乘坐公交16公里的价格</span></span><br><span class="line">         calculate.calculatePrice(<span class="number">15</span>)</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>这种方案在隐藏实现的同时，可扩展性变得很强，当我们想增加计算出租车的计算策略的时候，只需要增加出租车计算策略类，然后将该策略设置给TranficCalculate即可。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>策略模式主要用来分离算法，在相同的行为抽象下有不同的具体实现策略。这个模式很好的演示了开闭原则，也就是定义抽象，注入不同的实现，从而达到很好的可扩展性。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul><li>结构清晰明了、使用简单直观</li><li>耦合度相对而言较低，扩展方便</li><li>操作封装也更为彻底，数据更为安全</li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>随着策略的增多，子类也会变得繁多</li></ul><blockquote><p>《Android源码设计模式解析与实战》学习笔记</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;p&gt;策略模式定义了一系列的算法，并将每一个算法封装起来，而且使它们可以互相替换。策略模式让算法独立于使用它的客户而独立变化。&lt;/p&gt;
&lt;h2 i
      
    
    </summary>
    
      <category term="设计模式" scheme="http://yoursite.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式" scheme="http://yoursite.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>设计模式-状态模式</title>
    <link href="http://yoursite.com/2021/03/01/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/"/>
    <id>http://yoursite.com/2021/03/01/设计模式-状态模式/</id>
    <published>2021-03-01T08:31:01.000Z</published>
    <updated>2021-03-02T03:06:33.133Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>状态模式中的行为是由状态来决定的，不同的状态下有不同的行为。状态模式和策略模式的结构几乎完全一样，但它们的目的、本质完全不一样。状态模式的行为是平行的、不可替换的，策略模式的行为是彼此独立的、可相互替换的。用一句话表述，状态模式把对象的行为包装在不同的状态对象里，每一个状态对象都有一个共同的抽象状态基类。状态模式的意图是让一个对象在其内部状态改变时，其行为也随之改变。</p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ol><li>一个对象的行为取决于它的状态，并且它必须在运行时根据状态改变它的行为。</li><li>代码中包含大量与对象状态有关的条件语句，例如，一个操作中包含庞大的多分支语句（if-else或switch-case），且这些分支依赖于该对象的状态。</li></ol><h2 id="UML类图"><a href="#UML类图" class="headerlink" title="UML类图"></a>UML类图</h2><p><img src="/2021/03/01/设计模式-状态模式/state_uml.png" alt=""></p><ul><li>Context：环境类，定义客户感兴趣的接口，维护一个State子类的实例，这个实例定义了对象的当前状态。</li><li>State：抽象状态类或状态接口，定义一个或一组接口，表示该状态下的行为。</li><li>Concerte StateA 、Concerte StateB：具体状态类，每一个具体的状态类实现抽象State中定义的接口，从而达到不同状态下的不同行为。</li></ul><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p>以电视遥控器为例演示状态模式的实现。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 电视操作接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TVState</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">nextChannel</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">prevChannel</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">turnUp</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">turnDown</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//关机状态，此时只有开机状态是有效的</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerOffState</span> : <span class="type">TVState &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">nextChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"已经关机啦"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">prevChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"已经关机啦"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">turnUp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"已经关机啦"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">turnDown</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"已经关机啦"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开机状态，此时触发开机功能不做操作</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PowerOnState</span> : <span class="type">TVState &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">nextChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"下一频道"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">prevChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"上一频道"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">turnUp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"调高音量"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">turnDown</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"调低音量"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PowerController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">powerOn</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">powerOff</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//电视遥控器，相当于上面UML图中的Context</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TVController</span> : <span class="type">PowerController &#123;</span></span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> mTVState: TVState</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setTVState</span><span class="params">(tvState: <span class="type">TVState</span>)</span></span> &#123;</span><br><span class="line">        mTVState = tvState</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">powerOn</span><span class="params">()</span></span> &#123;</span><br><span class="line">        setTVState(PowerOnState())</span><br><span class="line">        Log.d(TAG, <span class="string">"开机啦！"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">powerOff</span><span class="params">()</span></span> &#123;</span><br><span class="line">        setTVState(PowerOffState())</span><br><span class="line">        Log.d(TAG, <span class="string">"关机啦！"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">nextChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mTVState.nextChannel()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">prevChannel</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mTVState.prevChannel()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">turnUp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mTVState.turnUp()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">turnDown</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mTVState.turnDown()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> tvController = TVController()</span><br><span class="line">    tvController.powerOn()</span><br><span class="line">    tvController.nextChannel()</span><br><span class="line">    tvController.prevChannel()</span><br><span class="line">    tvController.turnDown()</span><br><span class="line">    tvController.turnUp()</span><br><span class="line">    tvController.powerOff()</span><br><span class="line">    tvController.turnUp() <span class="comment">// 不会生效</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">开机啦！</span><br><span class="line">下一频道</span><br><span class="line">上一频道</span><br><span class="line">调低音量</span><br><span class="line">调高音量</span><br><span class="line">关机啦！</span><br><span class="line">已经关机啦</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>状态模式的关键点在于不同的状态下对于同一个行为有不同的相应，这其实就是一个将if-else用多态来实现的一个具体示例。</p><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>State模式将所有与一个特定的状态相关的行为都放入一个状态对象中，它提供了一个更好的方法来组织与特定状态相关的代码，将繁琐的状态判断转换成结构清晰的状态类族，在避免代码膨胀的同事也保证可可扩展性和可维护性。</p><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>状态模式的使用必然会增加系统类和对象的个数。</p><blockquote><p>《Android源码设计模式解析与实战》学习笔记</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;状态模式中的行为是由状态来决定的，不同的状态下有不同的行为。状态模式和策略模式的结构几乎完全一样，但它们的目的、本质完全不一样。状态模式的行
      
    
    </summary>
    
      <category term="设计模式" scheme="http://yoursite.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
    
      <category term="设计模式" scheme="http://yoursite.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="状态机" scheme="http://yoursite.com/tags/%E7%8A%B6%E6%80%81%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Linux等待队列</title>
    <link href="http://yoursite.com/2021/02/26/Linux%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97/"/>
    <id>http://yoursite.com/2021/02/26/Linux等待队列/</id>
    <published>2021-02-26T01:39:26.000Z</published>
    <updated>2021-02-26T06:19:02.600Z</updated>
    
    <content type="html"><![CDATA[<p>在软件开发中任务经常由于某种条件没有得到满足而不得不进入睡眠状态，然后等待条件得到满足的时候再继续运行，进入运行状态。这种需求需要等待队列机制的支持。Linux中提供了等待队列的机制，该机制在内核中应用很广泛。</p><p>它是以双循环链表为基础数据结构，与进程的休眠唤醒机制紧密相联，是实现异步事件通知、跨进程通信、同步资源访问等技术的底层技术支撑。</p><p>它有两种数据结构：等待队列头 （wait_queue_head_t）和等待队列项（wait_queue_t）。等待队列头和等待队列项中都包含一个list_head类型的域作为”连接件”。它通过一个双链表和把等待task的头，和等待的进程列表链接起来。</p><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>等待队列结构如下，因为每个等待队列都可以再中断时被修改，因此，在操作等待队列之前必须获得一个自旋锁。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span> &#123;</span></span><br><span class="line">   <span class="keyword">spinlock_t</span>      lock;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">task_list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span> <span class="title">wait_queue_head_t</span>;</span></span><br></pre></td></tr></table></figure><p>可通过宏<code>DECLARE_WAIT_QUEUE_HEAD(name)</code>来创建类型为wait_queue_head_t的等待队列头name。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_WAIT_QUEUE_HEAD(name) \</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wait_queue_head</span> <span class="title">name</span> = __<span class="title">WAIT_QUEUE_HEAD_INITIALIZER</span>(<span class="title">name</span>)</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">#<span class="title">define</span> __<span class="title">WAIT_QUEUE_HEAD_INITIALIZER</span>(<span class="title">name</span>) &#123;</span>                    \</span><br><span class="line">    .lock        = __SPIN_LOCK_UNLOCKED(name.lock),            \</span><br><span class="line">    .head        = &#123; &amp;(name).head, &amp;(name).head &#125; &#125;</span><br></pre></td></tr></table></figure><p>等待队列是通过task_list双链表来实现，其数据成员是如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>flags;</span><br><span class="line"><span class="keyword">void</span>*<span class="keyword">private</span>;  <span class="comment">//指向等待队列的进程task_struct</span></span><br><span class="line"><span class="keyword">wait_queue_func_t</span>func;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">task_list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span> <span class="title">wait_queue_t</span>;</span></span><br></pre></td></tr></table></figure><p>可通过宏<code>DECLARE_WAITQUEUE(name, tsk)</code>来创建类型为wait_queue_t的等待队列项name，并将tsk赋值给成员变量private， default_wake_function赋值给成员变量func。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_WAITQUEUE(name, tsk)                        \</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">wait_queue_entry</span> <span class="title">name</span> = __<span class="title">WAITQUEUE_INITIALIZER</span>(<span class="title">name</span>, <span class="title">tsk</span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">#<span class="title">define</span> __<span class="title">WAITQUEUE_INITIALIZER</span>(<span class="title">name</span>, <span class="title">tsk</span>) &#123;</span>                    \</span><br><span class="line">    .<span class="keyword">private</span>    = tsk,                            \</span><br><span class="line">    .func        = default_wake_function,                \</span><br><span class="line">    .entry        = &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125; &#125;</span><br></pre></td></tr></table></figure><p>示意图：</p><p><img src="/2021/02/26/Linux等待队列/wait_queue.png" alt=""></p><h2 id="初始化等待队列元素"><a href="#初始化等待队列元素" class="headerlink" title="初始化等待队列元素"></a>初始化等待队列元素</h2><ol><li><p>静态初始化</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define DEFINE_WAIT_FUNC(<span class="keyword">name</span>, <span class="function"><span class="keyword">function</span></span>)\</span><br><span class="line">wait_queue_t <span class="keyword">name</span> = &#123;\</span><br><span class="line">.<span class="keyword">private</span>= current,\</span><br><span class="line">.func= <span class="function"><span class="keyword">function</span></span>,\</span><br><span class="line">.task_list= LIST_HEAD_INIT((<span class="keyword">name</span>).task_list),\</span><br><span class="line">&#125;</span><br><span class="line">#define DEFINE_WAIT(<span class="keyword">name</span>) DEFINE_WAIT_FUNC(<span class="keyword">name</span>, autoremove_wake_function)</span><br></pre></td></tr></table></figure></li><li><p>动态初始化</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">init_waitqueue_entry</span><span class="params">(<span class="keyword">wait_queue_t</span> *q, struct task_struct *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">q-&gt;flags= <span class="number">0</span>;</span><br><span class="line">q-&gt;<span class="keyword">private</span>= p;</span><br><span class="line">q-&gt;func= default_wake_function;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="增加删除"><a href="#增加删除" class="headerlink" title="增加删除"></a>增加删除</h2><h3 id="add-wait-queue"><a href="#add-wait-queue" class="headerlink" title="add_wait_queue"></a>add_wait_queue</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_wait_queue</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">wait_queue_t</span> *wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    wait-&gt;flags &amp;= ~WQ_FLAG_EXCLUSIVE;</span><br><span class="line">    spin_lock_irqsave(&amp;q-&gt;lock, flags);</span><br><span class="line">    __add_wait_queue(q, wait);  <span class="comment">//挂到队列头</span></span><br><span class="line">    spin_unlock_irqrestore(&amp;q-&gt;lock, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __add_wait_queue(<span class="keyword">wait_queue_head_t</span> *head, <span class="keyword">wait_queue_t</span> *<span class="keyword">new</span>)</span><br><span class="line">&#123;</span><br><span class="line">    list_add(&amp;<span class="keyword">new</span>-&gt;task_list, &amp;head-&gt;task_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法的功能是将wait等待队列项 挂到等待队列头q中。</p><h3 id="remove-wait-queue"><a href="#remove-wait-queue" class="headerlink" title="remove_wait_queue"></a>remove_wait_queue</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_wait_queue</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">wait_queue_t</span> *wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    spin_lock_irqsave(&amp;q-&gt;lock, flags);</span><br><span class="line">    __remove_wait_queue(q, wait);</span><br><span class="line">    spin_unlock_irqrestore(&amp;q-&gt;lock, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __remove_wait_queue(<span class="keyword">wait_queue_head_t</span> *head, <span class="keyword">wait_queue_t</span> *old)</span><br><span class="line">&#123;</span><br><span class="line">    list_del(&amp;old-&gt;task_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法主要功能是将wait等待队列项 从等待队列头q中移除。</p><h2 id="休眠唤醒"><a href="#休眠唤醒" class="headerlink" title="休眠唤醒"></a>休眠唤醒</h2><h3 id="wait-event-（进程休眠）"><a href="#wait-event-（进程休眠）" class="headerlink" title="wait_event （进程休眠）"></a>wait_event （进程休眠）</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//condition ： a C expression for the event to wait for</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wait_event(wq, condition)                    \</span></span><br><span class="line"><span class="keyword">do</span> &#123;                                    \</span><br><span class="line">    <span class="keyword">if</span> (condition)                            \</span><br><span class="line">        <span class="keyword">break</span>;                            \</span><br><span class="line">    __wait_event(wq, condition);                    \</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __wait_event(wq, condition)                    \</span></span><br><span class="line">    (<span class="keyword">void</span>)___wait_event(wq, condition, TASK_UNINTERRUPTIBLE, <span class="number">0</span>, <span class="number">0</span>, schedule())</span><br></pre></td></tr></table></figure><p>####___wait_event</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">___wait_event(wq, condition, state, exclusive, ret, cmd)&#123;  </span><br><span class="line">    <span class="keyword">wait_queue_t</span> __wait;                    </span><br><span class="line">    INIT_LIST_HEAD(&amp;__wait.task_list);                </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//当检测进程是否有待处理信号则返回值__int不为0,见下面解析</span></span><br><span class="line">        <span class="keyword">long</span> __int = prepare_to_wait_event(&amp;wq, &amp;__wait, state);</span><br><span class="line">        <span class="keyword">if</span> (condition)  <span class="comment">//当满足条件，则跳出循环                    </span></span><br><span class="line">            <span class="keyword">break</span>;                        </span><br><span class="line">                                    </span><br><span class="line">        <span class="comment">//当有待处理信号且进程处于可中断状态(TASK_INTERRUPTIBLE或TASK_KILLABLE))，则跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (___wait_is_interruptible(state) &amp;&amp; __int) &#123;        </span><br><span class="line">            __ret = __int;                    </span><br><span class="line">            <span class="keyword">break</span>;                      </span><br><span class="line">        &#125;                            </span><br><span class="line">        cmd; <span class="comment">//schedule()，进入睡眠，从进程就绪队列选择一个高优先级进程来代替当前进程运行                       </span></span><br><span class="line">    &#125;                                </span><br><span class="line">    finish_wait(&amp;wq, &amp;__wait);  <span class="comment">//调用函数finish_wait()将进程状态设置为TASK_RUNNING，并从等待队列的链表中移除对应的成员             </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="prepare-to-wait-event"><a href="#prepare-to-wait-event" class="headerlink" title="prepare_to_wait_event"></a>prepare_to_wait_event</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">prepare_to_wait_event</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">wait_queue_t</span> *wait, <span class="keyword">int</span> state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">if</span> (signal_pending_state(state, current)) <span class="comment">//信号检测</span></span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line"></span><br><span class="line">    wait-&gt;<span class="keyword">private</span> = current;</span><br><span class="line">    wait-&gt;func = autoremove_wake_function; <span class="comment">//设置func唤醒函数</span></span><br><span class="line"></span><br><span class="line">    spin_lock_irqsave(&amp;q-&gt;lock, flags);</span><br><span class="line">    <span class="keyword">if</span> (list_empty(&amp;wait-&gt;task_list)) &#123;  <span class="comment">//当wait不在队列q，则加入其中，防止无法唤醒</span></span><br><span class="line">        <span class="keyword">if</span> (wait-&gt;flags &amp; WQ_FLAG_EXCLUSIVE)</span><br><span class="line">            __add_wait_queue_tail(q, wait);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            __add_wait_queue(q, wait);</span><br><span class="line">    &#125;</span><br><span class="line">    set_current_state(state);  <span class="comment">//设置进程状态</span></span><br><span class="line">    spin_unlock_irqrestore(&amp;q-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">autoremove_wake_function</span><span class="params">(<span class="keyword">wait_queue_t</span> *wait, <span class="keyword">unsigned</span> mode, <span class="keyword">int</span> sync, <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = default_wake_function(wait, mode, sync, key); <span class="comment">//唤醒函数</span></span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        list_del_init(&amp;wait-&gt;task_list); <span class="comment">//从列表中移除wait</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>wait_event(wq, condition)：进入睡眠状态直到condition为true，在等待期进程状态为TASK_UNINTERRUPTIBLE。对应的唤醒方法是wake_up()，当等待队列wq被唤醒时会执行如下两个检测：</p><ul><li>检查condition是否为true，满足条件，则跳出循环。</li><li>检测该进程task的成员thread_info-&gt;flags是否被设置TIF_SIGPENDING，被设置则说明有待处理的信号，则跳出循环。</li></ul><h3 id="wake-up-（进程唤醒）"><a href="#wake-up-（进程唤醒）" class="headerlink" title="wake_up （进程唤醒）"></a>wake_up （进程唤醒）</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wake_up(x)            __wake_up(x, TASK_NORMAL, 1, NULL)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __wake_up(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">unsigned</span> <span class="keyword">int</span> mode,</span><br><span class="line">            <span class="keyword">int</span> nr_exclusive, <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    spin_lock_irqsave(&amp;q-&gt;lock, flags);</span><br><span class="line">    <span class="comment">//核心方法</span></span><br><span class="line">    __wake_up_common(q, mode, nr_exclusive, <span class="number">0</span>, key);</span><br><span class="line">    spin_unlock_irqrestore(&amp;q-&gt;lock, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __wake_up_common(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">unsigned</span> <span class="keyword">int</span> mode,</span><br><span class="line">            <span class="keyword">int</span> nr_exclusive, <span class="keyword">int</span> wake_flags, <span class="keyword">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">wait_queue_t</span> *curr, *next;</span><br><span class="line"></span><br><span class="line">    list_for_each_entry_safe(curr, next, &amp;q-&gt;task_list, task_list) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> flags = curr-&gt;flags;</span><br><span class="line">        <span class="comment">//调用prepare_to_wait_event中设置的唤醒函数</span></span><br><span class="line">        <span class="keyword">if</span> (curr-&gt;func(curr, mode, wake_flags, key) &amp;&amp;</span><br><span class="line">                (flags &amp; WQ_FLAG_EXCLUSIVE) &amp;&amp; !--nr_exclusive)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中：q是等待队列，mode指定进程的状态，用于控制唤醒进程的条件，nr_exclusive表示将要唤醒的设置了WQ_FLAG_EXCLUSIVE标志的进程的数目。 </p><p>然后扫描链表，调用func唤醒函数，直至没有更多的进程被唤醒，或者被唤醒的的独占进程数目已经达到规定数目。</p><p>从上面可知，真正调用的唤醒函数为default_wake_function</p><h4 id="default-wake-function"><a href="#default-wake-function" class="headerlink" title="default_wake_function"></a>default_wake_function</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">default_wake_function</span><span class="params">(<span class="keyword">wait_queue_t</span> *curr, <span class="keyword">unsigned</span> mode, <span class="keyword">int</span> wake_flags,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> try_to_wake_up(curr-&gt;<span class="keyword">private</span>, mode, wake_flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="try-to-wake-up"><a href="#try-to-wake-up" class="headerlink" title="try_to_wake_up"></a>try_to_wake_up</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">try_to_wake_up</span><span class="params">(struct task_struct *p, <span class="keyword">unsigned</span> <span class="keyword">int</span> state, <span class="keyword">int</span> wake_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> cpu, src_cpu, success = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> freq_notif_allowed = !(wake_flags &amp; WF_NO_NOTIFIER);</span><br><span class="line">    <span class="keyword">bool</span> check_group = <span class="literal">false</span>;</span><br><span class="line">    wake_flags &amp;= ~WF_NO_NOTIFIER;</span><br><span class="line"></span><br><span class="line">    smp_mb__before_spinlock();</span><br><span class="line">    raw_spin_lock_irqsave(&amp;p-&gt;pi_lock, flags); <span class="comment">//关闭本地中断</span></span><br><span class="line">    src_cpu = cpu = task_cpu(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果当前进程状态不属于可唤醒状态集，则无法唤醒该进程</span></span><br><span class="line">    <span class="comment">//wake_up()传递过来的TASK_NORMAL等于(TASK_INTERRUPTIBLE | TASK_UNINTERRUPTIBLE)</span></span><br><span class="line">    <span class="keyword">if</span> (!(p-&gt;state &amp; state)) </span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    success = <span class="number">1</span>; </span><br><span class="line">    smp_rmb();</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;on_rq &amp;&amp; ttwu_remote(p, wake_flags)) <span class="comment">//当前进程已处于rq运行队列，则无需唤醒</span></span><br><span class="line">        <span class="keyword">goto</span> stat;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    ttwu_queue(p, cpu); </span><br><span class="line">stat:</span><br><span class="line">    ttwu_stat(p, cpu, wake_flags);</span><br><span class="line">out:</span><br><span class="line">    raw_spin_unlock_irqrestore(&amp;p-&gt;pi_lock, flags); <span class="comment">//恢复本地中断</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ttwu-queue"><a href="#ttwu-queue" class="headerlink" title="ttwu_queue"></a>ttwu_queue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ttwu_queue</span><span class="params">(struct task_struct *p, <span class="keyword">int</span> cpu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rq</span> *<span class="title">rq</span> = <span class="title">cpu_rq</span>(<span class="title">cpu</span>);</span> <span class="comment">// 获取当前进程的运行队列</span></span><br><span class="line">raw_spin_lock(&amp;rq-&gt;lock);</span><br><span class="line">lockdep_pin_lock(&amp;rq-&gt;lock);</span><br><span class="line">ttwu_do_activate(rq, p, <span class="number">0</span>); <span class="comment">//</span></span><br><span class="line">lockdep_unpin_lock(&amp;rq-&gt;lock);</span><br><span class="line">raw_spin_unlock(&amp;rq-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ttwu ： try to wake up 缩写</span></span><br></pre></td></tr></table></figure><h4 id="ttwu-do-activate"><a href="#ttwu-do-activate" class="headerlink" title="ttwu_do_activate"></a>ttwu_do_activate</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ttwu_do_activate</span><span class="params">(struct rq *rq, struct task_struct *p, <span class="keyword">int</span> wake_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ttwu_activate(rq, p, ENQUEUE_WAKEUP | ENQUEUE_WAKING);</span><br><span class="line">ttwu_do_wakeup(rq, p, wake_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ttwu_activate</span><span class="params">(struct rq *rq, struct task_struct *p, <span class="keyword">int</span> en_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">activate_task(rq, p, en_flags); <span class="comment">//将进程task加入rq队列</span></span><br><span class="line">p-&gt;on_rq = TASK_ON_RQ_QUEUED;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p-&gt;flags &amp; PF_WQ_WORKER)</span><br><span class="line">wq_worker_waking_up(p, cpu_of(rq)); <span class="comment">//worker正在唤醒中，则通知工作队列</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ttwu_do_wakeup</span><span class="params">(struct rq *rq, struct task_struct *p, <span class="keyword">int</span> wake_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">check_preempt_curr(rq, p, wake_flags);</span><br><span class="line">p-&gt;state = TASK_RUNNING; <span class="comment">//标记该进程为TASK_RUNNING状态</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>休眠与唤醒流程：</strong></p><ol><li>进程A调用wait_event(wq, condition)就是向等待队列头中添加等待队列项wait_queue_t，该该等待队列项中的成员变量private记录当前进程，其成员变量func记录唤醒回调函数，然后调用schedule()使当前进程进入休眠状态。</li><li>进程B调用wake_up(wq)会遍历整个等待列表wq中的每一项wait_queue_t，依次调用每一项的唤醒函数try_to_wake_up()。这个过程会将private记录的进程加入rq运行队列，并设置进程状态为TASK_RUNNING。</li><li>进程A被唤醒后只执行如下检测：<ul><li>检查condition是否为true，满足条件则跳出循环，再把wait_queue_t从wq队列中移除；</li><li>检测该进程task的成员thread_info-&gt;flags是否被设置TIF_SIGPENDING，被设置则说明有待处理的信号，则跳出循环，再把wait_queue_t从wq队列中移除；</li><li>否则，继续调用schedule()再次进入休眠等待状态，如果wait_queue_t不在wq队列，则再次加入wq队列。</li></ul></li></ol><p>参考：</p><p><a href="http://gityuan.com/2018/12/02/linux-wait-queue/" target="_blank" rel="noopener">http://gityuan.com/2018/12/02/linux-wait-queue/</a></p><p><a href="https://blog.csdn.net/younger_china/article/details/7176851" target="_blank" rel="noopener">https://blog.csdn.net/younger_china/article/details/7176851</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在软件开发中任务经常由于某种条件没有得到满足而不得不进入睡眠状态，然后等待条件得到满足的时候再继续运行，进入运行状态。这种需求需要等待队列机制的支持。Linux中提供了等待队列的机制，该机制在内核中应用很广泛。&lt;/p&gt;
&lt;p&gt;它是以双循环链表为基础数据结构，与进程的休眠唤醒
      
    
    </summary>
    
      <category term="Linux系统" scheme="http://yoursite.com/categories/Linux%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Linux" scheme="http://yoursite.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Android智能指针</title>
    <link href="http://yoursite.com/2020/12/01/Android%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/"/>
    <id>http://yoursite.com/2020/12/01/Android智能指针/</id>
    <published>2020-12-01T11:33:57.000Z</published>
    <updated>2021-02-23T08:50:23.008Z</updated>
    
    <content type="html"><![CDATA[<p>在开发中通常会使用引用计数来维护对象的生命周期。</p><p>每当有一个指针指向了一个new出来的对象时，就对这个对象的引用计数增加1，每当有一个指针不再使用这个对象时，就对这个对象的引用计数减少1，每次减1之后，如果发现引用计数值为0时，那么，就要delete这个对象了，这样就避免了忘记delete对象或者这个对象被delete之后其它地方还在使用的问题了。</p><p>那如何实现这个对象的引用计数呢？如果由开发人员维护，显然既不可靠，易出错，又不方便编写和维护。因此Android使用智能指针技术—能自动维护对象引用计数的技术。需要注意的是，智能指针是一个对象，而不是一个指针。这个对象代表的是另外一个真实使用的对象，当智能指针指向实际对象的时候，就是智能指针对象创建的时候，当智能指针不再指向实际对象的时候，就是智能指针对象销毁的时候</p><p>考虑这样的一个场景，系统中有两个对象A和B，在对象A的内部引用了对象B，而在对象B的内部也引用了对象A。当两个对象A和B都不再使用时，垃圾收集系统会发现无法回收这两个对象的所占据的内存的，因为系统一次只能收集一个对象，而无论系统决定要收回对象A还是要收回对象B时，都会发现这个对象被其它的对象所引用，因而就都回收不了，这样就造成了内存泄漏。这样，就要采取另外的一种引用计数技术了，即对象的引用计数同时存在强引用和弱引用两种计数，当父对象要引用子对象时，就对子对象使用强引用计数技术，而当子对象要引用父对象时，就对父对象使用弱引用计数技术，而当垃圾收集系统执行对象回收工作时，只要发现对象的强引用计数为0，而不管它的弱引用计数是否为0，都可以回收这个对象，但是，如果我们只对一个对象持有弱引用计数，当我们要使用这个对象时，就不直接使用了，必须要把这个弱引用升级成为强引用时，才能使用这个对象，在转换的过程中，如果对象已经不存在，那么转换就失败了，这时候就说明这个对象已经被销毁了，不能再使用了。</p><p>Android系统提供了强大的智能指针技术供我们使用，这些智能指针实现方案既包括简单的引用计数技术，也包括了复杂的引用计数技术，即对象既有强引用计数，也有弱引用计数，对应地，这三种智能指针分别就称为轻量级指针（Light Pointer）、强指针（Strong Pointer）和弱指针（Weak Pointer）。</p><p>无论是轻量级指针，还是强指针和弱指针，它们的实现框架都是一致的，即由对象本身来提供引用计数器，但是它不会去维护这个引用计数器的值，而是由智能指针来维护。</p><p>##轻量级指针</p><p><code>/system/core/include/utils/RefBase.h</code></p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">LightRefBase</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    inline LightRefBase() : mCount(0) &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">incStrong</span><span class="params">(__attribute__((unused)) <span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        mCount.fetch_add(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">decStrong</span><span class="params">(__attribute__((unused)) <span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">         <span class="comment">//fetch_sub将原子对象的封装值减 val，并返回原子对象的旧值，整个过程是原子的</span></span><br><span class="line">        <span class="keyword">if</span> (mCount.fetch_sub(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_release) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::atomic_thread_fence(<span class="built_in">std</span>::memory_order_acquire);</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> T*&gt;(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//! DEBUGGING ONLY: Get current strong ref count.</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> int32_t <span class="title">getStrongCount</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCount.load(<span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> LightRefBase&lt;T&gt; basetype;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">inline</span> ~LightRefBase() &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceMover</span>;</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">renameRefs</span><span class="params">(<span class="keyword">size_t</span> n, <span class="keyword">const</span> ReferenceRenamer&amp; renamer)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">renameRefId</span><span class="params">(T* ref,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> <span class="keyword">void</span>* old_id, <span class="keyword">const</span> <span class="keyword">void</span>* new_id)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> <span class="built_in">std</span>::atomic&lt;<span class="keyword">int32_t</span>&gt; mCount;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>首先它是一个模板类，拥有一个atomic&lt;int32_t&gt; 类型的计数器（atomic是一个原子操作类，在c++11中新定义的）提供了desString 和 incString的计数器增减方案，还有一个getStringCount的获取计数器数量的方法。</p><p>在decStrong方法中，如果强引用全部删除之后，我们会delete本对象。</p><p>轻量级指针的实现类为sp，它不仅仅是LightRefBase计数器的智能指针，同时也是强指针引用计数器的智能指针。</p><p><code>system/core/include/utils/StrongPointer.h</code></p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sp</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    inline sp() : m_ptr(0) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    sp(T* other);</span><br><span class="line">    sp(<span class="keyword">const</span> sp&lt;T&gt;&amp; other);</span><br><span class="line">    sp(sp&lt;T&gt;&amp;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp(U* other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp(<span class="keyword">const</span> sp&lt;U&gt;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp(sp&lt;U&gt;&amp;&amp; other);</span><br><span class="line"></span><br><span class="line">    ~sp();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assignment</span></span><br><span class="line"></span><br><span class="line">    sp&amp; <span class="keyword">operator</span> = (T* other);</span><br><span class="line">    sp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> sp&lt;T&gt;&amp; other);</span><br><span class="line">    sp&amp; <span class="keyword">operator</span> = (sp&lt;T&gt;&amp;&amp; other);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> sp&lt;U&gt;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp&amp; <span class="keyword">operator</span> = (sp&lt;U&gt;&amp;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; sp&amp; <span class="keyword">operator</span> = (U* other);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//! Special optimization for use by ProcessState (and nobody else).</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">force_set</span><span class="params">(T* other)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accessors</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span>  T&amp;      <span class="keyword">operator</span>* () <span class="keyword">const</span>  &#123; <span class="keyword">return</span> *m_ptr; &#125;</span><br><span class="line">    <span class="keyword">inline</span>  T*      <span class="keyword">operator</span>-&gt; () <span class="keyword">const</span> &#123; <span class="keyword">return</span> m_ptr;  &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  T*      <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span>         </span>&#123; <span class="keyword">return</span> m_ptr; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Operators</span></span><br><span class="line"></span><br><span class="line">    COMPARE(==)</span><br><span class="line">    COMPARE(!=)</span><br><span class="line">    COMPARE(&gt;)</span><br><span class="line">    COMPARE(&lt;)</span><br><span class="line">    COMPARE(&lt;=)</span><br><span class="line">    COMPARE(&gt;=)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:    </span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt; <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">sp</span>;</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt; <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">wp</span>;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_pointer</span><span class="params">(T* ptr)</span></span>;</span><br><span class="line">    T* m_ptr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>sp类也是一个模版类，T表示对象的实际类型，它也是必须继承了LightRefBase的。成员变量m_ptr是一个指针，它是在构造函数里初始化的，指向实际引用的对象。所以下面这两个构造函数实际就是调用了LightRefBase的成员函数incStrong来增加引用计数。</p><p>构造函数</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt;::sp(T* other)</span><br><span class="line">        : m_ptr(other) &#123;</span><br><span class="line">    <span class="keyword">if</span> (other)</span><br><span class="line">        other-&gt;incStrong(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt;::sp(<span class="keyword">const</span> sp&lt;T&gt;&amp; other)</span><br><span class="line">        : m_ptr(other.m_ptr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_ptr)</span><br><span class="line">        m_ptr-&gt;incStrong(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>析构函数</p><p>调用了LightRefBase的成员函数decStrong来减少引用计数</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt;::~sp() &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_ptr)</span><br><span class="line">        m_ptr-&gt;decStrong(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h3><p><code>external/lightpointer/lightpointer.cpp</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/RefBase.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LightClass</span> :</span> <span class="keyword">public</span> LightRefBase&lt;LightClass&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    LightClass()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Construce LightClass Object"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~LightClass()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Destory LightClass Object"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LightClass *pLightClass = <span class="keyword">new</span> LightClass();</span><br><span class="line">    sp&lt;LightClass&gt; lpOut = pLightClass;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Light Ref Count:%d \n"</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line"></span><br><span class="line">    &#123;   <span class="comment">//作用域</span></span><br><span class="line">        sp&lt;LightClass&gt; lpInner = lpOut;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Light Ref Count:%d \n"</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line">       <span class="comment">//作用域结束，lpInner析构</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Light Ref Count:%d \n"</span>, pLightClass-&gt;getStrongCount());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>external/lightpointer/Android.mk</code></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_MODULE := lightpointer</span><br><span class="line">LOCAL_SRC_FILES := lightpointer.cpp</span><br><span class="line">LOCAL_SHARED_LIBRARIES := \</span><br><span class="line">libcutils \</span><br><span class="line">libutils</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_EXECUTABLE)</span></span><br></pre></td></tr></table></figure><p>编译打包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmm ./external/lightpointer/</span><br><span class="line">make snod</span><br></pre></td></tr></table></figure><p>烧录新镜像后：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adb <span class="keyword">shell</span></span><br><span class="line"><span class="keyword">cd</span> <span class="built_in">system</span>/bin/</span><br><span class="line">./lightpointer</span><br><span class="line"></span><br><span class="line">Construce LightClass Object</span><br><span class="line">Light Ref Coun<span class="variable">t:</span> <span class="number">1</span></span><br><span class="line">Light Ref Coun<span class="variable">t:</span> <span class="number">2</span></span><br><span class="line">Light Ref Coun<span class="variable">t:</span> <span class="number">1</span> </span><br><span class="line">Destory LightClass Object</span><br></pre></td></tr></table></figure><p>可以看到pLightClass对象赋值给lpOut智能指针后，引用计数加1，然后在局部作用域中，定义一个智能指针lpInner，并且指向了原来的对象，引用计数再次加1，当局部作用域结束时，lpInner析构，引用计数减1。</p><h2 id="强指针"><a href="#强指针" class="headerlink" title="强指针"></a>强指针</h2><p><code>system/core/include/utils/RefBase.h</code></p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefBase</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="keyword">void</span>            <span class="title">incStrong</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">void</span>            <span class="title">decStrong</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    </span><br><span class="line">            <span class="function"><span class="keyword">void</span>            <span class="title">forceIncStrong</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//! DEBUGGING ONLY: Get current strong ref count.</span></span><br><span class="line">            <span class="keyword">int32_t</span>         getStrongCount() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">weakref_type</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">RefBase*            <span class="title">refBase</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">void</span>                <span class="title">incWeak</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span>                <span class="title">decWeak</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// acquires a strong reference if there is already one.</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span>                <span class="title">attemptIncStrong</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// acquires a weak reference if there is already one.</span></span><br><span class="line">        <span class="comment">// This is not always safe. see ProcessState.cpp and BpBinder.cpp</span></span><br><span class="line">        <span class="comment">// for proper use.</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span>                <span class="title">attemptIncWeak</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//! DEBUGGING ONLY: Get current weak ref count.</span></span><br><span class="line">        <span class="keyword">int32_t</span>             getWeakCount() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//! DEBUGGING ONLY: Print references held on object.</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span>                <span class="title">printRefs</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//! DEBUGGING ONLY: Enable tracking for this object.</span></span><br><span class="line">        <span class="comment">// enable -- enable/disable tracking</span></span><br><span class="line">        <span class="comment">// retain -- when tracking is enable, if true, then we save a stack trace</span></span><br><span class="line">        <span class="comment">//           for each reference and dereference; when retain == false, we</span></span><br><span class="line">        <span class="comment">//           match up references and dereferences and keep only the </span></span><br><span class="line">        <span class="comment">//           outstanding ones.</span></span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">void</span>                <span class="title">trackMe</span><span class="params">(<span class="keyword">bool</span> enable, <span class="keyword">bool</span> retain)</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">            <span class="function">weakref_type*   <span class="title">createWeak</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span> <span class="keyword">const</span></span>;</span><br><span class="line">            </span><br><span class="line">            <span class="function">weakref_type*   <span class="title">getWeakRefs</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//! DEBUGGING ONLY: Print references held on object.</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  <span class="keyword">void</span>            <span class="title">printRefs</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; getWeakRefs()-&gt;printRefs(); &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//! DEBUGGING ONLY: Enable tracking of object.</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  <span class="keyword">void</span>            <span class="title">trackMe</span><span class="params">(<span class="keyword">bool</span> enable, <span class="keyword">bool</span> retain)</span></span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        getWeakRefs()-&gt;trackMe(enable, retain); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> RefBase basetype;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">                            RefBase();</span><br><span class="line">    <span class="keyword">virtual</span>                 ~RefBase();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//! Flags for extendObjectLifetime()</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        OBJECT_LIFETIME_STRONG  = <span class="number">0x0000</span>,</span><br><span class="line">        OBJECT_LIFETIME_WEAK    = <span class="number">0x0001</span>,</span><br><span class="line">        OBJECT_LIFETIME_MASK    = <span class="number">0x0001</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">            <span class="function"><span class="keyword">void</span>            <span class="title">extendObjectLifetime</span><span class="params">(<span class="keyword">int32_t</span> mode)</span></span>;</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//! Flags for onIncStrongAttempted()</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        FIRST_INC_STRONG = <span class="number">0x0001</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>            <span class="title">onFirstRef</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>            <span class="title">onLastStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span>            <span class="title">onIncStrongAttempted</span><span class="params">(<span class="keyword">uint32_t</span> flags, <span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span>            <span class="title">onLastWeakRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">weakref_type</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">weakref_impl</span>;</span></span><br><span class="line">    </span><br><span class="line">                            RefBase(<span class="keyword">const</span> RefBase&amp; o);</span><br><span class="line">            RefBase&amp;        <span class="keyword">operator</span>=(<span class="keyword">const</span> RefBase&amp; o);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceMover</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">renameRefs</span><span class="params">(<span class="keyword">size_t</span> n, <span class="keyword">const</span> ReferenceRenamer&amp; renamer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">renameRefId</span><span class="params">(weakref_type* ref,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> <span class="keyword">void</span>* old_id, <span class="keyword">const</span> <span class="keyword">void</span>* new_id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">renameRefId</span><span class="params">(RefBase* ref,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const</span> <span class="keyword">void</span>* old_id, <span class="keyword">const</span> <span class="keyword">void</span>* new_id)</span></span>;</span><br><span class="line"></span><br><span class="line">        weakref_impl* <span class="keyword">const</span> mRefs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>同样定义了 incStrong 和decStrong方法，用于增减引用计数（这也是为什么强指针也能使用sp<t>类来控制引用计数的原因）。和轻量级指针引用计数不同的是，我们的引用计数量不再是一个int类型来记录引用数量，而是使用了一个weakref_impl指针类型的变量mRefs。</t></p><p>weakref_impl继承自上面的weakref_type</p><p><code>system/core/libutils/RefBase.cpp</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefBase</span>:</span>:weakref_impl : <span class="keyword">public</span> RefBase::weakref_type</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int32_t</span>&gt;    mStrong;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int32_t</span>&gt;    mWeak;</span><br><span class="line">    RefBase* <span class="keyword">const</span>          mBase;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt;<span class="keyword">int32_t</span>&gt;    mFlags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !DEBUG_REFS</span></span><br><span class="line"></span><br><span class="line">    weakref_impl(RefBase* base)</span><br><span class="line">        : mStrong(INITIAL_STRONG_VALUE)</span><br><span class="line">        , mWeak(<span class="number">0</span>)</span><br><span class="line">        , mBase(base)</span><br><span class="line">        , mFlags(<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeStrongRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">renameStrongRefId</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*old_id*/</span>, <span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*new_id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addWeakRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeWeakRef</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">renameWeakRefId</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*old_id*/</span>, <span class="keyword">const</span> <span class="keyword">void</span>* <span class="comment">/*new_id*/</span>)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printRefs</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">trackMe</span><span class="params">(<span class="keyword">bool</span>, <span class="keyword">bool</span>)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">......</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个里面实际有用的就是最上面定义的4个成员变量，mStrong 和 mWeak分别用来做强引用和弱引用的计数，mBase指向实现引用计数的对象本身，mFlags是标志位，默认值是0。</p><p>强指针的实现类依然为sp，上面我们知道sp中实际是调用了RefBase类的incStrong和decStrong来增加和减少引用计数的。我们先来看一下incStrong。</p><p><code>system/core/libutils/RefBase.cpp</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::incStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;incWeak(id);</span><br><span class="line">    </span><br><span class="line">    refs-&gt;addStrongRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = refs-&gt;mStrong.fetch_add(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    ALOG_ASSERT(c &gt; <span class="number">0</span>, <span class="string">"incStrong() called on %p after last strong ref"</span>, refs);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"incStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (c != INITIAL_STRONG_VALUE)  &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> old = refs-&gt;mStrong.fetch_sub(INITIAL_STRONG_VALUE,</span><br><span class="line">            <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    <span class="comment">// A decStrong() must still happen after us.</span></span><br><span class="line">    ALOG_ASSERT(old &gt; INITIAL_STRONG_VALUE, <span class="string">"0x%x too small"</span>, old);</span><br><span class="line">    refs-&gt;mBase-&gt;onFirstRef();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先调用incWeak，弱引用加1。（<strong>从这里可以看到增加对象的强引用，也会增加对象的弱引用计数，即一个对象的弱引用计数一定大于等于它的强引用计数</strong>）</p><p>然后调用addStrongRef，这个函数为空实现。</p><p>关键是mStrong.fetch_add，在强引用上加1，返回值c为增加前原值，如果c等于INITIAL_STRONG_VALUE，表明是第一次调用，就会调用fetch_sub，将mStrong归1。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INITIAL_STRONG_VALUE (1&lt;&lt;28)</span></span><br></pre></td></tr></table></figure><p>因为mStrong的初始值不为0，而是INITIAL_STRONG_VALUE，也就是1&lt;&lt;28，fetch_add后就成了1&lt;&lt;28+1，所以后面调用fetch_sub减掉INITIAL_STRONG_VALUE初始值，才会把mStrong值置为1。可以把这个操作看为一个判断是否第一次被强引用，相比使用boolean去标记优雅很多，后面refs-&gt;mBase-&gt;onFirstRef()调用是个空实现，由开发者自己定义。</p><p>然后看decStrong</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::decStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> refs = mRefs;</span><br><span class="line">    refs-&gt;removeStrongRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = refs-&gt;mStrong.fetch_sub(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_release);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"decStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, c);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decStrong() called on %p too many times"</span>, refs);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::atomic_thread_fence(<span class="built_in">std</span>::memory_order_acquire);</span><br><span class="line">        refs-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">        <span class="keyword">int32_t</span> flags = refs-&gt;mFlags.load(<span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">            <span class="comment">// Since mStrong had been incremented, the destructor did not</span></span><br><span class="line">            <span class="comment">// delete refs.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note that even with only strong reference operations, the thread</span></span><br><span class="line">    <span class="comment">// deallocating this may not be the same as the thread deallocating refs.</span></span><br><span class="line">    <span class="comment">// That's OK: all accesses to this happen before its deletion here,</span></span><br><span class="line">    <span class="comment">// and all accesses to refs happen before its deletion in the final decWeak.</span></span><br><span class="line">    <span class="comment">// The destructor can safely access mRefs because either it's deleting</span></span><br><span class="line">    <span class="comment">// mRefs itself, or it's running entirely before the final mWeak decrement.</span></span><br><span class="line">    refs-&gt;decWeak(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>removeStrongRef()也是一个空实现。</p><p>fetch_sub对对象的计数减1，如果c == 1，即没有其它引用了，先调用onLastStrongRef，与onFirstRef对应，也可以自定义。</p><p>接下来先看一个枚举：</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//! Flags for extendObjectLifetime()</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">        OBJECT_LIFETIME_STRONG  = <span class="number">0</span>x0000,</span><br><span class="line">        OBJECT_LIFETIME_WEAK    = <span class="number">0</span>x0001,</span><br><span class="line">        OBJECT_LIFETIME_MASK    = <span class="number">0</span>x0001</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p> 这个枚举量是用来控制对象生命周期的，如果设置为OBJECT_LIFETIME_STRONG表示，对象如果强引用计数器为0，就表示生命周期终止，需要delete，如果设置为OBJECT_LIFETIME_WEAK,表示，只有当弱引用和强引用计数器都为0时，才会delete对象。</p><p><code>if ((flags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG)</code> 判断对象的生命周期类型，如果是OBJECT_LIFETIME_STRONG,那么会直接delete自己。delete会调用析构函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RefBase::~RefBase()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRefs-&gt;mStrong.load(<span class="built_in">std</span>::memory_order_relaxed)</span><br><span class="line">            == INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">        <span class="comment">// we never acquired a strong (and/or weak) reference on this object.</span></span><br><span class="line">        <span class="keyword">delete</span> mRefs;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// life-time of this object is extended to WEAK, in</span></span><br><span class="line">        <span class="comment">// which case weakref_impl doesn't out-live the object and we</span></span><br><span class="line">        <span class="comment">// can free it now.</span></span><br><span class="line">        <span class="keyword">int32_t</span> flags = mRefs-&gt;mFlags.load(<span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; OBJECT_LIFETIME_MASK) != OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="comment">// It's possible that the weak count is not 0 if the object</span></span><br><span class="line">            <span class="comment">// re-acquired a weak reference in its destructor</span></span><br><span class="line">            <span class="keyword">if</span> (mRefs-&gt;mWeak.load(<span class="built_in">std</span>::memory_order_relaxed) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">delete</span> mRefs;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// for debugging purposes, clear this.</span></span><br><span class="line">    <span class="keyword">const_cast</span>&lt;weakref_impl*&amp;&gt;(mRefs) = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果该对象从没有过强引用，释放mRefs，如果当前对象生命周期是受弱引用控制的，那么只有在弱引用计数为0的时候，才会去销毁mRefs。</p><p>然后析构函数中做了一件很重要的事情，释放mRefs计数对象（我们在构造函数的时候new的，所以需要确保释放）。</p><p>回到decStrong中，最后调用了refs-&gt;decWeak(id),将弱引用-1。</p><p>mWeak.fetch_sub将弱引用减1，如果c != 1，说明还有弱引用，不用再进一步处理。如果等于1，就说明已经没有弱引用了，也说明了没有强引用了（一个对象的弱引用计数一定大于等于它的强引用计数），然后就需要判断是否需要释放该对象了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RefBase::weakref_type::decWeak(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span><br><span class="line">&#123;</span><br><span class="line">    weakref_impl* <span class="keyword">const</span> impl = <span class="keyword">static_cast</span>&lt;weakref_impl*&gt;(<span class="keyword">this</span>);</span><br><span class="line">    impl-&gt;removeWeakRef(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int32_t</span> c = impl-&gt;mWeak.fetch_sub(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_release);</span><br><span class="line">    ALOG_ASSERT(c &gt;= <span class="number">1</span>, <span class="string">"decWeak called on %p too many times"</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    atomic_thread_fence(<span class="built_in">std</span>::memory_order_acquire);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int32_t</span> flags = impl-&gt;mFlags.load(<span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    <span class="comment">// 1、生命周期受强引用计数控制</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">        <span class="comment">// This is the regular lifetime case. The object is destroyed</span></span><br><span class="line">        <span class="comment">// when the last strong reference goes away. Since weakref_impl</span></span><br><span class="line">        <span class="comment">// outlive the object, it is not destroyed in the dtor, and</span></span><br><span class="line">        <span class="comment">// we'll have to do it here.</span></span><br><span class="line">        <span class="comment">//2、没有被强引用引用过</span></span><br><span class="line">        <span class="keyword">if</span> (impl-&gt;mStrong.load(<span class="built_in">std</span>::memory_order_relaxed)</span><br><span class="line">                == INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">            <span class="comment">// Special case: we never had a strong reference, so we need to</span></span><br><span class="line">            <span class="comment">// destroy the object now.</span></span><br><span class="line">            <span class="comment">// 释放对象</span></span><br><span class="line">            <span class="keyword">delete</span> impl-&gt;mBase;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ALOGV("Freeing refs %p of old RefBase %p\n", this, impl-&gt;mBase);</span></span><br><span class="line">            <span class="comment">// 只释放内部的引用计数器对象</span></span><br><span class="line">            <span class="keyword">delete</span> impl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is the OBJECT_LIFETIME_WEAK case. The last weak-reference</span></span><br><span class="line">        <span class="comment">// is gone, we can destroy the object.</span></span><br><span class="line">        <span class="comment">// 如果对象生命周期受到弱引用控制，那么当弱引用为0时，delete impl-&gt;mBase</span></span><br><span class="line">        impl-&gt;mBase-&gt;onLastWeakRef(id);</span><br><span class="line">        <span class="keyword">delete</span> impl-&gt;mBase;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="弱指针"><a href="#弱指针" class="headerlink" title="弱指针"></a>弱指针</h2><p>弱指针使用的引用计数类同样是RefBase类，实现类是wp<t></t></p><p><code>system/core/include/utils/RefBase.h</code></p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> RefBase::weakref_type weakref_type;</span><br><span class="line">    </span><br><span class="line">    inline wp() : m_ptr(0) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    wp(T* other);</span><br><span class="line">    wp(<span class="keyword">const</span> wp&lt;T&gt;&amp; other);</span><br><span class="line">    wp(<span class="keyword">const</span> sp&lt;T&gt;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp(U* other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp(<span class="keyword">const</span> sp&lt;U&gt;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp(<span class="keyword">const</span> wp&lt;U&gt;&amp; other);</span><br><span class="line"></span><br><span class="line">    ~wp();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Assignment</span></span><br><span class="line"></span><br><span class="line">    wp&amp; <span class="keyword">operator</span> = (T* other);</span><br><span class="line">    wp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> wp&lt;T&gt;&amp; other);</span><br><span class="line">    wp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> sp&lt;T&gt;&amp; other);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp&amp; <span class="keyword">operator</span> = (U* other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> wp&lt;U&gt;&amp; other);</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; wp&amp; <span class="keyword">operator</span> = (<span class="keyword">const</span> sp&lt;U&gt;&amp; other);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_object_and_refs</span><span class="params">(T* other, weakref_type* refs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// promotion to sp</span></span><br><span class="line">    </span><br><span class="line">    sp&lt;T&gt; promote() <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accessors</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  weakref_type* <span class="title">get_refs</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_refs; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">inline</span>  T* <span class="title">unsafe_get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_ptr; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Operators</span></span><br><span class="line"></span><br><span class="line">    COMPARE_WEAK(==)</span><br><span class="line">    COMPARE_WEAK(!=)</span><br><span class="line">    COMPARE_WEAK(&gt;)</span><br><span class="line">    COMPARE_WEAK(&lt;)</span><br><span class="line">    COMPARE_WEAK(&lt;=)</span><br><span class="line">    COMPARE_WEAK(&gt;=)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (m_ptr == o.m_ptr) &amp;&amp; (m_refs == o.m_refs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> == (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> m_ptr == o.m_ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (m_ptr == o.m_ptr) ? (m_refs &gt; o.m_refs) : (m_ptr &gt; o.m_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &gt; (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (m_ptr == o.m_ptr) ? (m_refs &gt; o.m_refs) : (m_ptr &gt; o.m_ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (m_ptr == o.m_ptr) ? (m_refs &lt; o.m_refs) : (m_ptr &lt; o.m_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (m_ptr == o.m_ptr) ? (m_refs &lt; o.m_refs) : (m_ptr &lt; o.m_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">                         <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> != (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> m_refs != o.m_refs; &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> != (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !<span class="keyword">operator</span> == (o); &#125;</span><br><span class="line">                         <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !<span class="keyword">operator</span> &gt; (o); &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt;= (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !<span class="keyword">operator</span> &gt; (o); &#125;</span><br><span class="line">                         <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (<span class="keyword">const</span> wp&lt;T&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !<span class="keyword">operator</span> &lt; (o); &#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> U&gt; <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &gt;= (<span class="keyword">const</span> wp&lt;U&gt;&amp; o) <span class="keyword">const</span> &#123; <span class="keyword">return</span> !<span class="keyword">operator</span> &lt; (o); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt; <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">sp</span>;</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> Y&gt; <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">wp</span>;</span></span><br><span class="line"></span><br><span class="line">    T*              m_ptr;</span><br><span class="line">    weakref_type*   m_refs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>wp<t>类的定义和sp<t>其实是比较接近的，最大的区别在于wp<t> 不仅保存了 T的指针 m_ptr，而且保存了T中引用计数的指针m_refs。</t></t></t></p><p>弱指针和强指针有一个很大的区别，弱指针不可以直接操作它所引用的对象，因为它所引用的对象可能是不受弱引用计数器控制的，即它所引用的对象有可能是一个无效的对象。实现方式就在于弱指针类没有重载*和-&gt;操作符号，而强指针重载了这两个操作符号。如果需要操作一个弱指针所引用的对象，就需要将弱指针升级为强指针。</p><p>在wp的构造函数中，会调用createWeak方法，createWeak调用incWeak增加弱引用计数，返回mRefs对象指针，构造函数中将mRefs存入m_refs中。</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">wp&lt;T&gt;::wp(T* other)</span><br><span class="line">    : m_ptr(other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (other) m_refs = other-&gt;createWeak(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//system/core/libutils/RefBase.cpp</span></span><br><span class="line">RefBase::weakref_type* RefBase::createWeak(<span class="keyword">const</span> <span class="keyword">void</span>* id) <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    mRefs-&gt;incWeak(id);</span><br><span class="line">    <span class="keyword">return</span> mRefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>wp的析构函数则调用decWeak减少引用计数，具体上面已经讲过。</p><p>接下来就是弱指针的重点，如何将弱指针升级为强指针。该过程通过调用成员函数promote实现。</p><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">sp&lt;T&gt; wp&lt;T&gt;::promote() <span class="keyword">const</span></span><br><span class="line">&#123;</span><br><span class="line">    sp&lt;T&gt; result;</span><br><span class="line">    <span class="keyword">if</span> (m_ptr &amp;&amp; m_refs-&gt;attemptIncStrong(&amp;result)) &#123;</span><br><span class="line">        result.set_pointer(m_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看下attemptIncStrong方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> RefBase::weakref_type::attemptIncStrong(<span class="keyword">const</span> <span class="keyword">void</span>* id)</span><br><span class="line">&#123;</span><br><span class="line">    incWeak(id); <span class="comment">//增加弱引用计数一次</span></span><br><span class="line">    </span><br><span class="line">    weakref_impl* <span class="keyword">const</span> impl = <span class="keyword">static_cast</span>&lt;weakref_impl*&gt;(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">int32_t</span> curCount = impl-&gt;mStrong.load(<span class="built_in">std</span>::memory_order_relaxed); <span class="comment">//获取当前强引用计数器的值</span></span><br><span class="line"></span><br><span class="line">    ALOG_ASSERT(curCount &gt;= <span class="number">0</span>,</span><br><span class="line">            <span class="string">"attemptIncStrong called on %p after underflow"</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果当前已经有其他强引用，那么对象一定存在，所以就试着将强引用引用计数+1</span></span><br><span class="line">    <span class="keyword">while</span> (curCount &gt; <span class="number">0</span> &amp;&amp; curCount != INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">        <span class="comment">// we're in the easy/common case of promoting a weak-reference</span></span><br><span class="line">        <span class="comment">// from an existing strong reference.</span></span><br><span class="line">        <span class="keyword">if</span> (impl-&gt;mStrong.compare_exchange_weak(curCount, curCount+<span class="number">1</span>,</span><br><span class="line">                <span class="built_in">std</span>::memory_order_relaxed)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// the strong count has changed on us, we need to re-assert our</span></span><br><span class="line">        <span class="comment">// situation. curCount was updated by compare_exchange_weak.</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果当前没有强引用的</span></span><br><span class="line">    <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span> || curCount == INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">        <span class="comment">// we're now in the harder case of either:</span></span><br><span class="line">        <span class="comment">// - there never was a strong reference on us</span></span><br><span class="line">        <span class="comment">// - or, all strong references have been released</span></span><br><span class="line">        <span class="keyword">int32_t</span> flags = impl-&gt;mFlags.load(<span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">        <span class="comment">//对象生命周期受强引用控制</span></span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) &#123;</span><br><span class="line">            <span class="comment">// this object has a "normal" life-time, i.e.: it gets destroyed</span></span><br><span class="line">            <span class="comment">// when the last strong reference goes away</span></span><br><span class="line">            <span class="comment">//有过强引用</span></span><br><span class="line">            <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// the last strong-reference got released, the object cannot</span></span><br><span class="line">                <span class="comment">// be revived.</span></span><br><span class="line">                <span class="comment">//弱引用-1作回退</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// here, curCount == INITIAL_STRONG_VALUE, which means</span></span><br><span class="line">            <span class="comment">// there never was a strong-reference, so we can try to</span></span><br><span class="line">            <span class="comment">// promote this object; we need to do that atomically.</span></span><br><span class="line">            <span class="comment">// 强引用计数等于初始值，表示对象还没有强引用，自然也没有被销毁，可以转换，所以强引用+1，这里+1之后的值并不是1，而是     1&lt;&lt;28，所以在最后fetch_sub减掉了INITIAL_STRONG_VALUE</span></span><br><span class="line">            <span class="keyword">while</span> (curCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (impl-&gt;mStrong.compare_exchange_weak(curCount, curCount+<span class="number">1</span>,</span><br><span class="line">                        <span class="built_in">std</span>::memory_order_relaxed)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// the strong count has changed on us, we need to re-assert our</span></span><br><span class="line">                <span class="comment">// situation (e.g.: another thread has inc/decStrong'ed us)</span></span><br><span class="line">                <span class="comment">// curCount has been updated.</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (curCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// promote() failed, some other thread destroyed us in the</span></span><br><span class="line">                <span class="comment">// meantime (i.e.: strong count reached zero).</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// this object has an "extended" life-time, i.e.: it can be</span></span><br><span class="line">            <span class="comment">// revived from a weak-reference only.</span></span><br><span class="line">            <span class="comment">// Ask the object's implementation if it agrees to be revived</span></span><br><span class="line">            <span class="comment">// 询问是否允许升级到强指针，默认返回true表示允许，但是部分对象可能不允许做弱引用升级（重写该方法，返回false即可），如果不允许，那么久弱引用-1（回退第一步操作），直接然后返回false。如果允许弱引用升级，那么就强引用+1。</span></span><br><span class="line">            <span class="keyword">if</span> (!impl-&gt;mBase-&gt;onIncStrongAttempted(FIRST_INC_STRONG, id)) &#123;</span><br><span class="line">                <span class="comment">// it didn't so give-up.</span></span><br><span class="line">                decWeak(id);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// grab a strong-reference, which is always safe due to the</span></span><br><span class="line">            <span class="comment">// extended life-time.</span></span><br><span class="line">            curCount = impl-&gt;mStrong.fetch_add(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">            <span class="comment">// If the strong reference count has already been incremented by</span></span><br><span class="line">            <span class="comment">// someone else, the implementor of onIncStrongAttempted() is holding</span></span><br><span class="line">            <span class="comment">// an unneeded reference.  So call onLastStrongRef() here to remove it.</span></span><br><span class="line">            <span class="comment">// (No, this is not pretty.)  Note that we MUST NOT do this if we</span></span><br><span class="line">            <span class="comment">// are in fact acquiring the first reference.</span></span><br><span class="line">            <span class="keyword">if</span> (curCount != <span class="number">0</span> &amp;&amp; curCount != INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">                impl-&gt;mBase-&gt;onLastStrongRef(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 空实现</span></span><br><span class="line">    impl-&gt;addStrongRef(id);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PRINT_REFS</span></span><br><span class="line">    ALOGD(<span class="string">"attemptIncStrong of %p from %p: cnt=%d\n"</span>, <span class="keyword">this</span>, id, curCount);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// curCount is the value of mStrong before we incremented it.</span></span><br><span class="line">    <span class="comment">// Now we need to fix-up the count if it was INITIAL_STRONG_VALUE.</span></span><br><span class="line">    <span class="comment">// This must be done safely, i.e.: handle the case where several threads</span></span><br><span class="line">    <span class="comment">// were here in attemptIncStrong().</span></span><br><span class="line">    <span class="comment">// curCount &gt; INITIAL_STRONG_VALUE is OK, and can happen if we're doing</span></span><br><span class="line">    <span class="comment">// this in the middle of another incStrong.  The subtraction is handled</span></span><br><span class="line">    <span class="comment">// by the thread that started with INITIAL_STRONG_VALUE.</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 如果之前没有过强引用，这里需要在强引用计数上减去1&lt;&lt;28。</span></span><br><span class="line">    <span class="keyword">if</span> (curCount == INITIAL_STRONG_VALUE) &#123;</span><br><span class="line">        impl-&gt;mStrong.fetch_sub(INITIAL_STRONG_VALUE,</span><br><span class="line">                <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在开发中通常会使用引用计数来维护对象的生命周期。&lt;/p&gt;
&lt;p&gt;每当有一个指针指向了一个new出来的对象时，就对这个对象的引用计数增加1，每当有一个指针不再使用这个对象时，就对这个对象的引用计数减少1，每次减1之后，如果发现引用计数值为0时，那么，就要delete这个对象了
      
    
    </summary>
    
      <category term="Android系统" scheme="http://yoursite.com/categories/Android%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="Android" scheme="http://yoursite.com/tags/Android/"/>
    
      <category term="系统" scheme="http://yoursite.com/tags/%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>C++ 引用</title>
    <link href="http://yoursite.com/2020/11/30/C-%E5%BC%95%E7%94%A8/"/>
    <id>http://yoursite.com/2020/11/30/C-引用/</id>
    <published>2020-11-30T02:31:48.000Z</published>
    <updated>2020-11-30T02:55:50.095Z</updated>
    
    <content type="html"><![CDATA[<h1 id="C-引用"><a href="#C-引用" class="headerlink" title="C++ 引用"></a>C++ 引用</h1><p>引用变量是一个别名，也就是说，它是某个已存在变量的另一个名字。一旦把引用初始化为某个变量，就可以使用该引用名称或变量名称来指向变量。</p><h3 id="C-引用-vs-指针"><a href="#C-引用-vs-指针" class="headerlink" title="C++ 引用 vs 指针"></a>C++ 引用 vs 指针</h3><p>引用很容易与指针混淆，它们之间有三个主要的不同：</p><ul><li>不存在空引用。引用必须连接到一块合法的内存。</li><li>一旦引用被初始化为一个对象，就不能被指向到另一个对象。指针可以在任何时候指向到另一个对象。</li><li>引用必须在创建时被初始化。指针可以在任何时间被初始化。</li></ul><h3 id="创建引用"><a href="#创建引用" class="headerlink" title="创建引用"></a>创建引用</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">double</span> b;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明引用变量</span></span><br><span class="line">    <span class="keyword">int</span> &amp;c = a;</span><br><span class="line">    <span class="keyword">double</span> &amp;d = b;</span><br><span class="line"></span><br><span class="line">    a = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"c = "</span> &lt;&lt; c &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    b = <span class="number">30.0</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"d = "</span> &lt;&lt; d &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">c = <span class="number">20</span></span><br><span class="line">d = <span class="number">30</span></span><br></pre></td></tr></table></figure><p>在这些声明中，&amp; 读作<strong>引用</strong>。因此，第一个声明可以读作 “c 是一个初始化为 a 的整型引用”，第二个声明可以读作 “d 是一个初始化为 b 的 double 型引用”。</p><h3 id="把引用作为参数（引用传递）"><a href="#把引用作为参数（引用传递）" class="headerlink" title="把引用作为参数（引用传递）"></a>把引用作为参数（引用传递）</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> &amp;x, <span class="keyword">int</span> &amp;y)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 局部变量声明</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换前，a 的值："</span> &lt;&lt; a &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换前，b 的值："</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用函数来交换值 */</span></span><br><span class="line">    swap(a, b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换后，a 的值："</span> &lt;&lt; a &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换后，b 的值："</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> &amp;x, <span class="keyword">int</span> &amp;y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    temp = x; <span class="comment">/* 保存地址 x 的值 */</span></span><br><span class="line">    x = y;    <span class="comment">/* 把 y 赋值给 x */</span></span><br><span class="line">    y = temp; <span class="comment">/* 把 x 赋值给 y  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">交换前，a 的值：<span class="number">100</span>交换前，b 的值：<span class="number">200</span></span><br><span class="line">交换后，a 的值：<span class="number">200</span>交换后，b 的值：<span class="number">100</span></span><br></pre></td></tr></table></figure><p>被调函数的形参虽然也作为局部变量在栈中开辟了内存空间，但在栈中放的是由主调函数放进来的实参变量的地址。被调函数对形参的任何操作都被间接寻址，即通过栈中的存放的地址访问主调函数中的中的实参变量（相当于一个人有两个名字），因此形参在任意改动都直接影响到实参。</p><h4 id="值传递"><a href="#值传递" class="headerlink" title="值传递"></a>值传递</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 局部变量声明</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换前，a 的值："</span> &lt;&lt; a &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换前，b 的值："</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 调用函数来交换值 */</span></span><br><span class="line">    swap(a, b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换后，a 的值："</span> &lt;&lt; a &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"交换后，b 的值："</span> &lt;&lt; b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数定义</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    temp = x; <span class="comment">/* 保存地址 x 的值 */</span></span><br><span class="line">    x = y;    <span class="comment">/* 把 y 赋值给 x */</span></span><br><span class="line">    y = temp; <span class="comment">/* 把 x 赋值给 y  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">交换前，a 的值：<span class="number">100</span>交换前，b 的值：<span class="number">200</span></span><br><span class="line">交换后，a 的值：<span class="number">100</span>交换后，b 的值：<span class="number">200</span></span><br></pre></td></tr></table></figure><p>形参时实参的拷贝，改变函数形参并不影响函数外部的实参，这是最常用的一种传递方式，也是最简单的一种传递方式。只需要传递参数，返回值是return考虑的；使用值传递这种方式，调用函数不对实参进行操作，也就是说，即使形参的值发生改变，实参的值也完全不受影响。</p><h3 id="把引用作为返回值"><a href="#把引用作为返回值" class="headerlink" title="把引用作为返回值"></a>把引用作为返回值</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> vals[] = &#123;<span class="number">10.1</span>, <span class="number">12.6</span>, <span class="number">33.1</span>, <span class="number">24.1</span>, <span class="number">50.0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> &amp;<span class="title">setValues</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vals[i];   <span class="comment">// 返回第 i 个元素的引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要调用上面定义函数的主函数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"改变前的值"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"vals["</span> &lt;&lt; i &lt;&lt; <span class="string">"] = "</span>;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; vals[i] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setValues(<span class="number">1</span>) = <span class="number">20.23</span>; <span class="comment">// 改变第 2 个元素</span></span><br><span class="line">    setValues(<span class="number">3</span>) = <span class="number">70.8</span>;  <span class="comment">// 改变第 4 个元素</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"改变后的值"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"vals["</span> &lt;&lt; i &lt;&lt; <span class="string">"] = "</span>;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; vals[i] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//运行结果</span></span><br><span class="line">改变前的值</span><br><span class="line">vals[<span class="number">0</span>] = <span class="number">10.1</span></span><br><span class="line">vals[<span class="number">1</span>] = <span class="number">12.6</span></span><br><span class="line">vals[<span class="number">2</span>] = <span class="number">33.1</span></span><br><span class="line">vals[<span class="number">3</span>] = <span class="number">24.1</span></span><br><span class="line">vals[<span class="number">4</span>] = <span class="number">50</span></span><br><span class="line">改变后的值</span><br><span class="line">vals[<span class="number">0</span>] = <span class="number">10.1</span></span><br><span class="line">vals[<span class="number">1</span>] = <span class="number">20.23</span></span><br><span class="line">vals[<span class="number">2</span>] = <span class="number">33.1</span></span><br><span class="line">vals[<span class="number">3</span>] = <span class="number">70.8</span></span><br><span class="line">vals[<span class="number">4</span>] = <span class="number">50</span></span><br></pre></td></tr></table></figure><p>setValues(1)和setValues(3)得到的是实际上的实参变量地址，所以setValues(1) = 20.23就是对实际的变量进行修改。</p><p>用引用作函数的返回值的最大的好处是在内存中不产生返回值的副本，会使 C++ 程序更容易阅读和维护。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;C-引用&quot;&gt;&lt;a href=&quot;#C-引用&quot; class=&quot;headerlink&quot; title=&quot;C++ 引用&quot;&gt;&lt;/a&gt;C++ 引用&lt;/h1&gt;&lt;p&gt;引用变量是一个别名，也就是说，它是某个已存在变量的另一个名字。一旦把引用初始化为某个变量，就可以使用该引用名称或变量
      
    
    </summary>
    
      <category term="C/C++" scheme="http://yoursite.com/categories/C-C/"/>
    
    
      <category term="C++" scheme="http://yoursite.com/tags/C/"/>
    
  </entry>
  
</feed>
