<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="本网站主要供个人学习记录使用，如有侵权请立即邮件联系"><meta name="keywords" content="Android, Java, Linux, 数据结构"><title>Android包管理机制(一)PMS服务启动 | Programmer Liu</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android包管理机制(一)PMS服务启动</h1><a id="logo" href="/.">Programmer Liu</a><p class="description">精彩生活，不惧挑战，做一只有理想的的程序猿</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android包管理机制(一)PMS服务启动</h1><div class="post-meta"><a href="/2021/03/17/Android包管理机制-一-PMS服务启动/#comments" class="comment-count"></a><p><span class="date">Mar 17, 2021</span><span><a href="/categories/Android系统/" class="category">Android系统</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>PackageManagerService(简称PMS)，是Android系统中核心服务之一，管理着所有跟package相关的工作，常见的比如安装、卸载应用。 </p>
<h2 id="SyetemServer处理"><a href="#SyetemServer处理" class="headerlink" title="SyetemServer处理"></a>SyetemServer处理</h2><p>SystemServer启动过程中启动服务</p>
<p><code>frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//创建消息Looper</span></span><br><span class="line">         Looper.prepareMainLooper();</span><br><span class="line">        <span class="comment">//加载了动态库libandroid_servers.so</span></span><br><span class="line">        System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line">        performPendingShutdown();</span><br><span class="line">        <span class="comment">// 创建系统的Context</span></span><br><span class="line">        createSystemContext();</span><br><span class="line">        <span class="comment">// 创建SystemServiceManager</span></span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">        mSystemServiceManager.setRuntimeRestarted(mRuntimeRestart);</span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">        SystemServerInitThreadPool.get();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        traceBeginAndSlog(<span class="string">"StartServices"</span>);</span><br><span class="line">        <span class="comment">//启动引导服务</span></span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        <span class="comment">//启动核心服务</span></span><br><span class="line">        startCoreServices();</span><br><span class="line">        <span class="comment">//启动其他服务</span></span><br><span class="line">        startOtherServices();</span><br><span class="line">        SystemServerInitThreadPool.shutdown();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        traceEnd();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看出，系统服务分为了三种类型，分别是引导服务、核心服务和其他服务，本文要了解的PMS属于引导服务。</p>
<table>
<thead>
<tr>
<th>引导服务</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Installer</td>
<td>系统安装apk时的一个服务类，启动完成Installer服务之后才能启动其他的系统服务</td>
</tr>
<tr>
<td>ActivityManagerService</td>
<td>负责四大组件的启动、切换、调度。</td>
</tr>
<tr>
<td>PowerManagerService</td>
<td>计算系统中和Power相关的计算，然后决策系统应该如何反应</td>
</tr>
<tr>
<td>LightsService</td>
<td>管理和显示背光LED</td>
</tr>
<tr>
<td>DisplayManagerService</td>
<td>用来管理所有显示设备</td>
</tr>
<tr>
<td>UserManagerService</td>
<td>多用户模式管理</td>
</tr>
<tr>
<td>SensorService</td>
<td>为系统提供各种感应器服务</td>
</tr>
<tr>
<td>PackageManagerService</td>
<td>用来对apk进行安装、解析、删除、卸载等等操作</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//启动installer服务</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    <span class="comment">// AMS</span></span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">            ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//POWERMS</span></span><br><span class="line">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"InitPowerManagement"</span>);</span><br><span class="line">    mActivityManagerService.initPowerManagement();</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    mSystemServiceManager.startService(LightsService.class);</span><br><span class="line">    mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only run "core" apps if we're encrypting the device.</span></span><br><span class="line">    <span class="comment">// 表示加密了设备，这时mOnlyCore的值为true，表示只运行“核心”程序，创建一个极简的启动环境。</span></span><br><span class="line">    String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line"></span><br><span class="line">    mIsAlarmBoot = SystemProperties.getBoolean(<span class="string">"ro.alarm_boot"</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mIsAlarmBoot) &#123;</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (RegionalizationEnvironment.isSupported()) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Regionalization Service"</span>);</span><br><span class="line">        RegionalizationService regionalizationService = <span class="keyword">new</span> RegionalizationService();</span><br><span class="line">        ServiceManager.addService(<span class="string">"regionalization"</span>, regionalizationService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the package manager.</span></span><br><span class="line">    <span class="comment">//启动PMS</span></span><br><span class="line">    traceBeginAndSlog(<span class="string">"StartPackageManagerService"</span>);</span><br><span class="line">    <span class="comment">//创建PMS</span></span><br><span class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    <span class="comment">// 表示PMS是否首次被启动，这个参数会在WMS创建时使用</span></span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">    mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">"config.disable_otadexopt"</span>,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartOtaDexOptService"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"starting OtaDexOptService"</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    traceBeginAndSlog(<span class="string">"StartUserManagerService"</span>);</span><br><span class="line">    mSystemServiceManager.startService(UserManagerService.LifeCycle.class);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    AttributeCache.init(mSystemContext);</span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line">    startSensorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="PMS"><a href="#PMS" class="headerlink" title="PMS"></a>PMS</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">       PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line">		  <span class="comment">//初始化PMS	</span></span><br><span class="line">       PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">               factoryTest, onlyCore);</span><br><span class="line">       m.enableSystemUserPackages();</span><br><span class="line">       <span class="comment">//将package服务注册到ServiceManager大管家</span></span><br><span class="line">       ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">       <span class="keyword">return</span> m;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>PMS的构造方法一共有700多行，在代码中，将PMS的构造流程分为了5个阶段，每个阶段会使用EventLog.writeEvent打印系统日志。</p>
<ol>
<li>BOOT_PROGRESS_PMS_START（开始阶段）</li>
<li>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START（扫描系统阶段）</li>
<li>BOOT_PROGRESS_PMS_DATA_SCAN_START（扫描Data分区阶段）</li>
<li>BOOT_PROGRESS_PMS_SCAN_END（扫描结束阶段）</li>
<li>BOOT_PROGRESS_PMS_READY（准备阶段）</li>
</ol>
<h3 id="1、开始阶段"><a href="#1、开始阶段" class="headerlink" title="1、开始阶段"></a>1、开始阶段</h3><p>BOOT_PROGRESS_PMS_START</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//打印开始日志</span></span><br><span class="line">     EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">             SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">         Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mContext = context;</span><br><span class="line"></span><br><span class="line">     mPermissionReviewRequired = context.getResources().getBoolean(</span><br><span class="line">             R.bool.config_permissionReviewRequired);</span><br><span class="line"></span><br><span class="line">     mFactoryTest = factoryTest;</span><br><span class="line">     mOnlyCore = onlyCore;</span><br><span class="line">     <span class="comment">//用于存储屏幕的相关信息</span></span><br><span class="line">     mMetrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">     <span class="comment">//创建Settings对象 (1)</span></span><br><span class="line">     mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line">     <span class="comment">// 添加system, phone, log, nfc, bluetooth, shell这六种shareUserId到mSettings；</span></span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">     mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">             ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  		......</span><br><span class="line"></span><br><span class="line">     mInstaller = installer;</span><br><span class="line">     <span class="comment">//创建Dex优化工具类</span></span><br><span class="line">     mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">             <span class="string">"*dexopt*"</span>);</span><br><span class="line">     mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line">     mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">             FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line">     getDefaultDisplayMetrics(context, mMetrics);</span><br><span class="line">     <span class="comment">//得到全局系统配置信息</span></span><br><span class="line">     SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line">  		<span class="comment">//获取全局的groupId </span></span><br><span class="line">     mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">  		<span class="comment">//获取系统权限</span></span><br><span class="line">     mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">     mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"></span><br><span class="line">     mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//安装APK时需要的锁，保护所有对installd的访问。</span></span><br><span class="line">     <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">     <span class="comment">//更新APK时需要的锁，保护内存中已经解析的包信息等内容</span></span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         <span class="comment">//创建后台线程ServiceThread</span></span><br><span class="line">         mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">                 Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">         mHandlerThread.start();</span><br><span class="line">         <span class="comment">//创建PackageHandler绑定到ServiceThread的消息队列</span></span><br><span class="line">         mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">         mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">         <span class="comment">//将PackageHandler添加到Watchdog的检测集中</span></span><br><span class="line">         Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line"></span><br><span class="line">         mDefaultPermissionPolicy = <span class="keyword">new</span> DefaultPermissionGrantPolicy(<span class="keyword">this</span>);</span><br><span class="line">				</span><br><span class="line">         <span class="comment">//在Data分区创建一些目录</span></span><br><span class="line">         File dataDir = Environment.getDataDirectory();</span><br><span class="line">         mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</span><br><span class="line">         mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);</span><br><span class="line">         mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);</span><br><span class="line">         mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</span><br><span class="line">         mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</span><br><span class="line">         mRegionalizationAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-regional"</span>);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//创建多用户管理服务</span></span><br><span class="line">         sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</span><br><span class="line"></span><br><span class="line">         mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line">					</span><br><span class="line">       	<span class="comment">//解析packages.xml等文件的信息，保存到Settings的对应字段中。packages.xml中记录系统中所有安装的应用信息，包括基本信息、签名和权限。如果packages.xml有安装的应用信息，readLPw方法会返回true，mFirstBoot的值为false，说明PMS不是首次被启动。</span></span><br><span class="line">         mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure>
<p>在开始阶段，创建了很多PMS中的关键对象并赋值给PMS中的成员变量</p>
<h4 id="mSettings"><a href="#mSettings" class="headerlink" title="mSettings"></a>mSettings</h4><p>用于保存所有包的动态设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Settings(Object lock) &#123;</span><br><span class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line"></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line"></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    mSystemDir.mkdirs(); <span class="comment">//创建/data/system</span></span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">           FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">           |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">           -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处mSystemDir是指目录<code>/data/system</code>，在该目录有以下5个文件：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">packages.xml</td>
<td style="text-align:left">记录所有安装app的信息</td>
</tr>
<tr>
<td style="text-align:left">packages-backup.xml</td>
<td style="text-align:left">备份文件</td>
</tr>
<tr>
<td style="text-align:left">packages-stopped.xml</td>
<td style="text-align:left">记录系统被强制停止的文件</td>
</tr>
<tr>
<td style="text-align:left">packages-stopped-backup.xml</td>
<td style="text-align:left">备份文件</td>
</tr>
<tr>
<td style="text-align:left">packages.list</td>
<td style="text-align:left">记录应用的数据信息</td>
</tr>
</tbody>
</table>
<h4 id="mInstaller"><a href="#mInstaller" class="headerlink" title="mInstaller"></a>mInstaller</h4><p>Installer继承自SystemService，和PMS、AMS一样是系统的服务(引导服务)，PMS很多的操作都是由Installer来完成的，比如APK的安装和卸载。在Installer内部，通过socket与installd通信，（貌似8.0以上改成了IInstalld和installd进行Binder通信），由位于nativie层的installd来完成具体的操作。</p>
<h4 id="systemConfig"><a href="#systemConfig" class="headerlink" title="systemConfig"></a>systemConfig</h4><p>用于得到全局系统配置信息。比如系统的权限就可以通过SystemConfig来获取。</p>
<h4 id="mPackageDexOptimizer"><a href="#mPackageDexOptimizer" class="headerlink" title="mPackageDexOptimizer"></a>mPackageDexOptimizer</h4><p>Dex优化的工具类。</p>
<h4 id="mHandler（PackageHandler类型）"><a href="#mHandler（PackageHandler类型）" class="headerlink" title="mHandler（PackageHandler类型）"></a>mHandler（PackageHandler类型）</h4><p>PackageHandler继承自Handler，PMS通过PackageHandler驱动APK的复制和安装工作。<br>PackageHandler处理的消息队列如果过于繁忙，有可能导致系统卡住， 因此将它添加到Watchdog的监测集中。<br>Watchdog主要有两个用途，一个是定时检测系统关键服务（AMS和WMS等）是否可能发生死锁，还有一个是定时检测线程的消息队列是否长时间处于工作状态（可能阻塞等待了很长时间）。如果出现上述问题，Watchdog会将日志保存起来，必要时还会杀掉自己所在的进程，也就是SystemServer进程。</p>
<h4 id="sUserManager（UserManagerService类型）"><a href="#sUserManager（UserManagerService类型）" class="headerlink" title="sUserManager（UserManagerService类型）"></a>sUserManager（UserManagerService类型）</h4><p>多用户管理服务。</p>
<h3 id="2、扫描系统阶段"><a href="#2、扫描系统阶段" class="headerlink" title="2、扫描系统阶段"></a>2、扫描系统阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印扫描系统阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">                    startTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line"><span class="comment">// scanning install directories.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">  Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">  Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; allInstructionSets = InstructionSets.getAllInstructionSets();</span><br><span class="line"><span class="keyword">final</span> String[] dexCodeInstructionSets =</span><br><span class="line">  getDexCodeInstructionSets(</span><br><span class="line">  allInstructionSets.toArray(<span class="keyword">new</span> String[allInstructionSets.size()]));</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">             * Ensure all external libraries have had dexopt run on them.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> For now, we're compiling these system "shared libraries"</span></span><br><span class="line">  <span class="comment">// (and framework jars) into all available architectures. It's possible</span></span><br><span class="line">  <span class="comment">// to compile them only when we come across an app that uses them (there's</span></span><br><span class="line">  <span class="comment">// already logic for that in scanPackageLI) but that adds some complexity.</span></span><br><span class="line">  <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">    <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">      <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">      <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">        <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line">        <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">          lib, dexCodeInstructionSet,</span><br><span class="line">          getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">          <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line">        <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">          mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">               + e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在/system中创建framework目录</span></span><br><span class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// when upgrading from pre-M, promote system app permissions from install to runtime</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">  mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line">mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save off the names of pre-existing system packages prior to scanning; we don't</span></span><br><span class="line"><span class="comment">// want to automatically grant runtime permissions for new system apps</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">  Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">  <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">    PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">      mExistingSystemPackages.add(ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect vendor overlay packages. (Do this before scanning any apps.)</span></span><br><span class="line"><span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line"><span class="comment">// overlay packages if they reside in the right directory.</span></span><br><span class="line">String overlayThemeDir = SystemProperties.get(VENDOR_OVERLAY_THEME_PROPERTY);</span><br><span class="line"> <span class="comment">//扫描/vendor/overlay目录下的文件</span></span><br><span class="line"><span class="keyword">if</span> (!overlayThemeDir.isEmpty()) &#123;</span><br><span class="line">  scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR, overlayThemeDir), mDefParseFlags</span><br><span class="line">                  | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                  | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                  | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR), mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">//收集包名：/system/framework</span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">                scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collected privileged system packages.</span></span><br><span class="line"><span class="comment">//收集私有的系统包名：/system/priv-app</span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect ordinary system packages.</span></span><br><span class="line"><span class="comment">//收集一般的系统包名：/system/app</span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all vendor packages.</span></span><br><span class="line"><span class="comment">//收集所有的供应商包名：/vendor/app</span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">  <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all OEM packages.</span></span><br><span class="line"><span class="comment">//收集所有OEM包名：/oem/app</span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect all Regionalization packages form Carrier's res packages.</span></span><br><span class="line"><span class="keyword">if</span> (RegionalizationEnvironment.isSupported()) &#123;</span><br><span class="line">  Log.d(TAG, <span class="string">"Load Regionalization vendor apks"</span>);</span><br><span class="line">  <span class="keyword">final</span> List&lt;File&gt; RegionalizationDirs =</span><br><span class="line">    RegionalizationEnvironment.getAllPackageDirectories();</span><br><span class="line">  <span class="keyword">for</span> (File f : RegionalizationDirs) &#123;</span><br><span class="line">    File RegionalizationSystemDir = <span class="keyword">new</span> File(f, <span class="string">"system"</span>);</span><br><span class="line">    <span class="comment">// Collect packages in &lt;Package&gt;/system/priv-app</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"priv-app"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Collect packages in &lt;Package&gt;/system/app</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"app"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">              scanFlags, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Collect overlay in &lt;Package&gt;/system/vendor</span></span><br><span class="line">    scanDirLI(<span class="keyword">new</span> File(RegionalizationSystemDir, <span class="string">"vendor/overlay"</span>),</span><br><span class="line">              PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR,</span><br><span class="line">              scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prune any system packages that no longer exist.</span></span><br><span class="line"><span class="comment">// 这个列表代表有可能有升级包的系统App</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">  Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">  <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">    PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If this is not a system app, it can't be a</span></span><br><span class="line"><span class="comment">    * disable system app.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * If the package is scanned, it's not erased.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">    <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * If the system app is both scanned and in the</span></span><br><span class="line"><span class="comment">      * disabled packages list, then it must have been</span></span><br><span class="line"><span class="comment">      * added via OTA. Remove it from the currently</span></span><br><span class="line"><span class="comment">      * scanned package so the previously user-installed</span></span><br><span class="line"><span class="comment">      * application can be scanned.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;  <span class="comment">//1</span></span><br><span class="line">        logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">        <span class="comment">//将这个系统App的PackageSetting从PMS的mPackages中移除</span></span><br><span class="line">        removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//将升级包的路径添加到mExpectingBetter列表中</span></span><br><span class="line">        mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">      psit.remove();</span><br><span class="line">      logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                      + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">      <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">      <span class="comment">// reconciliation step</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">      <span class="comment">//这个系统App升级包信息在mDisabledSysPackages中,但是没有发现这个升级包存在</span></span><br><span class="line">      <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;<span class="comment">//2</span></span><br><span class="line">        possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//look for any incomplete package installations</span></span><br><span class="line"><span class="comment">//清理所有安装不完整的包</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">  <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">  <span class="comment">// reconciliation step</span></span><br><span class="line">  <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">  logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    mSettings.removePackageLPw(packageName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//delete tmp files</span></span><br><span class="line"><span class="comment">//删除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove any shared userIDs that have no associated packages</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br></pre></td></tr></table></figure>
<p>系统扫描阶段的主要工作有以下3点：</p>
<ol>
<li>创建/system的子目录，比如/system/framework、/system/priv-app和/system/app等等</li>
<li>扫描系统文件，比如/vendor/overlay、/system/framework、/system/app等等目录下的文件。</li>
<li>对扫描到的系统文件做后续处理。</li>
</ol>
<p>主要来说第3点，一次OTA升级对于一个系统App会有三种情况：</p>
<ul>
<li>这个系统APP无更新。</li>
<li>这个系统APP有更新。</li>
<li>新的OTA版本中，这个系统APP已经被删除。</li>
</ul>
<p>当系统App升级，PMS会将该系统App的升级包设置数据（PackageSetting）存储到Settings的mDisabledSysPackages列表中（具体见PMS的replaceSystemPackageLIF方法），mDisabledSysPackages的类型为<code>ArrayMap&lt;String, PackageSetting&gt;</code>。mDisabledSysPackages中的信息会被PMS保存到packages.xml中的<code>&lt;updated-package&gt;</code>标签下（具体见Settings的writeDisabledSysPackageLPr方法）。</p>
<p>注释1处说明这个系统App有升级包，那么就将该系统App的PackageSetting从mDisabledSysPackages列表中移除，并将系统App的升级包的路径添加到mExpectingBetter列表中，mExpectingBetter的类型为<code>ArrayMap&lt;String, File&gt;</code>等待后续处理。</p>
<p>注释2处如果这个系统App的升级包信息存储在mDisabledSysPackages列表中，但是没有发现这个升级包存在，则将它加入到possiblyDeletedUpdatedSystemApps列表中，意为“系统App的升级包可能被删除”，之所以是“可能”，是因为系统还没有扫描Data分区，只能暂放到possiblyDeletedUpdatedSystemApps列表中，等到扫描完Data分区后再做处理。</p>
<h3 id="3、扫描Data分区阶段"><a href="#3、扫描Data分区阶段" class="headerlink" title="3、扫描Data分区阶段"></a>3、扫描Data分区阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果设备没有加密，那么就开始扫描Data分区	</span></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">//打印扫描Data分区阶段日志</span></span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                        SystemClock.uptimeMillis());</span><br><span class="line">    <span class="comment">//扫描/data/app目录下的文件 </span></span><br><span class="line">    scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//扫描/data/app-private目录下的文件</span></span><br><span class="line">    scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">                    | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">                    scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//扫描/data/app-ephemeral目录下的文件</span></span><br><span class="line">    scanDirLI(mEphemeralInstallDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_EPHEMERAL,</span><br><span class="line">              scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Remove disable package settings for any updated system</span></span><br><span class="line"><span class="comment">    * apps that were removed via an OTA. If they're not a</span></span><br><span class="line"><span class="comment">    * previously-updated app, remove them completely.</span></span><br><span class="line"><span class="comment">    * Otherwise, just revoke their system-level permissions.</span></span><br><span class="line"><span class="comment">    * 处理possiblyDeletedUpdatedSystemApps列表</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">      PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">      mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">      String msg;</span><br><span class="line">      <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//1 如果这个系统App的包信息不在PMS的变量mPackages中，说明是残留的App信息，后续会删除它的数据</span></span><br><span class="line">        msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">          + <span class="string">" no longer exists; it's data will be wiped"</span>;</span><br><span class="line">        <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">        <span class="comment">// reconciliation step</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//2 如果这个系统App在mPackages中，说明是存在于Data分区，不属于系统App，那么移除其系统权限。</span></span><br><span class="line">        msg = <span class="string">"Updated system app + "</span> + deletedAppName</span><br><span class="line">          + <span class="string">" no longer present; removing system privileges for "</span></span><br><span class="line">          + deletedAppName;</span><br><span class="line"></span><br><span class="line">        deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"></span><br><span class="line">        PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">        deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">      &#125;</span><br><span class="line">      logCriticalInfo(Log.WARN, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Make sure all system apps that we expected to appear on</span></span><br><span class="line"><span class="comment">    * the userdata partition actually showed up. If they never</span></span><br><span class="line"><span class="comment">    * appeared, crawl back and revive the system version.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">     <span class="comment">//遍历mExpectingBetter列表</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">      <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">        <span class="comment">//得到系统App的升级包路径</span></span><br><span class="line">        <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">        logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                        + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line"> </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//3 根据系统App所在的目录设置扫描的解析参数</span></span><br><span class="line">        <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">        <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">            | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">          reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 将packageName对应的包设置数据（PackageSetting）添加到mSettings的mPackages中</span></span><br><span class="line">        mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//5 扫描系统App的升级包</span></span><br><span class="line">          scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">          Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                 + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">//清除mExpectingBetter列表</span></span><br><span class="line">  mExpectingBetter.clear();</span><br></pre></td></tr></table></figure>
<p>扫描Data分区阶段主要做了以下几件事：</p>
<ol>
<li>扫描/data/app和/data/app-private目录下的文件。</li>
<li>遍历possiblyDeletedUpdatedSystemApps列表，注释1处如果这个系统App的包信息不在PMS的变量mPackages中，说明是残留的App信息，后续会删除它的数据。注释2处如果这个系统App的包信息在mPackages中，说明是存在于Data分区，不属于系统App，那么移除其系统权限。</li>
<li>遍历mExpectingBetter列表，注释3处根据系统App所在的目录设置扫描的解析参数，注释4处的方法内部会将packageName对应的包设置数据（PackageSetting）添加到mSettings的mPackages中。注释5处扫描系统App的升级包，最后清除mExpectingBetter列表。</li>
</ol>
<h3 id="4、扫描结束阶段"><a href="#4、扫描结束阶段" class="headerlink" title="4、扫描结束阶段"></a>4、扫描结束阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印扫描结束阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the platform SDK has changed since the last time we booted,</span></span><br><span class="line">            <span class="comment">// we need to re-grant app permission to catch any new ones that</span></span><br><span class="line">            <span class="comment">// appear.  This is really a hack, and means that apps can in some</span></span><br><span class="line">            <span class="comment">// cases get permissions that the user didn't initially explicitly</span></span><br><span class="line">            <span class="comment">// allow...  it would be nice to have some better way to handle</span></span><br><span class="line">            <span class="comment">// this situation.</span></span><br><span class="line">            <span class="comment">//当sdk版本不一致时，需要更新权限</span></span><br><span class="line">            <span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line">            <span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">                        + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">                updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">            &#125;</span><br><span class="line">            updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">            ver.sdkVersion = mSdkVersion;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is the first boot or an update from pre-M, and it is a normal</span></span><br><span class="line">            <span class="comment">// boot, then we need to initialize the default preferred apps across</span></span><br><span class="line">            <span class="comment">// all defined users.</span></span><br><span class="line">   					<span class="comment">//如果是第一次启动或者是Android M升级后的第一次启动，需要初始化所有用户定义的默认首选App</span></span><br><span class="line">            <span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                    mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">                    applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">                    primeDomainVerificationsLPw(user.id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//在引导过程中尽早为系统用户准备存储，</span></span><br><span class="line">            <span class="comment">//因为核心系统应用程序，如设置Provider和SystemUI无法等待用户启动</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line">            <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">            &#125;</span><br><span class="line">            reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">                    storageFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is first boot after an OTA, and a normal boot, then</span></span><br><span class="line">            <span class="comment">// we need to clear code cache directories.</span></span><br><span class="line">            <span class="comment">// Note that we do *not* clear the application profiles. These remain valid</span></span><br><span class="line">            <span class="comment">// across OTAs and are used to drive profile verification (post OTA) and</span></span><br><span class="line">            <span class="comment">// profile compilation (without waiting to collect a fresh set of profiles).</span></span><br><span class="line"> 						<span class="comment">// OTA后的第一次启动，会清除代码缓存目录</span></span><br><span class="line">            <span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">                        <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">                        clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                                        | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkDefaultBrowser();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//当权限和其他默认项都完成更新，则清理相关信息</span></span><br><span class="line">            mExistingSystemPackages.clear();</span><br><span class="line">            mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">            ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 把Settings的内容保存到packages.xml中</span></span><br><span class="line">            mSettings.writeLPr();</span><br></pre></td></tr></table></figure>
<p>扫描结束结束阶段主要做了以下几件事：</p>
<ol>
<li>如果当前平台SDK版本和上次启动时的SDK版本不同，重新更新APK的授权。</li>
<li>如果是第一次启动或者是Android M升级后的第一次启动，需要初始化所有用户定义的默认首选App。</li>
<li>OTA升级后的第一次启动，会清除代码缓存目录。</li>
<li>把Settings的内容保存到packages.xml中，这样此后PMS再次创建时会读到此前保存的Settings的内容。</li>
</ol>
<h3 id="5、准备阶段"><a href="#5、准备阶段" class="headerlink" title="5、准备阶段"></a>5、准备阶段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印准备阶段日志</span></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">  	mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">  	mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">    mRequiredUninstallerPackage = getRequiredUninstallerLPr();</span><br><span class="line">    mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">    mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                                                    mIntentFilterVerifierComponent);</span><br><span class="line">    mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">      PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">    mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">      PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mOnlyPowerOffAlarm) &#123;</span><br><span class="line">      mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mRequiredUninstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">    mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">    mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">    mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">    mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建PackageInstallerService，用于管理安装会话的服务，它会为每次安装过程分配一个SessionId</span></span><br><span class="line">mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行一次垃圾收集</span></span><br><span class="line">untime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line"><span class="comment">// The initial scanning above does many calls into installd while</span></span><br><span class="line"><span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></span><br><span class="line"><span class="comment">// once we have a booted system.</span></span><br><span class="line">mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将PackageManagerInternalImpl（PackageManager的本地服务）添加到LocalServices中，LocalServices用于存储运行在当前的进程中的本地服务</span></span><br><span class="line">LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>PMS属于引导服务，由SyetemServer启动</p>
<p>PMS启动又分为5个阶段</p>
<ol>
<li>BOOT_PROGRESS_PMS_START（开始阶段）</li>
<li>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START（扫描系统阶段）</li>
<li>BOOT_PROGRESS_PMS_DATA_SCAN_START（扫描Data分区阶段）</li>
<li>BOOT_PROGRESS_PMS_SCAN_END（扫描结束阶段）</li>
<li>BOOT_PROGRESS_PMS_READY（准备阶段）</li>
</ol>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/系统/">系统</a><a href="/tags/PMS/">PMS</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2021/03/17/Android包管理机制-二-PackageInstaller安装APK/" class="pre">Android包管理机制(二)PackageInstaller安装APK</a><a href="/2021/03/11/设计模式-代理模式/" class="next">设计模式-代理模式</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODA5Ny8xNDYyNw=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SyetemServer处理"><span class="toc-text">SyetemServer处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PMS"><span class="toc-text">PMS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构造方法"><span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1、开始阶段"><span class="toc-text">1、开始阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mSettings"><span class="toc-text">mSettings</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mInstaller"><span class="toc-text">mInstaller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#systemConfig"><span class="toc-text">systemConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mPackageDexOptimizer"><span class="toc-text">mPackageDexOptimizer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mHandler（PackageHandler类型）"><span class="toc-text">mHandler（PackageHandler类型）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sUserManager（UserManagerService类型）"><span class="toc-text">sUserManager（UserManagerService类型）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、扫描系统阶段"><span class="toc-text">2、扫描系统阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、扫描Data分区阶段"><span class="toc-text">3、扫描Data分区阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、扫描结束阶段"><span class="toc-text">4、扫描结束阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、准备阶段"><span class="toc-text">5、准备阶段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/04/21/Android系统-理解ActivityThread和App启动流程/">Android系统-理解ActivityThread和App启动流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/15/Android系统开发-选择并启动默认Launcher/">Android系统开发-选择并启动默认Launcher</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/">Android系统-深入理解ActivityManagerService(二)startActiviy流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/27/Android系统-深入理解ActivityManagerService-一-AMS的启动流程/">Android系统-深入理解ActivityManagerService(一)AMS的启动流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/25/Android系统开发-APK安装包名和签名双重认证/">Android系统开发-APK安装包名或签名信息认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/24/Android包管理机制-三-PMS处理APK安装/">Android包管理机制(三)PMS处理APK安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/19/Android-JNI开发-实际项目开发总结/">Android JNI开发-实际项目开发总结(回调函数)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/17/Android系统-生成OTA增量升级包/">Android系统-生成OTA增量升级包</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/17/Android包管理机制-二-PackageInstaller安装APK/">Android包管理机制(二)PackageInstaller安装APK</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/17/Android包管理机制-一-PMS服务启动/">Android包管理机制(一)PMS服务启动</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android系统/">Android系统</a><span class="category-list-count">30</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android音视频/">Android音视频</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/FFmpeg/">FFmpeg</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux系统/">Linux系统</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL-ES-3-0/">OpenGL ES 3.0</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDL2/">SDL2</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/">微信小程序</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/音视频/" style="font-size: 15px;">音视频</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/Service/" style="font-size: 15px;">Service</a> <a href="/tags/Launcher3/" style="font-size: 15px;">Launcher3</a> <a href="/tags/PMS/" style="font-size: 15px;">PMS</a> <a href="/tags/BroadCast/" style="font-size: 15px;">BroadCast</a> <a href="/tags/原理/" style="font-size: 15px;">原理</a> <a href="/tags/Context/" style="font-size: 15px;">Context</a> <a href="/tags/ClassLoader/" style="font-size: 15px;">ClassLoader</a> <a href="/tags/CameraX/" style="font-size: 15px;">CameraX</a> <a href="/tags/AMS/" style="font-size: 15px;">AMS</a> <a href="/tags/ActivityThread/" style="font-size: 15px;">ActivityThread</a> <a href="/tags/OTA增量/" style="font-size: 15px;">OTA增量</a> <a href="/tags/Launcher/" style="font-size: 15px;">Launcher</a> <a href="/tags/Camera2/" style="font-size: 15px;">Camera2</a> <a href="/tags/音频/" style="font-size: 15px;">音频</a> <a href="/tags/OpenGL-ES/" style="font-size: 15px;">OpenGL ES</a> <a href="/tags/Camera/" style="font-size: 15px;">Camera</a> <a href="/tags/MediaCodec/" style="font-size: 15px;">MediaCodec</a> <a href="/tags/binder/" style="font-size: 15px;">binder</a> <a href="/tags/FFmpeg/" style="font-size: 15px;">FFmpeg</a> <a href="/tags/直播/" style="font-size: 15px;">直播</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/SDL2/" style="font-size: 15px;">SDL2</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/系统调用/" style="font-size: 15px;">系统调用</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/中断/" style="font-size: 15px;">中断</a> <a href="/tags/LRU/" style="font-size: 15px;">LRU</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Reactor/" style="font-size: 15px;">Reactor</a> <a href="/tags/高性能/" style="font-size: 15px;">高性能</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/交叉编译/" style="font-size: 15px;">交叉编译</a> <a href="/tags/Makefile/" style="font-size: 15px;">Makefile</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/编译时注解/" style="font-size: 15px;">编译时注解</a> <a href="/tags/KAPT/" style="font-size: 15px;">KAPT</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/UML/" style="font-size: 15px;">UML</a> <a href="/tags/状态机/" style="font-size: 15px;">状态机</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a><ul></ul><a href="https://richardwrq.github.io/" title="Richard Wu" target="_blank">Richard Wu</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">刘伟.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>