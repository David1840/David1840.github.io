<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="本网站主要供个人学习记录使用，如有侵权请立即邮件联系"><meta name="keywords" content="Android, Java, Linux, 数据结构"><title>Android系统-深入理解ActivityManagerService(二)startActiviy流程分析 | Programmer Liu</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android系统-深入理解ActivityManagerService(二)startActiviy流程分析</h1><a id="logo" href="/.">Programmer Liu</a><p class="description">精彩生活，不惧挑战，做一只有理想的的程序猿</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android系统-深入理解ActivityManagerService(二)startActiviy流程分析</h1><div class="post-meta"><a href="/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/#comments" class="comment-count"></a><p><span class="date">Mar 29, 2021</span><span><a href="/categories/Android系统/" class="category">Android系统</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>上一篇文章<a href="https://david1840.github.io/2021/03/27/Android%E7%B3%BB%E7%BB%9F-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3ActivityManagerService-%E4%B8%80-AMS%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" target="_blank" rel="noopener">深入理解ActivityManagerService(一)AMS的启动流程</a>中了解了AMS启动的流程，接下来就来看下我们在开发中调用startActivity(Intent)发生了什么。</p>
<p>startActivity又要分为两种情况，一个是我们在应用中去启动本应用中的一个Activity（也称为子Activity），这个时候Activity所属的进程肯定是存在的，那么就启动Activity即可；还有一种情况是我们去启动另一个App中的Activity（也称为根Activity，以快捷图标的形式显示在Launcher中），那么就要先判断这个App的进程是否存在，如果不存在，就要先去请求Zygote创建应用程序进程。</p>
<p>在Launcher中点击图标启动应用，都会调用startActivity方法</p>
<h2 id="一、App层"><a href="#一、App层" class="headerlink" title="一、App层"></a>一、App层</h2><h3 id="1-Activity-startActivityForResult"><a href="#1-Activity-startActivityForResult" class="headerlink" title="1.Activity.startActivityForResult"></a>1.Activity.startActivityForResult</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">          startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">          <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">          startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">      startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到startActivity实际还是调用了startActivityForResult函数，只是requestCode为-1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">           @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">           options = transferSpringboardActivityOptions(options);</span><br><span class="line">           <span class="comment">//</span></span><br><span class="line">           Instrumentation.ActivityResult ar =</span><br><span class="line">               <span class="comment">//执行Activity启动</span></span><br><span class="line">               mInstrumentation.execStartActivity(</span><br><span class="line">                   <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                   intent, requestCode, options);</span><br><span class="line">           <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mMainThread.sendActivityResult(</span><br><span class="line">                   mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                   ar.getResultData());</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           cancelInputsAndStartExitTransition(options);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">               mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line">               <span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">               mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-Instrumentation-startActivity"><a href="#2-Instrumentation-startActivity" class="headerlink" title="2.Instrumentation.startActivity"></a>2.Instrumentation.startActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">           Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">       IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">       Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">           intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">       &#125;</span><br><span class="line">  </span><br><span class="line">    		......</span><br><span class="line">         </span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           intent.migrateExtraStreamToClipData();</span><br><span class="line">           intent.prepareToLeaveProcess(who);</span><br><span class="line">           <span class="comment">/////////</span></span><br><span class="line">           <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">           .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                   intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                   token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                   requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">           <span class="comment">//检查activity是否启动成功</span></span><br><span class="line">           checkStartActivityResult(result, intent);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码中可以看到，关键代码就是 ActivityManagerNative.getDefault().startActivity方法。</p>
<blockquote>
<p>Android 8.0之前是通过ActivityManagerNative.getDefault()获取ActivityManagerProxy，即AMS的代理类，之后就通过AMP与AMS进行通信，8.0之后这里就不再使用ActivityManagerProxy，而是ActivityManager通过AIDL直接与AMS交互。</p>
</blockquote>
<h3 id="3-ActivityManagerNative-startActivity"><a href="#3-ActivityManagerNative-startActivity" class="headerlink" title="3.ActivityManagerNative.startActivity"></a>3.ActivityManagerNative.startActivity</h3><p><code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gDefault.get();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">            &#125;</span><br><span class="line">            IActivityManager am = asInterface(b);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> am;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>getDefault会调用一个Singleton类gDefault的get函数。首先通过ServiceManager获取名为”activity”的Service引用，也就是IBinder类型的AMS的引用。然后将其封装为AMP对象，并将它保存到gDefault中，此后调用AMN的getDefault方法就会直接获得AMS的代理对象AMP。</p>
<p><code>frameworks/base/core/java/android/app/ActivityManagerNative.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager in =</span><br><span class="line">            (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后startActivity，实际调用的就是ActivityManagerProxy的startActivity函数，与上面new ActivityManagerProxy(obj);对应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">        data.writeString(callingPackage);</span><br><span class="line">        intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeString(resolvedType);</span><br><span class="line">        data.writeStrongBinder(resultTo);</span><br><span class="line">        data.writeString(resultWho);</span><br><span class="line">        data.writeInt(requestCode);</span><br><span class="line">        data.writeInt(startFlags);</span><br><span class="line">        <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            options.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 通过AIDL调用远程函数</span></span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IBinder b = data.readStrongBinder();</span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">            String callingPackage = data.readString();</span><br><span class="line">            Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">            String resolvedType = data.readString();</span><br><span class="line">            IBinder resultTo = data.readStrongBinder();</span><br><span class="line">            String resultWho = data.readString();</span><br><span class="line">            <span class="keyword">int</span> requestCode = data.readInt();</span><br><span class="line">            <span class="keyword">int</span> startFlags = data.readInt();</span><br><span class="line">            ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">            Bundle options = data.readInt() != <span class="number">0</span></span><br><span class="line">                    ? Bundle.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 这里调用AMS的startActivity函数</span></span><br><span class="line">            <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</span><br><span class="line">                    resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            reply.writeInt(result);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>最终在ActivityManagerNative中调用AMS的startActivity函数，接下来就交给AMS来处理逻辑。</p>
<h2 id="二、System-Server层"><a href="#二、System-Server层" class="headerlink" title="二、System Server层"></a>二、System Server层</h2><h3 id="1-ActivityManagerService-startActivity"><a href="#1-ActivityManagerService-startActivity" class="headerlink" title="1. ActivityManagerService.startActivity"></a>1. ActivityManagerService.startActivity</h3><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">          Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">              resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">              UserHandle.getCallingUserId());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">          Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">      enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">      userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">              userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">      <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">              resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">              profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>AMS中调用ActivityStarter中的startActivityMayWait函数</p>
<h3 id="2-ActivityStarter-startActivityMayWait"><a href="#2-ActivityStarter-startActivityMayWait" class="headerlink" title="2. ActivityStarter.startActivityMayWait"></a>2. ActivityStarter.startActivityMayWait</h3><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> requestRealCallingPid, <span class="keyword">int</span> requestRealCallingUid, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IVoiceInteractionSession voiceSession,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, IActivityManager.WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save a copy in case ephemeral needs it</span></span><br><span class="line">    <span class="keyword">final</span> Intent ephemeralIntent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">// Don't modify the client's object!</span></span><br><span class="line">    intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">//收集Intent所指向的Activity信息, 当存在多个可供选择的Activity,则直接向用户弹出resolveActivity </span></span><br><span class="line">    ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">        <span class="comment">//////////</span></span><br><span class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                options, ignoreTargetSecurity, componentSpecified, outRecord, container,</span><br><span class="line">                inTask);</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord launchedActivity = mReusedActivity != <span class="keyword">null</span></span><br><span class="line">                ? mReusedActivity : outRecord[<span class="number">0</span>];</span><br><span class="line">        mSupervisor.mActivityMetricsLogger.notifyActivityLaunched(res, launchedActivity);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个流程中就是用ActivityStackSupervisor的resolveIntent()和resolveActivity()来找到相应的Activity组件, 然后再进入startActivityLocked()</p>
<h4 id="2-1-ActivityStackSupervisor-resolveActivity"><a href="#2-1-ActivityStackSupervisor-resolveActivity" class="headerlink" title="2.1 ActivityStackSupervisor.resolveActivity"></a>2.1 ActivityStackSupervisor.resolveActivity</h4><p><code>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, ResolveInfo rInfo, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityInfo aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Store the found target back into the intent, because now that</span></span><br><span class="line">            <span class="comment">// we have it we never want to do this again.  For example, if the</span></span><br><span class="line">            <span class="comment">// user navigates back to this point in the history, we should</span></span><br><span class="line">            <span class="comment">// always restart the exact same activity.</span></span><br><span class="line">            intent.setComponent(<span class="keyword">new</span> ComponentName(</span><br><span class="line">                    aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Don't debug things in the system process</span></span><br><span class="line">            <span class="keyword">if</span> (!aInfo.processName.equals(<span class="string">"system"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_DEBUG) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setDebugApp(aInfo.processName, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_NATIVE_DEBUGGING) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setNativeDebuggingAppLocked(aInfo.applicationInfo, aInfo.processName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_TRACK_ALLOCATION) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mService.setTrackAllocationApp(aInfo.applicationInfo, aInfo.processName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mService.setProfileApp(aInfo.applicationInfo, aInfo.processName, profilerInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> aInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resolveIntent(intent, resolvedType, userId, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AppGlobals.getPackageManager().resolveIntent(intent, resolvedType,</span><br><span class="line">                    PackageManager.MATCH_DEFAULT_ONLY | flags</span><br><span class="line">                    | ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ResolveInfo rInfo = resolveIntent(intent, resolvedType, userId);</span><br><span class="line">        <span class="keyword">return</span> resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在ActivityStackSupervisor中调用PackageManagerService去解析Intent，来查询系统中所有符合要求的Activity，当存在多个满足条件的Activity则会弹框让用户来选择。</p>
<h4 id="2-2-PMS-resolveIntent"><a href="#2-2-PMS-resolveIntent" class="headerlink" title="2.2 PMS.resolveIntent"></a>2.2 PMS.resolveIntent</h4><p><code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">          flags = updateFlagsForResolve(flags, userId, intent);</span><br><span class="line">          enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">                  <span class="keyword">false</span> <span class="comment">/*requireFullPermission*/</span>, <span class="keyword">false</span> <span class="comment">/*checkShell*/</span>, <span class="string">"resolve intent"</span>);</span><br><span class="line"></span><br><span class="line">          Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queryIntentActivities"</span>);</span><br><span class="line">          <span class="keyword">final</span> List&lt;ResolveInfo&gt; query = queryIntentActivitiesInternal(intent, resolvedType,</span><br><span class="line">                  flags, userId);</span><br><span class="line">          Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 根据priority，preferred选择最佳的Activity</span></span><br><span class="line">          <span class="keyword">final</span> ResolveInfo bestChoice =</span><br><span class="line">                  chooseBestActivity(intent, resolvedType, flags, query, userId);</span><br><span class="line">          <span class="keyword">return</span> bestChoice;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-PMS-queryIntentActivities"><a href="#2-3-PMS-queryIntentActivities" class="headerlink" title="2.3 PMS.queryIntentActivities"></a>2.3 PMS.queryIntentActivities</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentActivities</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ComponentName comp = intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getSelector() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent = intent.getSelector();</span><br><span class="line">            comp = intent.getComponent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//获取Activity信息</span></span><br><span class="line">        <span class="keyword">final</span> ActivityInfo ai = getActivityInfo(comp, flags, userId);</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">            ri.activityInfo = ai;</span><br><span class="line">            list.add(ri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-ActivityStarter-startActivityLocked"><a href="#3-ActivityStarter-startActivityLocked" class="headerlink" title="3. ActivityStarter.startActivityLocked"></a>3. ActivityStarter.startActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">            ActivityRecord[] outActivity, ActivityStackSupervisor.ActivityContainer container,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">  </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mService.mWindowManager.deferSurfaceLayout();</span><br><span class="line">            err = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">                    <span class="keyword">true</span>, options, inTask);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mService.mWindowManager.continueSurfaceLayout();</span><br><span class="line">        &#125;</span><br><span class="line">        postStartActivityUncheckedProcessing(r, err, stack.mStackId, mSourceRecord, mTargetStack);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-ActivityStarter-startActivityUnchecked"><a href="#4-ActivityStarter-startActivityUnchecked" class="headerlink" title="4. ActivityStarter.startActivityUnchecked"></a>4. ActivityStarter.startActivityUnchecked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">           IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">     ...  </span><br><span class="line">        mSupervisor.resumeFocusedStackTopActivityLocked();  </span><br><span class="line">     ... </span><br><span class="line">       <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#5-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="5. ActivityStackSupervisor.resumeFocusedStackTopActivityLocked"></a>5. ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">           <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">       <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">           mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-ActivityStack-resumeTopActivityUncheckedLocked"><a href="#6-ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="6. ActivityStack.resumeTopActivityUncheckedLocked"></a>6. ActivityStack.resumeTopActivityUncheckedLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">           mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validateTopActivitiesLocked();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="7-ActivityStackSupervisor-startSpecificActivityLocked"><a href="#7-ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="7. ActivityStackSupervisor.startSpecificActivityLocked"></a>7. ActivityStackSupervisor.startSpecificActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">              r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">      r.task.stack.setLaunchTime(r);</span><br><span class="line">      <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;<span class="comment">//1</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                      || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                  app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">                          mService.mProcessStats);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 真正去启动Activity</span></span><br><span class="line">              realStartActivityLocked(r, app, andResume, checkConfig);<span class="comment">//2</span></span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                      + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//当进程不存在则创建进程</span></span><br><span class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">              <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>累啊，看了半天终于到关键的地方了。</p>
<p>根据进程名称获取进程信息，如果进程存在，才到真正去启动Activity的地方，启动子Activity也就是在应用中启动其他Activity页面就会走这里。而进程如果不存在，就要走下面 mService.startProcessLocked去创建一个进程。还有可能是新创建的Activity被定义到一个新的进程，即定义了android:process，这样也会创建一个新的进程。</p>
<p>进程创建最终是由Zygote fork出一个进程，在Android中所有的App进程都是由Zygote进程fork生成的。这个流程也是很复杂，这里就不继续看下去了，我们先看下启动Activity的流程。</p>
<h3 id="8-ActivityStackSupervisor-realStartActivityLocked"><a href="#8-ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="8. ActivityStackSupervisor.realStartActivityLocked"></a>8. ActivityStackSupervisor.realStartActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">     				......</span><br><span class="line">            app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line"></span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>关键代码<code>app.thread.scheduleLaunchActivity</code>，这里我们认为App进程已经启动了，AMS中已经有了对应进程的ProcessRecord。</p>
<p>app.thread类型为IApplicationThread，可以远程调用到ActivityThread的scheduleLaunchActivity方法，再发送H.LAUNCH_ACTIVITY消息，最终反射生成一个Activity。具体可见<a href="https://david1840.github.io/2021/04/21/Android%E7%B3%BB%E7%BB%9F-%E7%90%86%E8%A7%A3ActivityThread%E5%92%8CApp%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" target="_blank" rel="noopener">Android系统-理解ActivityThread和App启动流程</a></p>
<h3 id="9-调用流程"><a href="#9-调用流程" class="headerlink" title="9.调用流程"></a>9.调用流程</h3><p><img src="/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/launch1.png" alt=""></p>
</div><div class="tags"><a href="/tags/系统/">系统</a><a href="/tags/AMS/">AMS</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2021/04/15/Android系统开发-选择并启动默认Launcher/" class="pre">Android系统开发-选择并启动默认Launcher</a><a href="/2021/03/27/Android系统-深入理解ActivityManagerService-一-AMS的启动流程/" class="next">Android系统-深入理解ActivityManagerService(一)AMS的启动流程</a></div><div id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zODA5Ny8xNDYyNw=="></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、App层"><span class="toc-text">一、App层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Activity-startActivityForResult"><span class="toc-text">1.Activity.startActivityForResult</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Instrumentation-startActivity"><span class="toc-text">2.Instrumentation.startActivity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ActivityManagerNative-startActivity"><span class="toc-text">3.ActivityManagerNative.startActivity</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、System-Server层"><span class="toc-text">二、System Server层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ActivityManagerService-startActivity"><span class="toc-text">1. ActivityManagerService.startActivity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ActivityStarter-startActivityMayWait"><span class="toc-text">2. ActivityStarter.startActivityMayWait</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-ActivityStackSupervisor-resolveActivity"><span class="toc-text">2.1 ActivityStackSupervisor.resolveActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-PMS-resolveIntent"><span class="toc-text">2.2 PMS.resolveIntent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-PMS-queryIntentActivities"><span class="toc-text">2.3 PMS.queryIntentActivities</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ActivityStarter-startActivityLocked"><span class="toc-text">3. ActivityStarter.startActivityLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ActivityStarter-startActivityUnchecked"><span class="toc-text">4. ActivityStarter.startActivityUnchecked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="toc-text">5. ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-ActivityStack-resumeTopActivityUncheckedLocked"><span class="toc-text">6. ActivityStack.resumeTopActivityUncheckedLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-ActivityStackSupervisor-startSpecificActivityLocked"><span class="toc-text">7. ActivityStackSupervisor.startSpecificActivityLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-ActivityStackSupervisor-realStartActivityLocked"><span class="toc-text">8. ActivityStackSupervisor.realStartActivityLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-调用流程"><span class="toc-text">9.调用流程</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/04/30/Android系统-WMS启动/">Android系统-WMS启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/27/Android系统-installd守护进程/">Android系统-installd守护进程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/21/Android系统-理解ActivityThread和App启动流程/">Android系统-理解ActivityThread和App启动流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/15/Android系统开发-选择并启动默认Launcher/">Android系统开发-选择并启动默认Launcher</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/29/Android系统-深入理解ActivityManagerService-二-startActivity流程分析/">Android系统-深入理解ActivityManagerService(二)startActiviy流程分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/27/Android系统-深入理解ActivityManagerService-一-AMS的启动流程/">Android系统-深入理解ActivityManagerService(一)AMS的启动流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/25/Android系统开发-APK安装包名和签名双重认证/">Android系统开发-APK安装包名或签名信息认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/24/Android包管理机制-三-PMS处理APK安装/">Android系统-包管理机制(三)PMS处理APK安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/19/Android-JNI开发-实际项目开发总结/">Android JNI开发-实际项目开发总结(回调函数)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/17/Android系统-生成OTA增量升级包/">Android系统-生成OTA增量升级包</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android开发/">Android开发</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android系统/">Android系统</a><span class="category-list-count">32</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android音视频/">Android音视频</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-C/">C/C++</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/FFmpeg/">FFmpeg</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux系统/">Linux系统</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL-ES-3-0/">OpenGL ES 3.0</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDL2/">SDL2</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微信小程序/">微信小程序</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构与算法/">数据结构与算法</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/JNI/" style="font-size: 15px;">JNI</a> <a href="/tags/NDK/" style="font-size: 15px;">NDK</a> <a href="/tags/Service/" style="font-size: 15px;">Service</a> <a href="/tags/Context/" style="font-size: 15px;">Context</a> <a href="/tags/Launcher3/" style="font-size: 15px;">Launcher3</a> <a href="/tags/ClassLoader/" style="font-size: 15px;">ClassLoader</a> <a href="/tags/BroadCast/" style="font-size: 15px;">BroadCast</a> <a href="/tags/原理/" style="font-size: 15px;">原理</a> <a href="/tags/PMS/" style="font-size: 15px;">PMS</a> <a href="/tags/CameraX/" style="font-size: 15px;">CameraX</a> <a href="/tags/WMS/" style="font-size: 15px;">WMS</a> <a href="/tags/installd/" style="font-size: 15px;">installd</a> <a href="/tags/守护进程/" style="font-size: 15px;">守护进程</a> <a href="/tags/AMS/" style="font-size: 15px;">AMS</a> <a href="/tags/OTA增量/" style="font-size: 15px;">OTA增量</a> <a href="/tags/ActivityThread/" style="font-size: 15px;">ActivityThread</a> <a href="/tags/Launcher/" style="font-size: 15px;">Launcher</a> <a href="/tags/Camera2/" style="font-size: 15px;">Camera2</a> <a href="/tags/MediaCodec/" style="font-size: 15px;">MediaCodec</a> <a href="/tags/音频/" style="font-size: 15px;">音频</a> <a href="/tags/OpenGL-ES/" style="font-size: 15px;">OpenGL ES</a> <a href="/tags/Camera/" style="font-size: 15px;">Camera</a> <a href="/tags/FFmpeg/" style="font-size: 15px;">FFmpeg</a> <a href="/tags/直播/" style="font-size: 15px;">直播</a> <a href="/tags/binder/" style="font-size: 15px;">binder</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/音视频/" style="font-size: 15px;">音视频</a> <a href="/tags/SDL2/" style="font-size: 15px;">SDL2</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/系统调用/" style="font-size: 15px;">系统调用</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/LRU/" style="font-size: 15px;">LRU</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/AQS/" style="font-size: 15px;">AQS</a> <a href="/tags/中断/" style="font-size: 15px;">中断</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Reactor/" style="font-size: 15px;">Reactor</a> <a href="/tags/高性能/" style="font-size: 15px;">高性能</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/交叉编译/" style="font-size: 15px;">交叉编译</a> <a href="/tags/Makefile/" style="font-size: 15px;">Makefile</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/UML/" style="font-size: 15px;">UML</a> <a href="/tags/状态机/" style="font-size: 15px;">状态机</a> <a href="/tags/编译时注解/" style="font-size: 15px;">编译时注解</a> <a href="/tags/KAPT/" style="font-size: 15px;">KAPT</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://gityuan.com/" title="Gityuan" target="_blank">Gityuan</a><ul></ul><a href="https://richardwrq.github.io/" title="Richard Wu" target="_blank">Richard Wu</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">刘伟.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>(function(d, s) {
  var j, e = d.getElementsByTagName('body')[0];
  if (typeof LivereTower === 'function') { return; }
  j = d.createElement(s);
  j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
  j.async = true;
  e.appendChild(j);
})(document, 'script');
</script></body></html>